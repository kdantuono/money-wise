#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# MoneyWise pre-commit hook
# Runs essential checks before allowing commit

echo "ğŸ” Running pre-commit checks..."

# Check if Prisma Client is generated (backend only)
if [ -d "apps/backend" ] && [ ! -d "apps/backend/generated/prisma" ]; then
  echo "  âš ï¸  Prisma Client not generated. Generating now..."
  cd apps/backend && pnpm prisma:generate && cd ../.. || {
    echo "âŒ Prisma Client generation failed."
    exit 1
  }
  echo "  âœ… Prisma Client generated"
fi

# Check GitHub Actions workflows if any are staged
echo "  ğŸ” Checking GitHub Actions workflows..."
if git diff --cached --name-only | grep -q "^\.github/workflows/"; then
  echo "    ğŸ“‹ Workflow files detected in this commit"

  # Try to validate with actionlint
  ACTIONLINT_PATH="./.claude/tools/actionlint"

  if [ -x "$ACTIONLINT_PATH" ]; then
    echo "    ğŸ“ Validating with actionlint..."
    if "$ACTIONLINT_PATH" -color .github/workflows/*.yml > /dev/null 2>&1; then
      echo "    âœ… GitHub Actions workflows are valid"
    else
      echo "    âŒ GitHub Actions workflows have errors:"
      "$ACTIONLINT_PATH" -color .github/workflows/*.yml || true
      echo ""
      echo "âŒ Please fix workflow errors before committing."
      exit 1
    fi
  else
    echo "    âš ï¸  actionlint not found, skipping detailed workflow validation"
    echo "    ğŸ’¡ Install with: pnpm setup:actionlint"
  fi
else
  echo "    â­ï¸  No workflow files in this commit"
fi

echo ""

# Run linting
echo "  âœ¨ Linting..."
pnpm lint || {
  echo "âŒ Linting failed. Please fix errors and try again."
  exit 1
}

# Run type checking
echo "  ğŸ” Type checking..."
pnpm typecheck || {
  echo "âŒ Type checking failed. Please fix errors and try again."
  exit 1
}

# Run unit tests (fast)
echo "  ğŸ§ª Running unit tests..."
pnpm test:unit || {
  echo "âŒ Unit tests failed. Please fix failing tests and try again."
  exit 1
}

echo "âœ… Pre-commit checks passed!"