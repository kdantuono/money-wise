# CI/CD Troubleshooting Guide: Local vs CI Environment Mismatches

> **Document Purpose**: This guide documents critical issues where tests pass locally but fail in CI/CD due to environment differences. It covers database schema drift, Playwright browser version mismatches, and provides comprehensive solution patterns.

---

## üìã Table of Contents

1. [Issue 1: Database Schema Drift (depth column)](#issue-1-database-schema-drift-depth-column)
2. [Issue 2: Playwright Browser Version Mismatch](#issue-2-playwright-browser-version-mismatch)
3. [General Prevention Strategies](#general-prevention-strategies)
4. [Debugging Commands](#debugging-commands)
5. [Related Files](#related-files)

---

# Issue 1: Database Schema Drift (depth column)

## üö® Problem Summary

### Symptom
Integration tests fail in CI/CD with Prisma errors like:
```
PrismaClientKnownRequestError: 
Invalid `prisma.category.create()` invocation

The column `depth` does not exist in the current database.
```

### Impact
- Integration tests pass locally but fail in CI/CD
- Test factories create data with columns that don't exist in CI database
- CI pipeline blocks merges even though code works locally

### Root Cause: Missing Migration

**The Sequence of Events:**
1. Migration `20251022000004` **ADDED** the `depth` column with a PostgreSQL trigger
2. Migration `20251128021358` (auto-generated by Prisma) **DROPPED** the `depth` column as a side effect
3. The Prisma schema was updated to re-add `depth` in commit `7b6bf75`, but **NO MIGRATION** was created
4. **Result**: Schema says `depth` exists, but migrations don't create it

**Why Local Works But CI Fails:**
| Environment | Database State |
|-------------|----------------|
| **Local** | Developers use `prisma db push` or reset their database, which syncs schema directly |
| **CI/CD** | Runs migrations in order: `depth` is DROPPED and never re-added |

---

## ‚úÖ The Fix

### Step 1: Create the Missing Migration

Create a new migration file at `apps/backend/prisma/migrations/20251201190000_restore_category_depth/migration.sql`:

```sql
-- Migration: Restore category depth column
-- 
-- CONTEXT: The depth column was accidentally dropped in migration 20251128021358
-- This migration restores it along with the trigger for automatic depth calculation.

-- Add depth column back to categories
ALTER TABLE "categories" ADD COLUMN IF NOT EXISTS "depth" INTEGER NOT NULL DEFAULT 0;

-- Add check constraint to limit hierarchy depth (if not exists)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'chk_category_depth'
    ) THEN
        ALTER TABLE "categories" ADD CONSTRAINT "chk_category_depth" CHECK (depth <= 3);
    END IF;
END $$;

-- Recreate trigger function to maintain depth and prevent cycles
CREATE OR REPLACE FUNCTION update_category_depth()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.parent_id IS NULL THEN
    NEW.depth := 0;
  ELSE
    SELECT depth + 1 INTO NEW.depth
    FROM categories
    WHERE id = NEW.parent_id;
    
    IF NEW.depth > 3 THEN
      RAISE EXCEPTION 'Category hierarchy depth cannot exceed 3 levels';
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Recreate trigger
DROP TRIGGER IF EXISTS trg_category_depth ON categories;
CREATE TRIGGER trg_category_depth
BEFORE INSERT OR UPDATE ON categories
FOR EACH ROW EXECUTE FUNCTION update_category_depth();
```

### Step 2: Verify Migration Applies Cleanly
```bash
# In CI or fresh database
cd apps/backend
pnpm prisma migrate deploy
```

---

## üõ°Ô∏è Prevention Checklist

### When Modifying Prisma Schema

- [ ] **NEVER use `prisma db push` in development** without creating a migration afterward
- [ ] **Always run `prisma migrate dev --name <descriptive_name>`** after schema changes
- [ ] **Review auto-generated migrations** for unintended column drops
- [ ] **Test migrations on a fresh database** before merging

### When Reviewing Auto-Generated Migrations

Look for these red flags:
```sql
-- ‚ö†Ô∏è WARNING: This drops a column that may have been added in a previous migration
ALTER TABLE "categories" DROP COLUMN "depth";
```

### Pre-Merge Checklist
1. Schema changes have corresponding migration files
2. Migrations apply cleanly on fresh database (`prisma migrate reset`)
3. Test factories match the schema (no columns that don't exist)

---

## üîß Debugging This Issue

### Check if Column Exists in CI Database
```bash
# In CI logs or SSH to CI database
psql $DATABASE_URL -c "SELECT column_name FROM information_schema.columns WHERE table_name='categories' AND column_name='depth';"
```

### Compare Local vs Migration State
```bash
# Show what Prisma thinks should exist
cd apps/backend
pnpm prisma format  # Normalizes schema
pnpm prisma migrate diff --from-migrations ./prisma/migrations --to-schema-datamodel ./prisma/schema.prisma
```

### Identify Drift
```bash
# Check if schema has columns not in migrations
grep -r "DROP COLUMN" apps/backend/prisma/migrations/*/migration.sql
grep -r "ADD COLUMN" apps/backend/prisma/migrations/*/migration.sql
```

---

# Issue 2: Playwright Browser Version Mismatch

## üö® Problem Summary

### Symptom
E2E tests fail in CI/CD with the error:
```
browserType.launch: Executable doesn't exist at /home/runner/.cache/ms-playwright/chromium_headless_shell-1200/chrome-headless-shell-linux64/chrome-headless-shell
```

### Impact
- E2E tests pass locally but fail in CI/CD
- CI pipeline blocks merges even though code is correct
- Difficult to diagnose because the "Install Playwright browsers" step appears to succeed

### Timeline of Discovery
- **First Attempt**: Identified cache-conditional logic issue - cache hit path only installed system deps
- **Second Attempt**: Found that `npx playwright install` uses global npx, not project version
- **Final Fix**: Use `pnpm exec playwright install` with lockfile-based cache key

---

## üîç Root Cause Analysis

### Issue 1: Cache-Conditional Browser Installation (Partial)

**Original Code:**
```yaml
- name: Install Playwright browsers
  if: steps.playwright-cache.outputs.cache-hit != 'true'
  run: |
    cd apps/web
    npx playwright install --with-deps

- name: Install Playwright system deps (cache hit)
  if: steps.playwright-cache.outputs.cache-hit == 'true'
  run: |
    cd apps/web
    npx playwright install-deps  # ‚ùå WRONG: Only installs system deps, NOT browser binaries!
```

**Problem**: When cache is restored, only system dependencies (fonts, codecs) are installed, NOT the browser binaries themselves. The cache may be stale or from a different Playwright version.

### Issue 2: Version Mismatch Between `npx` and Project

**The Critical Discovery:**
```
package.json: "@playwright/test": "^1.40.0"
pnpm-lock.yaml: resolved to 1.55.1 AND 1.57.0 (multiple versions!)
```

**Problem**: `npx playwright install` may use a different Playwright version than what's in the project's `node_modules`. This causes browser version mismatches:
- Project expects: `chromium_headless_shell-1200` (Playwright 1.55.x)
- Global npx installs: Different version's browsers

### Issue 3: Cache Key Based on Wrong File

**Original:**
```yaml
key: ${{ runner.os }}-playwright-${{ hashFiles('apps/web/package.json') }}
```

**Problem**: `package.json` has `^1.40.0` which doesn't change when lockfile resolves to a new minor version. Cache gets reused incorrectly across different resolved versions.

---

## ‚úÖ The Fix

### Commit 1: Remove Cache-Conditional Logic
```yaml
# BEFORE: Two conditional steps
- name: Install Playwright browsers
  if: steps.playwright-cache.outputs.cache-hit != 'true'
  run: npx playwright install --with-deps

- name: Install Playwright system deps (cache hit)  
  if: steps.playwright-cache.outputs.cache-hit == 'true'
  run: npx playwright install-deps

# AFTER: Single unconditional step
- name: Install Playwright browsers
  run: |
    cd apps/web
    npx playwright install --with-deps
    echo "‚úÖ Playwright browsers installed"
```

### Commit 2: Use `pnpm exec` and Lockfile Cache Key
```yaml
# Cache key now uses lockfile for accurate version matching
- name: Cache Playwright browsers
  id: playwright-cache
  uses: actions/cache@v4
  with:
    path: ~/.cache/ms-playwright
    key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}
    restore-keys: |
      ${{ runner.os }}-playwright-

# Use pnpm exec to ensure project's Playwright version is used
- name: Install Playwright browsers
  run: |
    cd apps/web
    pnpm exec playwright install --with-deps chromium
    echo "‚úÖ Playwright browsers installed"
    echo "üìã Installed browser versions:"
    pnpm exec playwright --version

# Also update the test run command
- name: üß™ Run E2E tests
  run: |
    cd apps/web
    pnpm exec playwright test
```

### Key Changes Summary

| Aspect | Before | After |
|--------|--------|-------|
| **Command** | `npx playwright install` | `pnpm exec playwright install` |
| **Cache Key** | `hashFiles('apps/web/package.json')` | `hashFiles('pnpm-lock.yaml')` |
| **Conditional Install** | Yes (cache hit skipped browser install) | No (always install) |
| **Browser Scope** | All browsers | `chromium` only (what we use) |
| **Version Verification** | None | `pnpm exec playwright --version` |

---

# General Prevention Strategies

## The "Local Works, CI Fails" Pattern

This document covers two instances of the same fundamental problem: **environment drift between local development and CI/CD**.

### Common Causes

| Cause | Local Behavior | CI Behavior | Solution |
|-------|---------------|-------------|----------|
| **Schema without migration** | `prisma db push` syncs directly | Migrations run in order, column missing | Always create migrations |
| **Global vs local tools** | `npx` may use different version | `npx` finds different global version | Use `pnpm exec` |
| **Stale cache** | Fresh install each time | Cache restored from previous runs | Use lockfile in cache key |
| **Seeded data differences** | Manual data setup | Automated seed scripts | Verify seed scripts match tests |

### Golden Rules

1. **Never trust "works on my machine"** - Test in clean environment
2. **Migrations are the source of truth** - Not schema files
3. **Use project-local tools** - `pnpm exec`, not `npx`
4. **Cache keys must capture dependencies** - Use lockfiles, not version ranges

---

## üîß Debugging Commands

### Database Schema Issues
```bash
# Check if column exists in database
psql $DATABASE_URL -c "SELECT column_name FROM information_schema.columns WHERE table_name='categories';"

# Show migration history
cd apps/backend
pnpm prisma migrate status

# Detect schema drift
pnpm prisma migrate diff --from-migrations ./prisma/migrations --to-schema-datamodel ./prisma/schema.prisma

# Reset database and rerun all migrations (DESTRUCTIVE)
pnpm prisma migrate reset

# Apply pending migrations
pnpm prisma migrate deploy
```

### Playwright Issues
```bash
# Check installed Playwright version
pnpm exec playwright --version

# Check where browsers are installed
ls -la ~/.cache/ms-playwright/

# Check which Playwright version is in lockfile
grep -A3 "@playwright/test" pnpm-lock.yaml

# Force reinstall browsers
pnpm exec playwright install --force chromium

# Run E2E with debug output
PWDEBUG=1 pnpm exec playwright test --headed --max-failures=1
```

### CI/CD Log Analysis
```bash
# Get failed job logs
gh run view <RUN_ID> --log-failed

# Get specific job logs
gh run view <RUN_ID> --job <JOB_ID> --log

# Search for specific errors
gh run view <RUN_ID> --job <JOB_ID> --log | grep -i "error\|failed\|missing"

# Check cache hit/miss
gh run view <RUN_ID> --job <JOB_ID> --log | grep -i "cache"
```

---

## üìÅ Related Files

### Database/Prisma Files
- `apps/backend/prisma/schema.prisma` - Prisma schema definition
- `apps/backend/prisma/migrations/` - All migration files
- `apps/backend/__tests__/utils/factories/` - Test factories that must match schema

### CI/CD Configuration Files
- `.github/workflows/ci-cd.yml` - CI/CD pipeline with Playwright installation
- `apps/web/package.json` - Playwright version declaration
- `pnpm-lock.yaml` - Resolved Playwright version
- `apps/web/playwright.config.ts` - Playwright test configuration

### E2E Test Files
- `apps/web/e2e/global-setup.ts` - Test user creation and browser launch
- `apps/web/e2e/*.spec.ts` - E2E test files

### Relevant Commits
- `9f4f083` - fix(ci): use pnpm exec for Playwright to ensure correct version
- `2555f17` - fix(e2e): fix Playwright browser installation and registration route
- `7b6bf75` - refactor(banking, categories): align mocks, schema, and test factories (added depth to schema without migration)

---

## üìö External References

- [Playwright CI/CD Documentation](https://playwright.dev/docs/ci)
- [GitHub Actions Cache](https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows)
- [pnpm exec vs npx](https://pnpm.io/cli/exec)
- [Prisma Migrate Documentation](https://www.prisma.io/docs/concepts/components/prisma-migrate)

---

## üìù Document History

| Date | Author | Changes |
|------|--------|---------|
| 2025-12-01 | AI Assistant | Initial document creation based on debugging session |
| 2025-12-01 | AI Assistant | Added database schema drift (depth column) issue and comprehensive fix |
