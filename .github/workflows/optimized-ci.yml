# ğŸš€ MoneyWise Optimized CI/CD Pipeline
# Consolidated workflow with improved caching, parallel execution, and monitoring

name: Optimized CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

# Global environment variables
env:
  NODE_VERSION: '18.17.0'
  COVERAGE_THRESHOLD: 80
  PERFORMANCE_BUDGET_MS: 3000

# Cancel previous runs on new commits
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ================================
  # ğŸ—ï¸ SETUP & VALIDATION
  # ================================
  
  setup:
    name: ğŸ“¦ Setup & Dependencies
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            apps/*/package-lock.json
            packages/*/package-lock.json

      - name: ğŸ“¥ Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
            ~/.npm
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: ğŸ“¥ Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          npm ci --prefer-offline --no-audit
          npm run setup

  # ================================
  # âš¡ PARALLEL VALIDATION JOBS
  # ================================
  
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ¨ Check Prettier formatting
        run: |
          npx prettier --check "**/*.{ts,tsx,js,jsx,json,md,yml,yaml}" || {
            echo "âŒ Code formatting issues found. Run 'npm run format' to fix."
            exit 1
          }

      - name: ğŸ“‹ ESLint validation
        run: |
          npm run lint || {
            echo "âŒ Linting issues found. Run 'npm run lint:fix' to attempt automatic fixes."
            exit 1
          }

      - name: ğŸ” TypeScript strict validation
        run: |
          cd apps/web && npx tsc --noEmit --strict
          cd ../backend && npx tsc --noEmit --strict

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”’ Enhanced secret scanning
        run: |
          echo "ğŸ”’ Scanning for exposed secrets..."
          
          # Check for AWS keys (excluding test files)
          if grep -r "AKIA[0-9A-Z]{16}" --exclude-dir=tests --exclude="*.test.*" --exclude="*.spec.*" apps/; then
            echo "âŒ AWS access keys found in code!"
            exit 1
          fi
          
          # Check for Stripe keys (excluding test files)
          if grep -r "sk_live_[0-9a-zA-Z]{24}" --exclude-dir=tests --exclude="*.test.*" --exclude="*.spec.*" apps/; then
            echo "âŒ Stripe secret keys found in code!"
            exit 1
          fi
          
          # Check for hardcoded passwords (excluding test files and empty passwords)
          if grep -r "password.*=.*['\"][^'\"]*['\"]" --exclude-dir=tests --exclude="*.test.*" --exclude="*.spec.*" --exclude-dir=__mocks__ apps/ --include="*.ts" --include="*.tsx" | grep -v "password.*=.*['\"]['\"]"; then
            echo "âŒ Hardcoded passwords found in code!"
            exit 1
          fi
          
          echo "âœ… No secrets detected"

      - name: ğŸ›¡ï¸ Dependency vulnerability scan
        run: |
          npm audit --audit-level moderate || {
            echo "âŒ Security vulnerabilities found in dependencies"
            exit 1
          }

  test-suite:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.pull_request.draft == false
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_moneywise
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ§ª Backend unit tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: test_user
          DB_PASSWORD: test_password
          DB_NAME: test_moneywise
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          NODE_ENV: test
        run: |
          cd apps/backend
          npm run test -- --coverage --passWithNoTests --detectOpenHandles
          
      - name: ğŸ§ª Frontend unit tests
        run: |
          cd apps/web
          npm run test:unit -- --coverage --passWithNoTests

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./apps/*/coverage
          fail_ci_if_error: false

  # ================================
  # ğŸ—ï¸ BUILD & PERFORMANCE
  # ================================
  
  build-test:
    name: ğŸ—ï¸ Build & Performance
    runs-on: ubuntu-latest
    needs: [setup, code-quality]
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ—ï¸ Build applications
        run: |
          npm run build:backend
          npm run build:web
        env:
          NODE_ENV: production

      - name: ğŸ“¦ Bundle size analysis
        run: |
          cd apps/web
          echo "ğŸ“¦ Bundle size analysis:"
          if [ -d ".next/static/chunks" ]; then
            du -sh .next/static/chunks/* | sort -hr | head -10
          else
            echo "âš ï¸ Build output not found"
          fi

      - name: âš¡ Performance budget check
        run: |
          echo "âš¡ Checking performance budgets..."
          cd apps/web
          if [ -f ".next/analyze/client.json" ]; then
            bundle_size=$(jq '.assets | map(.size) | add' .next/analyze/client.json 2>/dev/null || echo "0")
            if [ "$bundle_size" -gt 1000000 ]; then
              echo "âš ï¸ Bundle size exceeds 1MB: ${bundle_size} bytes"
            else
              echo "âœ… Bundle size within limits: ${bundle_size} bytes"
            fi
          else
            echo "â„¹ï¸ Bundle analysis not available"
          fi

  # ================================
  # âœ… CONSOLIDATION & REPORTING
  # ================================
  
  workflow-summary:
    name: âœ… CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, test-suite, build-test]
    if: always() && github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“Š Generate workflow summary
        run: |
          echo "# ğŸ‰ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "âœ… **Security Scan**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Security Scan**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-suite.result }}" == "success" ]; then
            echo "âœ… **Test Suite**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Test Suite**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-test.result }}" == "success" ]; then
            echo "âœ… **Build & Performance**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build & Performance**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” [Code Changes](https://github.com/${{ github.repository }}/pull/${{ github.event.number }})" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on PR (if failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const failures = [];
            if ('${{ needs.code-quality.result }}' !== 'success') failures.push('Code Quality');
            if ('${{ needs.security-scan.result }}' !== 'success') failures.push('Security Scan');
            if ('${{ needs.test-suite.result }}' !== 'success') failures.push('Test Suite');
            if ('${{ needs.build-test.result }}' !== 'success') failures.push('Build & Performance');
            
            const body = `## âŒ CI/CD Pipeline Failed
            
            The following checks failed:
            ${failures.map(f => `- âŒ ${f}`).join('\n')}
            
            Please review the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) and fix the issues.
            
            **Common fixes:**
            - Run \`npm run format\` for formatting issues
            - Run \`npm run lint:fix\` for linting issues
            - Check test files for failing assertions
            - Verify build dependencies are installed
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ================================
  # ğŸ“ˆ MONITORING & METRICS
  # ================================
  
  workflow-metrics:
    name: ğŸ“ˆ Performance Metrics
    runs-on: ubuntu-latest
    needs: [workflow-summary]
    if: always()
    
    steps:
      - name: ğŸ“Š Track workflow performance
        run: |
          echo "ğŸ“ˆ Recording workflow metrics..."
          
          # Calculate total runtime
          start_time="${{ github.event.head_commit.timestamp }}"
          end_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "Workflow started: $start_time"
          echo "Workflow ended: $end_time"
          
          # Log job results for monitoring
          echo "Job Results:"
          echo "- Code Quality: ${{ needs.code-quality.result }}"
          echo "- Security Scan: ${{ needs.security-scan.result }}"  
          echo "- Test Suite: ${{ needs.test-suite.result }}"
          echo "- Build Test: ${{ needs.build-test.result }}"

      - name: ğŸ”” Workflow failure notification
        if: failure()
        run: |
          echo "ğŸš¨ Workflow failure detected"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Run ID: ${{ github.run_id }}"
          # Add webhook notification here if needed