name: ðŸš€ CI/CD Update Management

on:
  schedule:
    # Monthly CI infrastructure updates on first Sunday at 5 AM UTC
    - cron: '0 5 1 * *'
  workflow_dispatch:
    inputs:
      update_strategy:
        description: 'Update strategy to use'
        required: false
        default: 'progressive'
        type: choice
        options:
          - progressive
          - canary-only
          - immediate
          - rollback
      force_update:
        description: 'Force update even if CI is busy'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Dry run (validate but don\'t update)'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-coordination:
    name: ðŸŽ¯ Update Coordination & Planning
    runs-on: ubuntu-latest

    outputs:
      should_proceed: ${{ steps.coordination.outputs.should_proceed }}
      update_strategy: ${{ steps.coordination.outputs.update_strategy }}
      estimated_duration: ${{ steps.coordination.outputs.estimated_duration }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: ðŸŽ¯ Coordinate Update Strategy
        id: coordination
        run: |
          echo "## ðŸš€ CI/CD Update Coordination" >> $GITHUB_STEP_SUMMARY

          strategy="${{ github.event.inputs.update_strategy || 'progressive' }}"
          force_update="${{ github.event.inputs.force_update || 'false' }}"
          dry_run="${{ github.event.inputs.dry_run || 'false' }}"

          echo "**Update Strategy**: $strategy" >> $GITHUB_STEP_SUMMARY
          echo "**Force Update**: $force_update" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: $dry_run" >> $GITHUB_STEP_SUMMARY

          # Check if infrastructure is healthy enough for updates
          npm ci
          npm run infrastructure:health || {
            echo "âŒ **Infrastructure unhealthy - aborting update**" >> $GITHUB_STEP_SUMMARY
            echo "should_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          }

          # Estimate update duration based on strategy
          case $strategy in
            "progressive")
              duration="15-20 minutes"
              ;;
            "canary-only")
              duration="5-10 minutes"
              ;;
            "immediate")
              duration="3-5 minutes"
              ;;
            "rollback")
              duration="2-3 minutes"
              ;;
            *)
              duration="unknown"
              ;;
          esac

          echo "should_proceed=true" >> $GITHUB_OUTPUT
          echo "update_strategy=$strategy" >> $GITHUB_OUTPUT
          echo "estimated_duration=$duration" >> $GITHUB_OUTPUT

          echo "âœ… **Update coordination complete**" >> $GITHUB_STEP_SUMMARY
          echo "**Estimated Duration**: $duration" >> $GITHUB_STEP_SUMMARY

  zero-downtime-update:
    name: ðŸ”„ Zero-Downtime Infrastructure Update
    runs-on: ubuntu-latest
    needs: update-coordination
    if: needs.update-coordination.outputs.should_proceed == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js (No Cache for Updates)
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ðŸ“‹ Pre-Update Status Report
        run: |
          echo "## ðŸ“‹ Pre-Update Infrastructure Status" >> $GITHUB_STEP_SUMMARY

          # Document current state
          echo "### Current System State" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- npm: $(npm --version)" >> $GITHUB_STEP_SUMMARY
          echo "- Update Strategy: ${{ needs.update-coordination.outputs.update_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "- Estimated Duration: ${{ needs.update-coordination.outputs.estimated_duration }}" >> $GITHUB_STEP_SUMMARY

          # Check ongoing workflows
          echo "### Pre-Update Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure Health: Running validation..." >> $GITHUB_STEP_SUMMARY

      - name: ðŸš€ Execute Zero-Downtime Update
        id: update_execution
        run: |
          echo "## ðŸš€ Zero-Downtime Update Execution" >> $GITHUB_STEP_SUMMARY

          strategy="${{ needs.update-coordination.outputs.update_strategy }}"
          dry_run="${{ github.event.inputs.dry_run || 'false' }}"

          if [ "$dry_run" = "true" ]; then
            echo "ðŸ§ª **Dry run mode activated**" >> $GITHUB_STEP_SUMMARY
            npm run ci:update-report
            echo "dry_run_completed=true" >> $GITHUB_OUTPUT
            echo "âœ… **Dry run completed - no changes made**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”„ **Executing live update with strategy: $strategy**" >> $GITHUB_STEP_SUMMARY

            # Install dependencies first
            npm ci

            # Execute update with error handling
            if npm run ci:update; then
              echo "update_successful=true" >> $GITHUB_OUTPUT
              echo "âœ… **Zero-downtime update completed successfully**" >> $GITHUB_STEP_SUMMARY
            else
              echo "update_successful=false" >> $GITHUB_OUTPUT
              echo "âŒ **Update failed - initiating rollback**" >> $GITHUB_STEP_SUMMARY

              # Attempt automatic rollback
              npm run ci:rollback || {
                echo "rollback_failed=true" >> $GITHUB_OUTPUT
                echo "ðŸš¨ **Rollback failed - manual intervention required**" >> $GITHUB_STEP_SUMMARY
                exit 1
              }

              echo "rollback_successful=true" >> $GITHUB_OUTPUT
              echo "âœ… **Rollback completed successfully**" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

      - name: ðŸ§ª Post-Update Validation
        if: steps.update_execution.outputs.update_successful == 'true'
        run: |
          echo "## ðŸ§ª Post-Update Validation" >> $GITHUB_STEP_SUMMARY

          # Comprehensive validation suite
          echo "Running post-update validation suite..." >> $GITHUB_STEP_SUMMARY

          # Infrastructure health check
          npm run infrastructure:health || {
            echo "âŒ Post-update health check failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

          # Performance validation
          start_time=$(date +%s%N)
          npm ci --dry-run
          end_time=$(date +%s%N)
          duration=$((($end_time - $start_time) / 1000000000))

          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure Health: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Check: $duration seconds (target: <30s)" >> $GITHUB_STEP_SUMMARY

          if [ $duration -gt 30 ]; then
            echo "âš ï¸ **Performance degraded post-update**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Performance Status: âœ… Optimal" >> $GITHUB_STEP_SUMMARY
          fi

          echo "âœ… **Post-update validation completed**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Generate Update Report
        if: always()
        run: |
          echo "## ðŸ“Š Update Execution Report" >> $GITHUB_STEP_SUMMARY

          # Generate comprehensive update report
          npm run ci:update-report || echo "Update report generation failed"

          # Summary metrics
          echo "### Update Session Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: ${{ needs.update-coordination.outputs.update_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Success**: $([ "${{ steps.update_execution.outputs.update_successful }}" = "true" ] && echo "âœ…" || echo "âŒ")" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback Required**: $([ "${{ steps.update_execution.outputs.rollback_successful }}" = "true" ] && echo "ðŸ”„ Yes" || echo "âŒ No")" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”„ Commit Update Changes
        if: steps.update_execution.outputs.update_successful == 'true'
        run: |
          # Check if update created any changes that should be committed
          if [ -n "$(git status --porcelain)" ]; then
            echo "## ðŸ”„ Committing Update Changes" >> $GITHUB_STEP_SUMMARY

            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action CI Updater"

            git add .
            git commit -m "feat(ci): zero-downtime infrastructure update

ðŸš€ Automated CI/CD infrastructure update completed successfully

**Update Strategy**: ${{ needs.update-coordination.outputs.update_strategy }}
**Duration**: ${{ needs.update-coordination.outputs.estimated_duration }}
**Validation**: All post-update checks passed

$(npm run ci:update-report 2>/dev/null || echo 'Update report unavailable')

ðŸ¤– Generated by Zero-Downtime CI Update System
Co-Authored-By: Claude <noreply@anthropic.com>" || echo "No changes to commit"

            # Push changes
            git push || echo "Failed to push update changes"
            echo "âœ… **Update changes committed to repository**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No repository changes from update**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš¨ Escalate Critical Update Failure
        if: steps.update_execution.outputs.rollback_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Critical CI/CD Update Failure - Manual Intervention Required';
            const body = `
            ## ðŸš€ Zero-Downtime CI/CD Update Critical Failure

            âŒ **Critical infrastructure update failure requiring immediate manual intervention**

            ### ðŸš¨ Critical Situation:

            A zero-downtime CI/CD infrastructure update has failed and the automatic rollback
            process has also failed. This puts the repository's CI/CD pipeline at risk.

            ### ðŸ“‹ Immediate Actions Required:

            1. **URGENT**: Review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. **Investigate**: Check \`zero-downtime-update-failure.json\` if available
            3. **Manual Rollback**: Restore from backups in \`backups/\` directory
            4. **Validate**: Run \`npm run infrastructure:health\` to verify restoration
            5. **Monitor**: Watch all subsequent CI runs for stability

            ### ðŸ” Technical Details:

            - **Update Strategy**: ${{ needs.update-coordination.outputs.update_strategy }}
            - **Estimated Duration**: ${{ needs.update-coordination.outputs.estimated_duration }}
            - **Failure Point**: Update execution and rollback both failed
            - **Run ID**: ${context.runId}
            - **Timestamp**: ${new Date().toISOString()}

            ### ðŸ›¡ï¸ Recovery Procedures:

            1. Check backup directory: \`backups/ci-update-*\`
            2. Restore workflows: \`cp -r backups/ci-update-*/workflows .github/\`
            3. Restore package files: \`cp backups/ci-update-*/package*.json .\`
            4. Validate restoration: \`npm run infrastructure:health\`

            ### ðŸš¨ Escalation:

            This is a **P0 CRITICAL** infrastructure failure requiring immediate attention.
            The CI/CD pipeline may be unstable until manual recovery is completed.

            ---
            *This issue was created automatically by the Zero-Downtime CI Update System.*
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['P0', 'critical', 'infrastructure', 'ci-cd', 'manual-intervention'],
              assignees: ['kdantuono']
            });

  update-success-notification:
    name: ðŸ“¢ Update Success Notification
    runs-on: ubuntu-latest
    needs: [update-coordination, zero-downtime-update]
    if: needs.zero-downtime-update.result == 'success'

    steps:
      - name: ðŸ“¢ Notify Update Success
        run: |
          echo "## ðŸŽ‰ Zero-Downtime Update Completed Successfully" >> $GITHUB_STEP_SUMMARY

          echo "### Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: ${{ needs.update-coordination.outputs.update_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${{ needs.update-coordination.outputs.estimated_duration }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Downtime**: ðŸš€ Zero downtime maintained" >> $GITHUB_STEP_SUMMARY

          echo "### Infrastructure Status" >> $GITHUB_STEP_SUMMARY
          echo "- CI/CD pipelines remain fully operational" >> $GITHUB_STEP_SUMMARY
          echo "- All health checks passing" >> $GITHUB_STEP_SUMMARY
          echo "- Performance metrics within acceptable ranges" >> $GITHUB_STEP_SUMMARY
          echo "- Automatic monitoring and alerting active" >> $GITHUB_STEP_SUMMARY

          echo "ðŸš€ **Zero-downtime infrastructure update system operating optimally**" >> $GITHUB_STEP_SUMMARY