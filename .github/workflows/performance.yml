name: Performance Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run performance tests weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      duration:
        description: 'Test duration (minutes)'
        required: false
        default: '5'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.1'

jobs:
  performance-tests:
    name: ğŸš€ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: timescale/timescaledb:latest-pg15
        env:
          POSTGRES_DB: moneywise_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd "pg_isready -U postgres -d moneywise_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸš€ Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: ğŸ—ï¸ Build backend for testing
        run: pnpm --filter @money-wise/backend build

      - name: ğŸš€ Start backend for performance testing
        run: |
          # Start backend in background
          pnpm --filter @money-wise/backend start:prod &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          
          # Wait for backend to be ready
          echo "â³ Waiting for backend to start..."
          for i in {1..30}; do
            if curl -f http://localhost:3002/health 2>/dev/null; then
              echo "âœ… Backend is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Backend failed to start"
              exit 1
            fi
            sleep 2
          done
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: password
          DB_NAME: moneywise_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          JWT_ACCESS_SECRET: test-secret
          JWT_REFRESH_SECRET: test-refresh-secret

      - name: ğŸ§ª Run load tests with k6
        run: |
          # Create k6 test script
          cat > performance-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export let options = {
            stages: [
              { duration: '1m', target: 10 },   // Ramp up to 10 users over 1 minute
              { duration: '2m', target: 20 },   // Stay at 20 users for 2 minutes
              { duration: '1m', target: 0 },    // Ramp down to 0 users over 1 minute
            ],
            thresholds: {
              http_req_duration: ['p(95)<1000'], // 95% of requests must complete below 1s
              http_req_failed: ['rate<0.1'],     // Error rate must be below 10%
            },
          };

          const BASE_URL = 'http://localhost:3002';

          export default function () {
            // Health check endpoint
            let healthResponse = http.get(`${BASE_URL}/health`);
            check(healthResponse, {
              'health check status is 200': (r) => r.status === 200,
              'health check response time < 500ms': (r) => r.timings.duration < 500,
            });

            // API info endpoint
            let apiResponse = http.get(`${BASE_URL}/api`);
            check(apiResponse, {
              'api info status is 200 or 302': (r) => r.status === 200 || r.status === 302,
              'api info response time < 1000ms': (r) => r.timings.duration < 1000,
            });

            sleep(1);
          }
          EOF

          echo "ğŸš€ Running load tests..."
          k6 run performance-test.js

      - name: ğŸ“Š Response time check
        run: |
          echo "ğŸ“Š Checking individual response times..."
          
          # Test critical endpoints
          ENDPOINTS=(
            "/health"
            "/api"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            echo "ğŸ” Testing $endpoint"
            RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "http://localhost:3002$endpoint")
            echo "ğŸ“Š Response time for $endpoint: ${RESPONSE_TIME}s"
            
            # Check if response time is acceptable (< 2 seconds)
            if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
              echo "âš ï¸ Slow response time for $endpoint: ${RESPONSE_TIME}s"
            else
              echo "âœ… Good response time for $endpoint: ${RESPONSE_TIME}s"
            fi
          done

      - name: ğŸ§  Memory leak detection
        run: |
          echo "ğŸ§  Checking for memory leaks..."
          
          # Get initial memory usage
          INITIAL_MEMORY=$(ps -p $BACKEND_PID -o rss= 2>/dev/null || echo "0")
          echo "ğŸ“Š Initial memory usage: ${INITIAL_MEMORY}KB"
          
          # Run some load for 30 seconds
          for i in {1..30}; do
            curl -s http://localhost:3002/health > /dev/null &
            sleep 1
          done
          
          # Wait for requests to complete
          sleep 5
          
          # Get final memory usage
          FINAL_MEMORY=$(ps -p $BACKEND_PID -o rss= 2>/dev/null || echo "0")
          echo "ğŸ“Š Final memory usage: ${FINAL_MEMORY}KB"
          
          # Calculate memory increase
          if [ "$INITIAL_MEMORY" -gt 0 ] && [ "$FINAL_MEMORY" -gt 0 ]; then
            MEMORY_INCREASE=$((FINAL_MEMORY - INITIAL_MEMORY))
            INCREASE_PERCENT=$(echo "scale=2; $MEMORY_INCREASE * 100 / $INITIAL_MEMORY" | bc -l)
            echo "ğŸ“Š Memory increase: ${MEMORY_INCREASE}KB (${INCREASE_PERCENT}%)"
            
            # Alert if memory increased by more than 50%
            if (( $(echo "$INCREASE_PERCENT > 50" | bc -l) )); then
              echo "âš ï¸ Potential memory leak detected: ${INCREASE_PERCENT}% increase"
            else
              echo "âœ… Memory usage stable: ${INCREASE_PERCENT}% increase"
            fi
          fi

      - name: ğŸ“Š Database query analysis
        run: |
          echo "ğŸ“Š Database query performance analysis..."
          
          # Connect to PostgreSQL and check for slow queries
          PGPASSWORD=password psql -h localhost -U postgres -d moneywise_test -c "
            SELECT 
              query,
              calls,
              total_time,
              mean_time,
              max_time
            FROM pg_stat_statements 
            WHERE mean_time > 100 
            ORDER BY mean_time DESC 
            LIMIT 10;
          " 2>/dev/null || echo "ğŸ“‹ pg_stat_statements not available (expected in test environment)"
          
          # Check active connections
          CONNECTIONS=$(PGPASSWORD=password psql -h localhost -U postgres -d moneywise_test -t -c "SELECT count(*) FROM pg_stat_activity;" 2>/dev/null || echo "0")
          echo "ğŸ“Š Active database connections: $CONNECTIONS"

      - name: ğŸ›‘ Cleanup backend process
        if: always()
        run: |
          if [ -n "$BACKEND_PID" ]; then
            echo "ğŸ›‘ Stopping backend process $BACKEND_PID"
            kill $BACKEND_PID 2>/dev/null || true
            sleep 2
            kill -9 $BACKEND_PID 2>/dev/null || true
          fi

      - name: ğŸ“¤ Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            performance-test.js
            k6-results.json
          retention-days: 30

  performance-summary:
    name: ğŸ“‹ Performance Summary
    runs-on: ubuntu-latest
    needs: performance-tests
    if: always()

    steps:
      - name: ğŸ“‹ Performance test results
        run: |
          echo "ğŸ“‹ Performance Testing Summary"
          echo "=============================="
          echo "ğŸš€ Load Tests: ${{ needs.performance-tests.result }}"
          echo ""
          
          if [[ "${{ needs.performance-tests.result }}" == "success" ]]; then
            echo "âœ… Performance tests passed"
            echo "ğŸ“Š All response time and error rate thresholds met"
          else
            echo "âŒ Performance tests failed"
            echo "ğŸ“‹ Check the performance test logs for details"
          fi