# ğŸ” Feature Branch Quality Check
# Essential validation for feature branches during development
# Triggered by: push to feature/*, fix/*, refactor/* branches

name: Feature Branch Check

on:
  push:
    branches:
      - 'feature/**'
      - 'fix/**'
      - 'refactor/**'
      - 'chore/**'
  workflow_dispatch:

# Global environment variables
env:
  NODE_VERSION: '18'

# Cancel previous runs on new commits
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ================================
  # ğŸš€ ESSENTIAL FEATURE VALIDATION
  # ================================

  feature-validation:
    name: ğŸš€ Essential Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit --legacy-peer-deps

      - name: ğŸ”§ TypeScript compilation check
        run: |
          echo "ğŸ” Validating TypeScript compilation..."
          npx tsc --noEmit --skipLibCheck

      - name: ğŸ“‹ Basic ESLint validation
        run: |
          echo "ğŸ“‹ Running ESLint validation..."
          npm run lint

      - name: âœ… Build verification
        run: |
          echo "ğŸ—ï¸ Verifying build process..."
          npm run build

  # ================================
  # ğŸ”’ CRITICAL SECURITY CHECK
  # ================================

  security-essentials:
    name: ğŸ”’ Security Essentials
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Critical security scan
        run: |
          echo "ğŸ”’ Running critical security validation..."

          # Check for real production secrets
          if grep -r "AKIA[0-9A-Z]{16}" apps/ --exclude-dir=tests --exclude-dir=__tests__ --exclude="*.test.*" --exclude="*.spec.*" 2>/dev/null; then
            echo "âŒ AWS secrets detected!"
            exit 1
          fi

          if grep -r "sk_live_[0-9a-zA-Z]{24}" apps/ --exclude-dir=tests --exclude-dir=__tests__ --exclude="*.test.*" --exclude="*.spec.*" 2>/dev/null; then
            echo "âŒ Stripe live secrets detected!"
            exit 1
          fi

          # Check for hardcoded passwords (excluding dev/test patterns)
          if grep -ri "password.*=" apps/ --exclude-dir=tests --exclude-dir=__tests__ --exclude="*.test.*" --exclude="*.spec.*" \
            | grep -v -i "dev123\|test.*password\|password.*test\|mock.*password\|password.*mock\|development\|localhost\|env\|process\.env" 2>/dev/null; then
            echo "âŒ Potential hardcoded passwords found!"
            echo "Review the above matches to ensure no production passwords are committed"
            exit 1
          fi

          echo "âœ… No critical security issues detected"

  # ================================
  # âœ… FEATURE BRANCH SUMMARY
  # ================================

  feature-summary:
    name: âœ… Feature Branch Status
    runs-on: ubuntu-latest
    needs: [feature-validation, security-essentials]
    if: always()

    steps:
      - name: ğŸ“Š Feature Branch Summary
        run: |
          echo "ğŸ“Š Feature Branch Validation Complete"
          echo "ğŸ”§ Validation: ${{ needs.feature-validation.result }}"
          echo "ğŸ”’ Security: ${{ needs.security-essentials.result }}"
          echo ""

          if [[ "${{ needs.feature-validation.result }}" == "success" && "${{ needs.security-essentials.result }}" == "success" ]]; then
            echo "âœ… Feature branch ready for development continuation"
          else
            echo "âŒ Feature branch has issues that need resolution"
            exit 1
          fi