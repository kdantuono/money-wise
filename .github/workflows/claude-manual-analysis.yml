name: Claude Manual Code Analysis

on:
  workflow_dispatch:
    inputs:
      analysis_type:
        description: "Type of analysis to perform"
        required: true
        type: choice
        options:
          - summarize-commit
          - security-review
          - performance-audit
          - architecture-review
          - dependency-audit
        default: "summarize-commit"

      commit_sha:
        description: "Specific commit SHA to analyze (leave empty for latest)"
        required: false
        type: string

      focus_area:
        description: "Specific area to focus on (optional)"
        required: false
        type: choice
        options:
          - all
          - backend
          - frontend
          - database
          - security
          - performance
        default: "all"

jobs:
  analyze-code:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50 # Get more history for better analysis

      - name: Set analysis target
        id: target
        run: |
          if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
            echo "commit_sha=${{ github.event.inputs.commit_sha }}" >> $GITHUB_OUTPUT
            echo "analyzing_custom=true" >> $GITHUB_OUTPUT
          else
            echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
            echo "analyzing_custom=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Analysis
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPOSITORY: ${{ github.repository }}
            BRANCH: ${{ github.ref_name }}
            ANALYSIS TYPE: ${{ github.event.inputs.analysis_type }}
            FOCUS AREA: ${{ github.event.inputs.focus_area }}
            TARGET COMMIT: ${{ steps.target.outputs.commit_sha }}

            ## MoneyWise Code Analysis Request

            Perform a detailed analysis based on the selected type:

            ${{ github.event.inputs.analysis_type == 'summarize-commit' && '
            ### üìã COMMIT SUMMARY ANALYSIS

            Provide a comprehensive summary of the target commit:

            1. **What Changed**
               - Files modified, added, or deleted
               - Lines of code changes
               - Key functional changes

            2. **Purpose & Impact**
               - Business logic changes
               - User-facing improvements
               - Technical debt or refactoring
               - Performance implications

            3. **Risk Assessment**
               - Breaking changes
               - Security implications
               - Dependencies affected
               - Test coverage impact

            4. **Quality Analysis**
               - Code quality improvements/degradations
               - Adherence to MoneyWise patterns
               - Documentation updates needed
            ' || '' }}

            ${{ github.event.inputs.analysis_type == 'security-review' && '
            ### üîí SECURITY REVIEW ANALYSIS

            Conduct a thorough security review:

            1. **Vulnerability Scanning**
               - Check for common security vulnerabilities
               - SQL injection prevention
               - XSS protection
               - Authentication/authorization flaws

            2. **Financial Security**
               - Transaction integrity
               - PCI DSS compliance aspects
               - Data encryption standards
               - User data protection

            3. **API Security**
               - Endpoint security
               - Rate limiting
               - Input validation
               - JWT token handling

            4. **Dependencies & Secrets**
               - Dependency vulnerabilities
               - Exposed secrets or keys
               - Environment variable security

            5. **Recommendations**
               - Immediate fixes required
               - Security best practices
               - Compliance improvements
            ' || '' }}

            ${{ github.event.inputs.analysis_type == 'performance-audit' && '
            ### ‚ö° PERFORMANCE AUDIT ANALYSIS

            Analyze performance aspects:

            1. **Frontend Performance**
               - Bundle size impact
               - Core Web Vitals considerations
               - React component optimization
               - Image and asset optimization

            2. **Backend Performance**
               - Database query efficiency
               - API response times
               - Caching opportunities
               - Resource utilization

            3. **Database Performance**
               - Query optimization opportunities
               - Index effectiveness
               - N+1 query problems
               - Connection pooling

            4. **Infrastructure**
               - Docker optimization
               - Memory usage
               - CPU utilization
               - Network efficiency

            5. **Recommendations**
               - Performance bottlenecks
               - Optimization strategies
               - Monitoring improvements
            ' || '' }}

            ${{ github.event.inputs.analysis_type == 'architecture-review' && '
            ### üèóÔ∏è ARCHITECTURE REVIEW ANALYSIS

            Review architectural decisions and patterns:

            1. **Architectural Compliance**
               - MoneyWise pattern adherence
               - Microservices boundaries
               - Separation of concerns
               - SOLID principles

            2. **Code Organization**
               - Module structure
               - Dependency management
               - Code reusability
               - Maintainability

            3. **Design Patterns**
               - Service layer patterns
               - Repository patterns
               - DTO usage
               - Error handling patterns

            4. **Scalability**
               - Multi-tenant design
               - Database scalability
               - API design
               - Caching strategies

            5. **Technical Debt**
               - Code duplication
               - Outdated patterns
               - Refactoring opportunities
               - Documentation gaps
            ' || '' }}

            ${{ github.event.inputs.analysis_type == 'dependency-audit' && '
            ### üì¶ DEPENDENCY AUDIT ANALYSIS

            Audit project dependencies:

            1. **Dependency Health**
               - Outdated packages
               - Security vulnerabilities
               - License compatibility
               - Bundle size impact

            2. **Version Management**
               - Version conflicts
               - Peer dependency issues
               - Lock file integrity
               - Update strategies

            3. **Unused Dependencies**
               - Dead code elimination
               - Unused packages
               - Dev vs production dependencies
               - Tree shaking opportunities

            4. **Alternative Analysis**
               - Better alternatives
               - Lighter alternatives
               - Consolidation opportunities
               - Performance improvements

            5. **Recommendations**
               - Update priorities
               - Security patches
               - Performance optimizations
               - Maintenance strategies
            ' || '' }}

            ### üéØ FOCUS AREA FILTERING
            ${{ github.event.inputs.focus_area != 'all' && format('Focus specifically on **{0}** components and related code.', github.event.inputs.focus_area) || 'Analyze all components comprehensively.' }}

            Provide detailed, actionable insights that help maintain MoneyWise's high quality standards and guide development decisions.

          claude_args: |
            --allowedTools "Read,Glob,Grep,Bash(git:*),Task"

      - name: Create analysis issue
        if: github.event.inputs.analysis_type == 'security-review' || github.event.inputs.analysis_type == 'performance-audit'
        uses: actions/github-script@v7
        with:
          script: |
            const analysisType = '${{ github.event.inputs.analysis_type }}';
            const commitSha = '${{ steps.target.outputs.commit_sha }}';
            const focusArea = '${{ github.event.inputs.focus_area }}';

            const title = `üîç ${analysisType.charAt(0).toUpperCase() + analysisType.slice(1).replace('-', ' ')} - ${new Date().toISOString().split('T')[0]}`;

            const labels = ['analysis', 'claude-generated'];
            if (analysisType === 'security-review') labels.push('security');
            if (analysisType === 'performance-audit') labels.push('performance');
            if (focusArea !== 'all') labels.push(focusArea);

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `
                ## Automated Code Analysis Results

                **Analysis Type:** ${analysisType}
                **Target Commit:** ${commitSha}
                **Focus Area:** ${focusArea}
                **Triggered By:** @${context.actor}
                **Date:** ${new Date().toISOString()}

                ### Analysis Summary

                Claude has completed a ${analysisType.replace('-', ' ')} analysis. Please review the action logs and workflow artifacts for detailed findings.

                ### Next Steps

                - [ ] Review analysis findings
                - [ ] Prioritize identified issues
                - [ ] Create implementation tasks
                - [ ] Update documentation as needed

                ---
                ü§ñ Generated by Claude Code Analysis Action
              `,
              labels: labels
            });