name: ðŸ§¹ Code Quality Hygiene

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/**'
      - 'packages/**'
      - '*.ts'
      - '*.tsx'
      - '*.js'
      - '*.jsx'
  workflow_dispatch:

jobs:
  code-quality:
    name: ðŸ” Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: ðŸ” Lockfile Integrity Check
        run: |
          echo "## ðŸ”’ Lockfile Integrity Validation" >> $GITHUB_STEP_SUMMARY
          npm run validate:lockfile || {
            echo "âŒ Lockfile integrity check failed!" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm install\` to regenerate lockfile" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "âœ… Lockfile integrity validated" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ”§ Build types package
        run: cd packages/types && npm run build

      - name: ðŸ§¹ ESLint Quality Check
        run: |
          echo "## ðŸ§¹ ESLint Analysis" >> $GITHUB_STEP_SUMMARY

          # Run ESLint with zero warnings tolerance
          npm run lint 2>&1 | tee eslint-output.txt || {
            echo "âŒ ESLint issues found!" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -20 eslint-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm run lint:fix\` to fix auto-fixable issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "âœ… No ESLint issues found" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’… Prettier Format Check
        run: |
          echo "## ðŸ’… Code Formatting" >> $GITHUB_STEP_SUMMARY

          npm run format:check || {
            echo "âŒ Code formatting issues found!" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm run format\` to fix formatting" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "âœ… Code formatting is consistent" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” TypeScript Compilation
        run: |
          echo "## ðŸ” TypeScript Analysis" >> $GITHUB_STEP_SUMMARY

          # Check TypeScript compilation
          cd apps/backend && npx tsc --noEmit || {
            echo "âŒ Backend TypeScript compilation errors!" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

          cd ../web && npx tsc --noEmit || {
            echo "âŒ Frontend TypeScript compilation errors!" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

          echo "âœ… TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¦ Import Organization Check
        run: |
          echo "## ðŸ“¦ Import Analysis" >> $GITHUB_STEP_SUMMARY

          # Check for unused imports
          unused_imports=$(find apps packages -name "*.ts" -o -name "*.tsx" | xargs grep -l "import.*from" | xargs grep -L "export" | wc -l)

          if [ $unused_imports -gt 0 ]; then
            echo "âš ï¸ Found potential unused imports in $unused_imports files" >> $GITHUB_STEP_SUMMARY
            echo "Consider running import cleanup tools" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Import organization looks good" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ—ï¸ Build Verification
        run: |
          echo "## ðŸ—ï¸ Build Verification" >> $GITHUB_STEP_SUMMARY

          # Test that everything builds successfully
          npm run build:backend || {
            echo "âŒ Backend build failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

          echo "âœ… Backend build successful" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Web build skipped (memory constraints in CI)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Code Quality Metrics
        run: |
          echo "## ðŸ“Š Code Quality Metrics" >> $GITHUB_STEP_SUMMARY

          # Count TypeScript files
          ts_files=$(find apps packages -name "*.ts" -o -name "*.tsx" | wc -l)
          echo "ðŸ“„ TypeScript files: $ts_files" >> $GITHUB_STEP_SUMMARY

          # Count JavaScript files
          js_files=$(find apps packages -name "*.js" -o -name "*.jsx" | wc -l)
          echo "ðŸ“„ JavaScript files: $js_files" >> $GITHUB_STEP_SUMMARY

          # Lines of code
          total_lines=$(find apps packages -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | xargs wc -l | tail -1 | awk '{print $1}')
          echo "ðŸ“ Total lines of code: $total_lines" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”„ Auto-fix Suggestions
        if: failure()
        run: |
          echo "## ðŸ”„ Auto-fix Suggestions" >> $GITHUB_STEP_SUMMARY
          echo "To fix the issues found, run these commands locally:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Fix linting issues" >> $GITHUB_STEP_SUMMARY
          echo "npm run lint:fix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Fix formatting issues" >> $GITHUB_STEP_SUMMARY
          echo "npm run format" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check TypeScript compilation" >> $GITHUB_STEP_SUMMARY
          echo "npm run build" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY