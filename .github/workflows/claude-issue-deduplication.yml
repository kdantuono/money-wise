name: Claude Issue Deduplication

on:
  issues:
    types: [opened, edited]

jobs:
  deduplicate-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Issue Deduplication
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_non_write_users: '*'
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            REPOSITORY: ${{ github.repository }}
            NEW ISSUE NUMBER: ${{ github.event.issue.number }}
            NEW ISSUE TITLE: ${{ github.event.issue.title }}
            NEW ISSUE BODY: ${{ github.event.issue.body }}
            ISSUE AUTHOR: ${{ github.event.issue.user.login }}

            ## MoneyWise Issue Deduplication Task

            Analyze this issue to detect potential duplicates in the MoneyWise repository.

            ### üéØ DEDUPLICATION OBJECTIVES

            1. **Search for Similar Issues**
               - Find existing open issues with similar titles
               - Identify issues with comparable descriptions
               - Look for related bug reports or feature requests

            2. **Similarity Analysis**
               - Compare symptoms and error messages
               - Analyze affected components (backend, frontend, mobile)
               - Match user scenarios and use cases
               - Consider technical stack similarities

            3. **Financial App Context**
               - Transaction-related issues
               - Authentication/security problems
               - Banking integration (Plaid) issues
               - Budget and analytics features
               - Multi-currency support
               - User account management

            ### üîç SEARCH STRATEGY

            Search for duplicates using these approaches:

            1. **Keyword Matching**
               - Extract key terms from title and description
               - Search for technical error messages
               - Look for component-specific keywords

            2. **Semantic Analysis**
               - Identify the core problem being reported
               - Match business logic issues
               - Compare user workflow disruptions

            3. **Technical Stack Matching**
               - NestJS backend issues
               - Next.js frontend problems
               - TypeORM database issues
               - Plaid integration problems
               - Docker/deployment issues

            ### üìã RESPONSE ACTIONS

            **If NO duplicates found:**
            - Add comment confirming uniqueness
            - Suggest relevant labels if helpful
            - No further action needed

            **If POTENTIAL duplicates found:**
            - Compare issues carefully
            - List similar issues with links
            - Explain similarities and differences
            - Ask for clarification if needed

            **If CLEAR duplicate found:**
            - Add `duplicate` label
            - Comment with link to original issue
            - Suggest closing the duplicate
            - Thank the reporter for their contribution

            ### üéØ DUPLICATE DETECTION CRITERIA

            Consider issues duplicates if they have:
            - Identical or very similar symptoms
            - Same error messages or stack traces
            - Identical component/feature affected
            - Same user workflow issues
            - Equivalent feature requests

            ### üìù COMMENT TEMPLATE

            Structure your response like this:

            ```
            ## üîç Duplicate Check Results

            **Status:** [No duplicates found / Potential duplicates found / Duplicate detected]

            [If duplicates found:]
            **Similar Issues:**
            - #XXX - [Brief description and similarity]
            - #YYY - [Brief description and similarity]

            **Analysis:**
            [Explain similarities/differences]

            **Recommendation:**
            [Action suggested]

            ---
            ü§ñ Automated duplicate detection by Claude
            ```

            Use GitHub search capabilities to find related issues and provide accurate duplicate detection for the MoneyWise development team.

          claude_args: |
            --allowedTools "Task,mcp__github_search_issues__*,mcp__github_issue_comment__*,mcp__github_issue_labels__*"
