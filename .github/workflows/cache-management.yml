name: ğŸ—„ï¸ Cache Management

on:
  schedule:
    # Weekly cache maintenance on Sunday at 3 AM UTC
    - cron: '0 3 * * SUN'
  workflow_dispatch:
    inputs:
      force_clean:
        description: 'Force clean all caches'
        required: false
        default: 'false'
        type: boolean
      cache_strategy:
        description: 'Cache validation strategy'
        required: false
        default: 'validate'
        type: choice
        options:
          - validate
          - clean
          - report

jobs:
  cache-maintenance:
    name: ğŸ”§ Cache Health Maintenance
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js (No Cache)
        uses: actions/setup-node@v4
        with:
          node-version: 18
          # Disable cache for maintenance
          cache: false

      - name: ğŸ” Cache Health Assessment
        run: |
          echo "## ğŸ—„ï¸ Cache Management Report" >> $GITHUB_STEP_SUMMARY
          echo "### Cache Strategy: ${{ github.event.inputs.cache_strategy || 'validate' }}" >> $GITHUB_STEP_SUMMARY

          # Check current cache state
          npm config get cache
          npm cache ls --silent || echo "Cache listing failed"

      - name: ğŸ§¹ Cache Validation and Cleanup
        run: |
          strategy="${{ github.event.inputs.cache_strategy || 'validate' }}"
          force_clean="${{ github.event.inputs.force_clean || 'false' }}"

          if [ "$force_clean" = "true" ] || [ "$strategy" = "clean" ]; then
            echo "ğŸ§¹ **Force cleaning all caches**" >> $GITHUB_STEP_SUMMARY
            npm cache clean --force
            echo "âœ… Cache cleaned successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "$strategy" = "report" ]; then
            echo "ğŸ“Š **Generating cache health report**" >> $GITHUB_STEP_SUMMARY
            npm run cache:report || echo "âš ï¸ Cache report generation failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ” **Validating cache health**" >> $GITHUB_STEP_SUMMARY
            npm run validate:cache || {
              echo "âŒ Cache validation failed - attempting recovery" >> $GITHUB_STEP_SUMMARY
              npm run cache:clean
              echo "ğŸ”§ Cache recovery completed" >> $GITHUB_STEP_SUMMARY
            }
          fi

      - name: ğŸ§ª Test Cache Performance
        run: |
          echo "## âš¡ Cache Performance Test" >> $GITHUB_STEP_SUMMARY

          # Test npm ci performance with clean cache
          start_time=$(date +%s%N)
          npm ci --silent
          end_time=$(date +%s%N)
          install_time=$((($end_time - $start_time) / 1000000000))

          echo "ğŸ“¦ npm ci time (clean cache): ${install_time}s" >> $GITHUB_STEP_SUMMARY

          # Performance thresholds
          if [ $install_time -gt 120 ]; then
            echo "âš ï¸ **Slow cache performance detected**" >> $GITHUB_STEP_SUMMARY
            echo "Consider investigating network or registry issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Cache performance within acceptable range" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“Š Generate Cache Metrics
        run: |
          echo "## ğŸ“Š Cache Metrics Summary" >> $GITHUB_STEP_SUMMARY

          # Generate comprehensive cache report
          npm run cache:report || echo "Cache report unavailable"

          # Verify cache integrity
          npm cache verify || echo "Cache verification failed"

      - name: ğŸ”„ Cache Resilience Test
        run: |
          echo "## ğŸ”„ Cache Resilience Validation" >> $GITHUB_STEP_SUMMARY

          # Test cache recovery scenario
          echo "Testing cache corruption recovery..." >> $GITHUB_STEP_SUMMARY

          # Simulate cache issue and recovery
          npm run validate:cache || {
            echo "Cache validation failed - testing recovery" >> $GITHUB_STEP_SUMMARY
            npm run cache:clean
            npm ci --dry-run || {
              echo "âŒ Cache recovery failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            }
            echo "âœ… Cache recovery successful" >> $GITHUB_STEP_SUMMARY
          }

      - name: ğŸ“ˆ Performance Baseline Update
        run: |
          echo "## ğŸ“ˆ Performance Baseline" >> $GITHUB_STEP_SUMMARY

          # Create performance baseline for future comparisons
          echo "Current performance metrics:" >> $GITHUB_STEP_SUMMARY
          echo "- npm ci time: ${install_time}s" >> $GITHUB_STEP_SUMMARY
          echo "- Cache size: $(npm cache verify 2>&1 | grep -o '[0-9]* verified' || echo 'unknown')" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js version: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- npm version: $(npm --version)" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš¨ Create Issue on Critical Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸš¨ Critical Cache Management Failure';
            const body = `
            ## ğŸ—„ï¸ Cache Management System Alert

            âŒ **Critical cache management failure detected**

            ### ğŸš¨ Issue Description:

            The automated cache management system has encountered a critical failure
            that could impact CI/CD performance and reliability.

            ### ğŸ“‹ Immediate Actions Required:

            1. **Investigate**: Review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. **Manual Clean**: Run \`npm cache clean --force\` if needed
            3. **Verify**: Test \`npm ci\` performance locally
            4. **Monitor**: Watch subsequent CI runs for cache-related issues

            ### ğŸ” Technical Details:

            - **Workflow**: Cache Management
            - **Strategy**: ${{ github.event.inputs.cache_strategy || 'validate' }}
            - **Force Clean**: ${{ github.event.inputs.force_clean || 'false' }}
            - **Run ID**: ${context.runId}
            - **Timestamp**: ${new Date().toISOString()}

            ### ğŸ›¡ï¸ Recovery Steps:

            The cache management system includes automatic recovery mechanisms.
            If this issue persists, manual intervention may be required.

            ---
            *This issue was created automatically by the cache management system.*
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['critical', 'performance', 'cache', 'infrastructure', 'automation'],
              assignees: ['kdantuono']
            });