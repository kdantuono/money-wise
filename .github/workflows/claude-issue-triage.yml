name: Claude Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code for Issue Triage
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_non_write_users: '*' # Required for issue triage workflow
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            REPOSITORY: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            ISSUE TITLE: ${{ github.event.issue.title }}
            ISSUE BODY: ${{ github.event.issue.body }}
            ISSUE AUTHOR: ${{ github.event.issue.user.login }}

            ## MoneyWise Issue Triage Task

            Analyze this issue and provide intelligent triage for the MoneyWise personal finance application.

            ### üéØ TRIAGE OBJECTIVES
            1. **Categorize** the issue type and priority
            2. **Label** with appropriate GitHub labels
            3. **Assess** complexity and effort required
            4. **Identify** relevant team members or expertise needed
            5. **Suggest** initial investigation steps

            ### üè∑Ô∏è AVAILABLE LABELS (add as appropriate)

            **Issue Type:**
            - `bug` - Something isn't working correctly
            - `feature` - New feature request
            - `enhancement` - Improvement to existing feature
            - `documentation` - Documentation needs
            - `security` - Security-related issue
            - `performance` - Performance optimization
            - `accessibility` - Accessibility improvements
            - `ui/ux` - User interface/experience issue

            **Priority:**
            - `priority:critical` - Security, data loss, or app-breaking issues
            - `priority:high` - Important functionality affected
            - `priority:medium` - Standard issues and features
            - `priority:low` - Nice-to-have improvements

            **Component:**
            - `backend` - NestJS API issues
            - `frontend` - Next.js web app issues
            - `mobile` - React Native app issues
            - `database` - PostgreSQL/Redis issues
            - `auth` - Authentication/authorization
            - `banking` - Plaid integration
            - `analytics` - Analytics and reporting
            - `ci/cd` - DevOps and deployment

            **Effort:**
            - `effort:small` - < 1 day
            - `effort:medium` - 1-3 days
            - `effort:large` - > 3 days

            **Status:**
            - `needs-investigation` - Requires further analysis
            - `ready-for-development` - Clear requirements, ready to implement
            - `waiting-for-info` - Need more information from reporter
            - `duplicate` - Duplicate of existing issue

            ### üìã TRIAGE RESPONSE FORMAT

            Provide a comprehensive triage response including:

            1. **Issue Classification**
               - Type, priority, and affected components
               - Effort estimation

            2. **Security Assessment** (if applicable)
               - Potential security implications
               - Immediate mitigations needed

            3. **Technical Analysis**
               - Affected code areas
               - Potential root causes
               - Dependencies or related issues

            4. **Next Steps**
               - Investigation tasks
               - Required expertise
               - Suggested assignee (if obvious)

            5. **Labels to Apply**
               - List all applicable labels

            Add appropriate labels and provide a detailed triage comment to help the development team prioritize and address this issue effectively.

          claude_args: |
            --allowedTools "Read,Glob,Grep,Task,mcp__github_issue_comment__*,mcp__github_issue_labels__*"
