name: Claude PR Review - Security Focus

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - 'apps/backend/**'
      - 'packages/types/**'
      - '.env*'
      - 'docker-compose*.yml'
      - '**/auth/**'
      - '**/security/**'

jobs:
  security-focused-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Security-Focused PR Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true

          prompt: |
            REPOSITORY: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            SECURITY REVIEW FOCUS

            ## üîí CRITICAL SECURITY REVIEW

            This PR contains changes to security-sensitive code paths. Perform an intensive security review focusing on:

            ### üö® CRITICAL SECURITY AREAS

            1. **Authentication & Authorization**
               - JWT token handling and validation
               - Password hashing and verification
               - Session management
               - User permission checks
               - Multi-factor authentication

            2. **Data Protection**
               - Personal financial information (PII)
               - Transaction data encryption
               - Database security (SQL injection prevention)
               - API input validation and sanitization
               - Output encoding

            3. **Financial Security**
               - Transaction integrity checks
               - Amount/currency validation
               - Account balance security
               - Audit trail preservation
               - PCI DSS compliance aspects

            4. **Infrastructure Security**
               - Environment variable handling
               - Secret management
               - Docker security configurations
               - Network security settings
               - Rate limiting implementation

            5. **API Security**
               - Endpoint authorization
               - CORS configuration
               - Request/response validation
               - Error message exposure
               - Security headers

            ### üîç SECURITY CHECKLIST

            Verify the following for each changed file:

            **Authentication:**
            - [ ] Proper JWT validation
            - [ ] Secure password handling
            - [ ] Session security
            - [ ] Permission boundaries

            **Data Validation:**
            - [ ] Input sanitization
            - [ ] SQL injection prevention
            - [ ] XSS protection
            - [ ] CSRF protection

            **Financial Data:**
            - [ ] Transaction validation
            - [ ] Amount precision handling
            - [ ] Currency conversion security
            - [ ] Account access controls

            **Infrastructure:**
            - [ ] No hardcoded secrets
            - [ ] Secure configurations
            - [ ] Proper error handling
            - [ ] Audit logging

            ### ‚ö†Ô∏è SECURITY VIOLATIONS

            **IMMEDIATELY FLAG these issues:**
            - Hardcoded passwords, API keys, or secrets
            - SQL queries without parameterization
            - User input used without validation
            - Missing authorization checks
            - Sensitive data in logs
            - Weak encryption or hashing
            - Missing rate limiting on sensitive endpoints

            ### üìã REVIEW OUTPUT

            For each security concern:
            1. **Severity Level** (Critical/High/Medium/Low)
            2. **Specific Location** (file:line)
            3. **Security Risk** (what could go wrong)
            4. **Recommended Fix** (how to address it)
            5. **Code Example** (if applicable)

            **DO NOT APPROVE** this PR if any Critical or High severity security issues are found.

            Provide detailed inline comments for security issues and a comprehensive security assessment in the main PR comment.

          claude_args: |
            --allowedTools "Read,Glob,Grep,Task,mcp__github_inline_comment__*,mcp__github_pr_comment__*"