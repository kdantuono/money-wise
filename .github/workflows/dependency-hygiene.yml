name: üßπ Dependency Hygiene

on:
  schedule:
    # Weekly on Monday at 2 AM UTC
    - cron: '0 2 * * MON'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force dependency updates'
        required: false
        default: 'false'
        type: boolean

jobs:
  dependency-audit:
    name: üîç Dependency Security & Compliance
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js with Resilient Cache
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
        continue-on-error: true

      - name: üîß Cache Resilience Check
        run: |
          echo "## üóÑÔ∏è Cache Health Verification" >> $GITHUB_STEP_SUMMARY

          # Validate cache health before proceeding
          npm run validate:cache || {
            echo "‚ö†Ô∏è Cache validation failed - attempting recovery" >> $GITHUB_STEP_SUMMARY
            npm run cache:clean
            echo "üîß Cache recovered successfully" >> $GITHUB_STEP_SUMMARY
          }

      - name: üîç Lockfile Integrity Check
        run: |
          echo "## üîí Lockfile Integrity Validation" >> $GITHUB_STEP_SUMMARY
          npm run validate:lockfile || {
            echo "‚ùå Lockfile integrity check failed!" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm install\` to regenerate lockfile" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "‚úÖ Lockfile integrity validated" >> $GITHUB_STEP_SUMMARY

      - name: üì• Install dependencies
        run: npm ci

      - name: üîí Security Audit
        run: |
          echo "## üîç Security Audit Results" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level moderate || {
            echo "‚ùå Security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm audit fix\` to resolve issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "‚úÖ No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY

      - name: üìä Dependency Analysis
        run: |
          echo "## üìä Dependency Analysis" >> $GITHUB_STEP_SUMMARY

          # Check for outdated packages
          echo "### Outdated Packages" >> $GITHUB_STEP_SUMMARY
          outdated_count=$(npm outdated --parseable | wc -l)
          if [ $outdated_count -gt 0 ]; then
            echo "üì¶ Found $outdated_count outdated packages:" >> $GITHUB_STEP_SUMMARY
            npm outdated --parseable | head -10 | while read line; do
              echo "- $line" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "‚úÖ All dependencies are up to date" >> $GITHUB_STEP_SUMMARY
          fi

          # Create bundle-analysis directory if it doesn't exist
          mkdir -p bundle-analysis

          # Generate dependency analysis
          npm run analyze:deps

      - name: üè∑Ô∏è License Compliance Check
        run: |
          echo "## üè∑Ô∏è License Compliance" >> $GITHUB_STEP_SUMMARY
          npm install -g license-checker

          # Check for allowed licenses only
          license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;Unlicense' --production || {
            echo "‚ùå License compliance issues found!" >> $GITHUB_STEP_SUMMARY
            echo "Review dependencies with non-standard licenses" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "‚úÖ All dependencies use approved licenses" >> $GITHUB_STEP_SUMMARY

      - name: üìà Dependency Size Impact
        run: |
          echo "## üìà Dependency Impact" >> $GITHUB_STEP_SUMMARY

          # Count total dependencies
          total_deps=$(npm ls --depth=0 --json | jq '.dependencies | length')
          echo "üì¶ Total dependencies: $total_deps" >> $GITHUB_STEP_SUMMARY

          # Check node_modules size
          if [ -d "node_modules" ]; then
            size=$(du -sh node_modules | cut -f1)
            echo "üíæ Node modules size: $size" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üö® Create Issue for Critical Issues
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Dependency Hygiene Issues Found';
            const body = `
            ## Dependency Hygiene Scan Results

            ‚ùå **Critical issues found during automated dependency scan**

            ### Issues Detected:
            - Security vulnerabilities requiring attention
            - License compliance violations
            - Outdated dependencies needing updates

            ### Action Required:
            1. Review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. Address security vulnerabilities with \`npm audit fix\`
            3. Update outdated dependencies as appropriate
            4. Verify license compliance for new dependencies

            ### Automation Details:
            - **Workflow**: Dependency Hygiene
            - **Trigger**: ${context.eventName}
            - **Run ID**: ${context.runId}
            - **Date**: ${new Date().toISOString()}

            This issue was created automatically by the dependency hygiene workflow.
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'security', 'automation']
            });