name: Monitoring & Observability

on:
  deployment_status:
  workflow_run:
    workflows: ["Deploy to Staging", "Deploy to Production"]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

jobs:
  deployment-notification:
    name: üì° Deployment Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'

    steps:
      - name: üì° Notify deployment to monitoring
        run: |
          echo "üì° Deployment notification for ${{ github.event.deployment.environment }}"
          
          DEPLOYMENT_DATA=$(cat <<EOF
          {
            "environment": "${{ github.event.deployment.environment }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "deployment_id": "${{ github.event.deployment.id }}",
            "actor": "${{ github.actor }}"
          }
          EOF
          )
          
          echo "üìã Deployment data: $DEPLOYMENT_DATA"
          
          # Send to monitoring webhook (when configured)
          if [ -n "${{ secrets.MONITORING_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.MONITORING_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d "$DEPLOYMENT_DATA"
            echo "‚úÖ Deployment notification sent to monitoring webhook"
          else
            echo "‚ö†Ô∏è MONITORING_WEBHOOK not configured"
          fi

  sentry-release:
    name: üìä Sentry Release
    runs-on: ubuntu-latest
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Create Sentry release
        if: env.SENTRY_ORG != '' && env.SENTRY_AUTH_TOKEN != ''
        run: |
          # Install Sentry CLI
          curl -sL https://sentry.io/get-cli/ | bash
          
          # Create release
          RELEASE_VERSION="${{ github.sha }}"
          ENVIRONMENT="${{ github.event.deployment.environment }}"
          
          echo "üìä Creating Sentry release: $RELEASE_VERSION for $ENVIRONMENT"
          
          sentry-cli releases new "$RELEASE_VERSION"
          sentry-cli releases set-commits "$RELEASE_VERSION" --auto
          sentry-cli releases deploy "$RELEASE_VERSION" --env "$ENVIRONMENT"
          sentry-cli releases finalize "$RELEASE_VERSION"
          
          echo "‚úÖ Sentry release created and deployed"

  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'

    steps:
      - name: üè• Wait for deployment to be ready
        run: |
          echo "‚è≥ Waiting for deployment to be ready..."
          sleep 30

      - name: üè• Check application health
        run: |
          ENVIRONMENT="${{ github.event.deployment.environment }}"
          
          # Health check URLs based on environment
          if [ "$ENVIRONMENT" = "production" ]; then
            HEALTH_URL="${{ secrets.PRODUCTION_HEALTH_URL }}"
          elif [ "$ENVIRONMENT" = "staging" ]; then
            HEALTH_URL="${{ secrets.STAGING_HEALTH_URL }}"
          else
            echo "‚ö†Ô∏è Unknown environment: $ENVIRONMENT"
            exit 0
          fi
          
          if [ -z "$HEALTH_URL" ]; then
            echo "‚ö†Ô∏è Health URL not configured for $ENVIRONMENT"
            exit 0
          fi
          
          echo "üè• Checking health at: $HEALTH_URL"
          
          # Retry health check up to 5 times
          for i in {1..5}; do
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "‚úÖ Health check passed (attempt $i)"
              break
            else
              echo "‚ùå Health check failed (attempt $i/5)"
              if [ $i -eq 5 ]; then
                echo "üö® Health check failed after 5 attempts"
                exit 1
              fi
              sleep 10
            fi
          done

  performance-baseline:
    name: üìà Performance Baseline
    runs-on: ubuntu-latest
    needs: health-check
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'

    steps:
      - name: üìà Collect performance baseline
        run: |
          ENVIRONMENT="${{ github.event.deployment.environment }}"
          
          # Performance test URLs based on environment
          if [ "$ENVIRONMENT" = "production" ]; then
            BASE_URL="${{ secrets.PRODUCTION_BASE_URL }}"
          elif [ "$ENVIRONMENT" = "staging" ]; then
            BASE_URL="${{ secrets.STAGING_BASE_URL }}"
          else
            echo "‚ö†Ô∏è Unknown environment: $ENVIRONMENT"
            exit 0
          fi
          
          if [ -z "$BASE_URL" ]; then
            echo "‚ö†Ô∏è Base URL not configured for $ENVIRONMENT"
            exit 0
          fi
          
          echo "üìà Collecting performance baseline for: $BASE_URL"
          
          # Simple performance check using curl
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$BASE_URL" || echo "0")
          
          echo "üìä Response time: ${RESPONSE_TIME}s"
          
          # Alert if response time is too slow (> 3 seconds)
          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "‚ö†Ô∏è Slow response time detected: ${RESPONSE_TIME}s"
          else
            echo "‚úÖ Response time within acceptable range: ${RESPONSE_TIME}s"
          fi

  error-rate-monitoring:
    name: üìä Error Rate Monitoring
    runs-on: ubuntu-latest
    needs: health-check
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'

    steps:
      - name: üìä Monitor error rate
        run: |
          echo "üìä Monitoring error rate for 5 minutes post-deployment..."
          
          ENVIRONMENT="${{ github.event.deployment.environment }}"
          START_TIME=$(date +%s)
          DURATION=300  # 5 minutes
          
          while [ $(($(date +%s) - START_TIME)) -lt $DURATION ]; do
            # In a real scenario, this would query your monitoring system
            # For now, we'll simulate monitoring
            echo "üîç Checking error rate... (mock)"
            
            # Simulate error rate check
            ERROR_RATE="0.1"  # Mock 0.1% error rate
            
            if (( $(echo "$ERROR_RATE > 5.0" | bc -l) )); then
              echo "üö® High error rate detected: ${ERROR_RATE}%"
              # In production, this would trigger alerts
              break
            else
              echo "‚úÖ Error rate normal: ${ERROR_RATE}%"
            fi
            
            sleep 60  # Check every minute
          done
          
          echo "‚úÖ Error rate monitoring completed"

  custom-alerts:
    name: üö® Custom Alerts
    runs-on: ubuntu-latest
    needs: [performance-baseline, error-rate-monitoring]
    if: always() && github.event_name == 'deployment_status'

    steps:
      - name: üö® Process alerts
        run: |
          echo "üö® Processing custom alerts..."
          
          PERFORMANCE_STATUS="${{ needs.performance-baseline.result }}"
          ERROR_MONITORING_STATUS="${{ needs.error-rate-monitoring.result }}"
          
          if [ "$PERFORMANCE_STATUS" != "success" ] || [ "$ERROR_MONITORING_STATUS" != "success" ]; then
            echo "‚ö†Ô∏è Post-deployment monitoring detected issues"
            
            ALERT_DATA=$(cat <<EOF
          {
            "environment": "${{ github.event.deployment.environment }}",
            "commit": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "performance_status": "$PERFORMANCE_STATUS",
            "error_monitoring_status": "$ERROR_MONITORING_STATUS",
            "alert_type": "post_deployment_monitoring"
          }
          EOF
            )
            
            echo "üö® Alert data: $ALERT_DATA"
            
            # Send alert (when webhook configured)
            if [ -n "${{ secrets.ALERT_WEBHOOK }}" ]; then
              curl -X POST "${{ secrets.ALERT_WEBHOOK }}" \
                -H "Content-Type: application/json" \
                -d "$ALERT_DATA"
              echo "‚úÖ Alert sent to webhook"
            else
              echo "‚ö†Ô∏è ALERT_WEBHOOK not configured"
            fi
          else
            echo "‚úÖ All post-deployment checks passed"
          fi

  monitoring-summary:
    name: üìã Monitoring Summary
    runs-on: ubuntu-latest
    needs: [deployment-notification, sentry-release, health-check, performance-baseline, error-rate-monitoring, custom-alerts]
    if: always()

    steps:
      - name: üìã Monitoring results summary
        run: |
          echo "üìã Monitoring Pipeline Summary"
          echo "=============================="
          echo "üì° Deployment Notification: ${{ needs.deployment-notification.result || 'skipped' }}"
          echo "üìä Sentry Release: ${{ needs.sentry-release.result || 'skipped' }}"
          echo "üè• Health Check: ${{ needs.health-check.result || 'skipped' }}"
          echo "üìà Performance Baseline: ${{ needs.performance-baseline.result || 'skipped' }}"
          echo "üìä Error Rate Monitoring: ${{ needs.error-rate-monitoring.result || 'skipped' }}"
          echo "üö® Custom Alerts: ${{ needs.custom-alerts.result || 'skipped' }}"
          echo ""
          
          if [[ "${{ needs.health-check.result }}" == "success" ]]; then
            echo "‚úÖ Post-deployment monitoring completed successfully"
          else
            echo "‚ö†Ô∏è Some monitoring checks failed or were skipped"
          fi