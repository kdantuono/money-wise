name: ðŸ›¡ï¸ Master Branch Protection & Production Deploy

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

env:
  NODE_VERSION: '18'
  PRODUCTION_URL: 'https://app.moneywise.com'

jobs:
  # ================================
  # ULTRA-STRICT PRODUCTION VALIDATION
  # ================================
  production-readiness-check:
    name: ðŸŽ¯ Production Readiness Validation
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci
          cd packages/types && npm run build

      - name: ðŸ” Verify Develop Branch Integration
        run: |
          # Ensure this PR comes from develop branch
          if [[ "${{ github.head_ref }}" != "develop" ]]; then
            echo "âŒ ERROR: Pull requests to main must come from develop branch only"
            exit 1
          fi
          echo "âœ… PR correctly originates from develop branch"

      - name: ðŸ“Š Quality Gate Validation
        run: |
          echo "ðŸ” Running comprehensive quality validation..."

          # Code coverage must be >= 85% for production
          COVERAGE=$(npm run test:coverage --silent | grep "All files" | awk '{print $10}' | sed 's/%//')
          if [ "${COVERAGE%.*}" -lt 85 ]; then
            echo "âŒ Code coverage $COVERAGE% below required 85%"
            exit 1
          fi
          echo "âœ… Code coverage: $COVERAGE%"

          # Zero TypeScript errors
          npm run type-check
          echo "âœ… TypeScript validation passed"

          # Zero linting errors
          npm run lint
          echo "âœ… Linting validation passed"

      - name: ðŸ›¡ï¸ Security Validation
        run: |
          echo "ðŸ›¡ï¸ Running production security checks..."

          # High-severity vulnerability check
          npm audit --audit-level high
          echo "âœ… No high-severity vulnerabilities"

          # Secret scanning
          if grep -r "password\|secret\|key" --include="*.ts" --include="*.js" . | grep -v node_modules | grep -v test; then
            echo "âŒ Potential secrets found in code"
            exit 1
          fi
          echo "âœ… No hardcoded secrets detected"

      - name: ðŸš€ Performance Validation
        run: |
          echo "âš¡ Running production performance validation..."

          # Build for production
          npm run build

          # Performance budget check
          npm run budget:check
          echo "âœ… Performance budgets met"

      - name: ðŸŽ­ End-to-End Production Simulation
        run: |
          echo "ðŸŽª Running production-like E2E tests..."

          # Start services in production mode
          docker-compose -f docker-compose.prod.yml up -d --build

          # Wait for services to be ready
          timeout 60 bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done'

          # Run E2E tests against production build
          npm run test:e2e:prod

          # Cleanup
          docker-compose -f docker-compose.prod.yml down
          echo "âœ… Production E2E tests passed"

  # ================================
  # COMPLIANCE & DOCUMENTATION CHECK
  # ================================
  compliance-validation:
    name: ðŸ“‹ Compliance & Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“š Documentation Validation
        run: |
          echo "ðŸ“š Validating documentation completeness..."

          # Check for required documentation files
          required_docs=("README.md" "CHANGELOG.md" "AGENT_ORCHESTRATION_WORKFLOW.md")
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ Missing required documentation: $doc"
              exit 1
            fi
          done
          echo "âœ… All required documentation present"

      - name: ðŸ·ï¸ Version Tag Validation
        run: |
          echo "ðŸ·ï¸ Validating semantic versioning..."

          # Check if version has been updated
          current_version=$(cat package.json | jq -r '.version')
          echo "Current version: $current_version"

          # Validate semantic version format
          if [[ ! $current_version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid semantic version format: $current_version"
            exit 1
          fi
          echo "âœ… Valid semantic version format"

      - name: ðŸ“ Changelog Validation
        run: |
          echo "ðŸ“ Validating changelog updates..."

          # Check if CHANGELOG.md has been updated
          if ! git diff HEAD~1 --name-only | grep -q "CHANGELOG.md"; then
            echo "âŒ CHANGELOG.md not updated for this release"
            exit 1
          fi
          echo "âœ… Changelog updated"

  # ================================
  # MANUAL APPROVAL GATE
  # ================================
  manual-approval:
    name: ðŸ‘¥ Technical Lead Approval
    runs-on: ubuntu-latest
    needs: [production-readiness-check, compliance-validation]
    environment: production-approval

    steps:
      - name: â³ Waiting for Manual Approval
        run: |
          echo "â³ Waiting for technical lead approval..."
          echo "This job requires manual approval to proceed with production deployment"

  # ================================
  # PRODUCTION DEPLOYMENT
  # ================================
  production-deployment:
    name: ðŸš€ Production Deployment
    runs-on: ubuntu-latest
    needs: manual-approval
    environment: production

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ—ï¸ Production Build
        run: |
          npm ci
          cd packages/types && npm run build
          npm run build
        env:
          NODE_ENV: production

      - name: ðŸ³ Deploy to Production
        run: |
          echo "ðŸš€ Deploying to production..."
          # Add production deployment logic here
          # Could use AWS ECS, Kubernetes, Docker Swarm, etc.

      - name: ðŸ” Production Health Check
        run: |
          echo "ðŸ” Running production health checks..."

          # Wait for deployment to complete
          sleep 30

          # Health check
          curl -f ${{ env.PRODUCTION_URL }}/health

          # Basic functionality test
          curl -f ${{ env.PRODUCTION_URL }}/api/status

          echo "âœ… Production deployment successful"

      - name: ðŸ“Š Post-Deployment Monitoring
        run: |
          echo "ðŸ“Š Starting post-deployment monitoring..."

          # Monitor for errors in first 5 minutes
          for i in {1..5}; do
            sleep 60
            curl -f ${{ env.PRODUCTION_URL }}/health
            echo "Health check $i/5 passed"
          done

          echo "âœ… Post-deployment monitoring successful"

      - name: ðŸ·ï¸ Create Release Tag
        run: |
          version=$(cat package.json | jq -r '.version')
          git tag -a "v$version" -m "Production release v$version"
          git push origin "v$version"
          echo "âœ… Release tag v$version created"

  # ================================
  # ROLLBACK CAPABILITY
  # ================================
  rollback-preparation:
    name: ðŸ”„ Rollback Preparation
    runs-on: ubuntu-latest
    needs: production-deployment
    if: failure()

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”„ Prepare Rollback
        run: |
          echo "ðŸ”„ Preparing rollback to previous stable version..."

          # Get previous stable tag
          previous_tag=$(git tag | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -2 | head -1)
          echo "Previous stable version: $previous_tag"

          # Create rollback script
          cat > rollback.sh << EOF
          #!/bin/bash
          echo "Rolling back to $previous_tag"
          git checkout $previous_tag
          # Add rollback deployment commands here
          EOF

          chmod +x rollback.sh
          echo "âœ… Rollback script prepared"

  # ================================
  # NOTIFICATIONS & REPORTING
  # ================================
  production-notifications:
    name: ðŸ“¢ Production Notifications
    runs-on: ubuntu-latest
    needs: production-deployment
    if: always()

    steps:
      - name: ðŸ“Š Deployment Report
        run: |
          if [ "${{ needs.production-deployment.result }}" == "success" ]; then
            echo "âœ… Production deployment successful"
            status="success"
            color="good"
          else
            echo "âŒ Production deployment failed"
            status="failed"
            color="danger"
          fi

      - name: ðŸ’¬ Slack Notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: custom
          custom_payload: |
            {
              "channel": "#moneywise-production",
              "attachments": [{
                "color": "${{ needs.production-deployment.result == 'success' && 'good' || 'danger' }}",
                "title": "ðŸš€ Production Deployment ${{ needs.production-deployment.result == 'success' && 'Successful' || 'Failed' }}",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Version",
                    "value": "$(cat package.json | jq -r '.version')",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${{ github.actor }}",
                    "short": true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: ðŸ“§ Email Notification
        if: failure()
        run: |
          echo "ðŸ“§ Sending failure notification to technical leads..."
          # Add email notification logic here