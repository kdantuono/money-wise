name: Auto Fix CI Failures

on:
  workflow_run:
    workflows: ['CI/CD Pipeline'] # Name of your main CI workflow
    types:
      - completed

jobs:
  auto-fix-ci:
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.pull_requests[0] &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-ci-')
    permissions:
      contents: write
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name "claude-bot"
          git config --global user.email "claude-bot@users.noreply.github.com"

      - name: Create fix branch
        id: create-branch
        run: |
          original_branch="${{ github.event.workflow_run.head_branch }}"
          fix_branch="claude-auto-fix-ci-${original_branch}-$(date +%s)"
          git checkout -b "$fix_branch" origin/"$original_branch"
          echo "fix_branch=$fix_branch" >> $GITHUB_OUTPUT
          echo "original_branch=$original_branch" >> $GITHUB_OUTPUT

      - name: Get CI failure details
        id: ci-details
        uses: actions/github-script@v7
        with:
          script: |
            const workflow_run_id = context.payload.workflow_run.id;
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: workflow_run_id
            });

            const failedJobs = jobs.jobs.filter(job => job.conclusion === 'failure');
            const failureDetails = failedJobs.map(job => ({
              name: job.name,
              logs_url: job.logs_url,
              steps: job.steps.filter(step => step.conclusion === 'failure')
            }));

            return { failed_jobs: failureDetails };

      - name: Run Claude Code to fix CI failures
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            URGENT: CI Pipeline Failed - Auto-Fix Required

            Repository: ${{ github.repository }}
            Branch: ${{ steps.create-branch.outputs.original_branch }}
            Failed Workflow: ${{ github.event.workflow_run.name }}
            Run ID: ${{ github.event.workflow_run.id }}

            CI FAILURE DETAILS:
            ${{ fromJson(steps.ci-details.outputs.result).failed_jobs }}

            Your task is to analyze and fix the CI failures:

            1. Examine the failed jobs and their error logs
            2. Identify the root cause of each failure
            3. Implement the necessary fixes:
               - Fix linting errors
               - Fix TypeScript compilation errors
               - Fix failing tests
               - Fix build failures
               - Fix Docker/deployment issues
            4. Ensure all fixes follow MoneyWise coding standards
            5. Run the relevant commands to verify fixes

            CRITICAL REQUIREMENTS:
            - Only make changes that fix the CI failures
            - Preserve existing functionality
            - Follow the project's architectural patterns
            - Maintain test coverage
            - Update documentation if needed

            After making fixes, commit your changes with a descriptive message.

          claude_args: |
            --allowedTools "Read,Write,Edit,MultiEdit,Bash(npm:*),Bash(docker-compose:*),Bash(git:*),Glob,Grep,Task"

      - name: Create pull request for fixes
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– Auto-fix CI failures for ${context.payload.workflow_run.head_branch}`,
              head: '${{ steps.create-branch.outputs.fix_branch }}',
              base: '${{ steps.create-branch.outputs.original_branch }}',
              body: `
                ## Auto-generated CI Fix

                This PR was automatically created by Claude to fix CI failures in the pipeline.

                **Original failed workflow:** ${{ github.event.workflow_run.name }}
                **Run ID:** ${{ github.event.workflow_run.id }}
                **Original branch:** ${{ steps.create-branch.outputs.original_branch }}

                ### Changes Made
                Claude analyzed the CI failures and implemented fixes for:
                - Linting errors
                - TypeScript compilation issues
                - Test failures
                - Build/deployment issues

                Please review the changes before merging.

                ---
                ðŸ¤– Generated with Claude Code Action
              `
            });

            // Add label to the PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['auto-fix', 'ci-failure', 'claude-generated']
            });
