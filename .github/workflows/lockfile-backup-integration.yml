name: Lockfile Backup Integration

on:
  workflow_run:
    workflows: ["CI", "Build", "Test"]
    types:
      - completed
    branches:
      - main
      - develop

  push:
    branches:
      - main
      - develop
    paths:
      - 'package-lock.json'

  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup to create'
        required: false
        default: 'manual'
        type: choice
        options:
          - manual
          - auto
          - success

permissions:
  contents: write

jobs:
  backup-on-success:
    name: Create Success Backup
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ” Pre-Backup Validation
        id: validation
        run: |
          echo "ğŸ” Validating lockfile before backup..."

          # Check if lockfile exists and is valid
          if [[ ! -f "package-lock.json" ]]; then
            echo "âŒ No package-lock.json found"
            echo "should_backup=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Validate JSON syntax
          if ! jq . package-lock.json > /dev/null 2>&1; then
            echo "âŒ package-lock.json has invalid JSON"
            echo "should_backup=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Test installation to ensure lockfile is working
          echo "ğŸ§ª Testing installation with current lockfile..."
          if npm ci --dry-run > /dev/null 2>&1; then
            echo "âœ… Lockfile validation passed"
            echo "should_backup=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Installation test failed"
            echo "should_backup=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Create Backup
        if: steps.validation.outputs.should_backup == 'true'
        run: |
          echo "ğŸ’¾ Creating backup using backup manager..."

          # Make backup script executable
          chmod +x scripts/lockfile-backup-manager.js

          # Determine backup type
          backup_type="auto"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            backup_type="${{ inputs.backup_type }}"
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            backup_type="success"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            backup_type="auto"
          fi

          echo "ğŸ“‹ Backup type: $backup_type"

          # Create backup with metadata
          node scripts/lockfile-backup-manager.js create "$backup_type"

      - name: ğŸ“Š Backup Health Check
        if: steps.validation.outputs.should_backup == 'true'
        run: |
          echo "ğŸ“Š Performing backup health check..."

          # Generate health report
          node scripts/lockfile-backup-manager.js health > backup-health-report.json

          # Display summary
          echo "ğŸ“ˆ Backup Health Summary:"
          jq -r '.backup_summary' backup-health-report.json

          # Check if we have enough valid backups
          valid_backups=$(jq -r '.backup_summary.valid_backups' backup-health-report.json)
          total_backups=$(jq -r '.backup_summary.total_backups' backup-health-report.json)

          echo "âœ… Valid backups: $valid_backups/$total_backups"

          if [[ "$valid_backups" -ge 3 ]]; then
            echo "ğŸ¯ Healthy backup coverage maintained"
          else
            echo "âš ï¸ Warning: Less than 3 valid backups available"
          fi

      - name: ğŸ§¹ Cleanup Old Backups
        if: steps.validation.outputs.should_backup == 'true'
        run: |
          echo "ğŸ§¹ Cleaning up old backups..."
          node scripts/lockfile-backup-manager.js cleanup

      - name: ğŸ“‚ Commit Backup Updates
        if: steps.validation.outputs.should_backup == 'true'
        run: |
          echo "ğŸ“‚ Committing backup updates to repository..."

          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add backup files
          git add .lockfile-backups/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No backup changes to commit"
          else
            # Create commit
            backup_count=$(find .lockfile-backups -mindepth 1 -maxdepth 1 -type d | wc -l)
            git commit -m "chore(backup): update lockfile backups

            - Automated backup creation from CI workflow
            - Total backups maintained: $backup_count
            - Backup type: ${{ github.event_name == 'workflow_dispatch' && inputs.backup_type || github.event.workflow_run.conclusion == 'success' && 'success' || 'auto' }}
            - Triggered by: ${{ github.event_name }}

            ğŸ¤– Generated with Claude Code

            Co-Authored-By: Claude <noreply@anthropic.com>"

            # Push changes
            git push

            echo "âœ… Backup updates committed and pushed"
          fi

      - name: ğŸ“ˆ Update Backup Metrics
        if: always()
        run: |
          echo "ğŸ“ˆ Recording backup metrics..."

          # Create metrics directory if it doesn't exist
          mkdir -p .github/metrics

          # Generate current metrics
          cat > .github/metrics/backup-metrics.json << EOF
          {
            "timestamp": "$(date -u '+%Y-%m-%dT%H:%M:%S.%3NZ')",
            "workflow_run": "${{ github.run_id }}",
            "trigger_event": "${{ github.event_name }}",
            "branch": "${{ github.ref_name }}",
            "commit_sha": "${{ github.sha }}",
            "backup_created": ${{ steps.validation.outputs.should_backup == 'true' }},
            "backup_type": "${{ github.event_name == 'workflow_dispatch' && inputs.backup_type || github.event.workflow_run.conclusion == 'success' && 'success' || 'auto' }}",
            "validation_passed": ${{ steps.validation.outputs.should_backup == 'true' }}
          }
          EOF

          echo "âœ… Backup metrics updated"

      - name: ğŸš¨ Alert on Backup Failure
        if: failure() && steps.validation.outputs.should_backup == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Lockfile Backup Creation Failed',
              body: `# ğŸš¨ Lockfile Backup Creation Failed

            **Workflow Run**: ${{ github.run_id }}
            **Trigger Event**: ${{ github.event_name }}
            **Branch**: ${{ github.ref_name }}
            **Commit**: ${{ github.sha }}
            **Timestamp**: ${new Date().toISOString()}

            ## ğŸ“‹ Details

            The automated lockfile backup creation failed during the CI workflow.
            This may indicate issues with the backup system or file permissions.

            ## ğŸ› ï¸ Recommended Actions

            1. Check the workflow logs for specific error details
            2. Verify backup directory permissions
            3. Ensure lockfile-backup-manager.js is executable
            4. Manually create a backup if the current lockfile is valid
            5. Consider running backup health check

            ## ğŸ”— Related Links

            - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Backup Manager Script](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/scripts/lockfile-backup-manager.js)

            ## âš¡ Quick Recovery

            If the current lockfile is valid, you can manually create a backup:
            \`\`\`bash
            node scripts/lockfile-backup-manager.js create manual
            \`\`\`
            `,
              labels: ['backup', 'failure', 'automation']
            });

      - name: ğŸ“Š Final Status Report
        if: always()
        run: |
          echo "ğŸ“Š LOCKFILE BACKUP INTEGRATION FINAL REPORT"
          echo "============================================="
          echo "ğŸ¯ **Event**: ${{ github.event_name }}"
          echo "ğŸ”§ **Should Backup**: ${{ steps.validation.outputs.should_backup }}"
          echo "ğŸ“¦ **Backup Type**: ${{ github.event_name == 'workflow_dispatch' && inputs.backup_type || github.event.workflow_run.conclusion == 'success' && 'success' || 'auto' }}"
          echo "â° **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          if [[ "${{ steps.validation.outputs.should_backup }}" == "true" ]]; then
            echo "::notice title=Backup Created::Lockfile backup successfully created and managed"
          else
            echo "::warning title=Backup Skipped::Lockfile backup skipped due to validation failure"
          fi

  backup-status-check:
    name: Backup Status Check
    runs-on: ubuntu-latest
    needs: backup-on-success
    if: always()

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“Š Generate Backup Status Report
        run: |
          echo "ğŸ“Š Generating comprehensive backup status report..."

          # Make script executable
          chmod +x scripts/lockfile-backup-manager.js

          # Generate health report
          if node scripts/lockfile-backup-manager.js health > full-backup-report.json 2>/dev/null; then
            echo "âœ… Backup system operational"

            # Extract key metrics
            total_backups=$(jq -r '.backup_summary.total_backups' full-backup-report.json)
            valid_backups=$(jq -r '.backup_summary.valid_backups' full-backup-report.json)
            current_valid=$(jq -r '.current_lockfile.valid' full-backup-report.json)

            echo "ğŸ“ˆ **Backup Metrics**:"
            echo "   Total Backups: $total_backups"
            echo "   Valid Backups: $valid_backups"
            echo "   Current Lockfile: $([ "$current_valid" == "true" ] && echo "âœ… Valid" || echo "âŒ Invalid")"

            # Check backup coverage
            if [[ "$valid_backups" -ge 3 ]]; then
              echo "::notice title=Healthy Backup Coverage::$valid_backups valid backups available"
            elif [[ "$valid_backups" -ge 1 ]]; then
              echo "::warning title=Low Backup Coverage::Only $valid_backups valid backups available"
            else
              echo "::error title=No Valid Backups::No valid backups available for emergency restoration"
            fi

          else
            echo "âŒ Backup system check failed"
            echo "::error title=Backup System Error::Could not generate backup status report"
          fi