name: ğŸ”’ Lockfile Integrity Monitor

on:
  push:
    branches: [main]
    paths:
      - 'package-lock.json'
      - 'package.json'
      - 'apps/*/package.json'
      - 'packages/*/package.json'
  pull_request:
    branches: [main]
    paths:
      - 'package-lock.json'
      - 'package.json'
      - 'apps/*/package.json'
      - 'packages/*/package.json'
  schedule:
    # Daily at 1 AM UTC - validate lockfile integrity
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  lockfile-integrity:
    name: ğŸ” Lockfile Integrity Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          # Don't use npm cache for integrity checks
          cache: false

      - name: ğŸ”’ Comprehensive Lockfile Validation
        run: |
          echo "## ğŸ” Lockfile Integrity Analysis" >> $GITHUB_STEP_SUMMARY

          # Run comprehensive validation
          npm run validate:lockfile || {
            echo "âŒ **Critical lockfile integrity failure!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸš¨ Immediate Actions Required:" >> $GITHUB_STEP_SUMMARY
            echo "1. \`npm install\` to regenerate lockfile" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify no unauthorized dependency changes" >> $GITHUB_STEP_SUMMARY
            echo "3. Test application functionality" >> $GITHUB_STEP_SUMMARY
            echo "4. Commit regenerated lockfile if valid" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

          echo "âœ… **Lockfile integrity validated successfully**" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“Š Generate Lockfile Health Report
        run: |
          echo "## ğŸ“Š Lockfile Health Report" >> $GITHUB_STEP_SUMMARY
          npm run lockfile:report || echo "âš ï¸ Health report generation failed" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Dependency Consistency Check
        run: |
          echo "## ğŸ”— Dependency Consistency" >> $GITHUB_STEP_SUMMARY

          # Test npm ci to ensure lockfile works correctly
          npm ci --dry-run || {
            echo "âŒ npm ci dry-run failed - lockfile inconsistent with package.json" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

          echo "âœ… npm ci dry-run successful - dependencies consistent" >> $GITHUB_STEP_SUMMARY

      - name: âš¡ Performance Impact Analysis
        if: github.event_name == 'pull_request'
        run: |
          echo "## âš¡ Performance Impact Analysis" >> $GITHUB_STEP_SUMMARY

          # Check if lockfile size changed significantly
          if [ -f "package-lock.json" ]; then
            lockfile_size=$(wc -c < package-lock.json)
            echo "ğŸ“¦ Current lockfile size: $lockfile_size bytes" >> $GITHUB_STEP_SUMMARY

            # Warn if lockfile is unusually large (>2MB suggests issues)
            if [ $lockfile_size -gt 2097152 ]; then
              echo "âš ï¸ **Large lockfile detected** - consider dependency audit" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ğŸš¨ Create Critical Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸš¨ Critical Lockfile Integrity Failure';
            const body = `
            ## ğŸ”’ Lockfile Integrity Monitor Alert

            âŒ **Critical lockfile integrity failure detected**

            ### ğŸš¨ Immediate Action Required:

            The automated lockfile integrity monitor has detected corruption or inconsistencies
            that could break CI/CD pipelines and development environments.

            ### ğŸ“‹ Resolution Steps:

            1. **Immediate**: Run \`npm install\` to regenerate lockfile
            2. **Verify**: Ensure no unauthorized dependency changes
            3. **Test**: Verify application functionality after regeneration
            4. **Commit**: Push regenerated lockfile if validation passes
            5. **Monitor**: Watch CI/CD pipelines for resolution

            ### ğŸ” Technical Details:

            - **Workflow**: Lockfile Integrity Monitor
            - **Trigger**: ${context.eventName}
            - **Branch**: ${context.ref}
            - **Run ID**: ${context.runId}
            - **Timestamp**: ${new Date().toISOString()}

            ### ğŸ›¡ï¸ Prevention:

            This monitoring system will now prevent future lockfile corruption from
            breaking CI/CD pipelines by validating integrity before installation.

            ---
            *This issue was created automatically by the lockfile integrity monitoring system.*
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['critical', 'dependencies', 'infrastructure', 'automation'],
              assignees: ['kdantuono']
            });