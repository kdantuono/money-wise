
> @money-wise/backend@0.4.1 test:unit /home/nemesi/dev/money-wise/apps/backend
> jest --passWithNoTests --testPathPattern='__tests__/unit'

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:24 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError setting up 2FA:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:24 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mBadRequestException: User not found[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:24 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError setting up 2FA:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:24 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: QR generation failed[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA setup:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError disabling 2FA:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Failed to verify two-factor authentication[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError checking 2FA status:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError generating new backup codes:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: ECONNREFUSED: Redis connection refused[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA setup:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:25 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mSyntaxError: Unexpected token 'i', "invalid-json{{{" is not valid JSON[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:27 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError generating new backup codes:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:27 AM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis write failed[39m
FAIL @money-wise/backend __tests__/unit/auth/services/two-factor-auth.service.spec.ts (9.744 s)
  TwoFactorAuthService
    setupTwoFactor
      ‚úì should generate 2FA setup with secret, QR code, and backup codes (22 ms)
      ‚úì should throw error if user not found (33 ms)
      ‚úì should throw error if QR code generation fails (5 ms)
      ‚úì should store setup data with 10-minute expiration (7 ms)
      ‚úì should generate unique backup codes (4 ms)
    verifyAndEnable2FA
      ‚úì should enable 2FA with valid token (9 ms)
      ‚úì should throw error for invalid token (6 ms)
      ‚úì should throw error if setup data not found (4 ms)
      ‚úì should throw error if setup data expired (1129 ms)
      ‚úì should handle Redis errors gracefully (5 ms)
    verifyTwoFactor
      ‚úì should verify valid TOTP token (4 ms)
      ‚úì should verify valid backup code when TOTP fails (4 ms)
      ‚úì should throw error for already used backup code (4 ms)
      ‚úì should throw error for invalid token and backup code (4 ms)
      ‚úì should throw error if 2FA not enabled (4 ms)
      ‚úì should handle Redis errors gracefully (9 ms)
    disable2FA
      ‚úì should disable 2FA with valid token (4 ms)
      ‚úì should throw error for invalid token when disabling (4 ms)
      ‚úì should handle Redis errors gracefully (4 ms)
    is2FAEnabled
      ‚úì should return true if 2FA is enabled (6 ms)
      ‚úì should return false if 2FA is not enabled (3 ms)
      ‚úì should return false on Redis errors (2 ms)
    generateNewBackupCodes
      ‚úì should generate new backup codes with valid token (3 ms)
      ‚úì should throw error for invalid token when generating new codes (3 ms)
      ‚úì should throw error if 2FA not enabled (2 ms)
      ‚úì should handle Redis errors gracefully (3 ms)
    onModuleDestroy
      ‚úì should close Redis connection on module destroy (6 ms)
    Edge Cases and Advanced Scenarios
      ‚úì should handle backup code exhaustion (all codes used) (3 ms)
      ‚úì should handle concurrent 2FA setup attempts by same user (4 ms)
      ‚úì should handle 2FA verification with Redis connection failure (4 ms)
      ‚úì should handle backup code verification when only 1 code remains (4 ms)
      ‚úï should handle case-insensitive backup code verification (4 ms)
      ‚úï should prevent disabling 2FA with backup code (require TOTP) (5 ms)
      ‚úì should handle malformed 2FA setup data in Redis (4 ms)
      ‚úï should handle setup expiration edge case (expires during verification) (1108 ms)
      ‚úì should generate exactly 10 unique backup codes every time (6 ms)
      ‚úï should handle TOTP token validation at time boundary (clock skew) (3 ms)
      ‚úì should handle new backup code generation when Redis save fails (4 ms)

  ‚óè TwoFactorAuthService ‚Ä∫ Edge Cases and Advanced Scenarios ‚Ä∫ should handle case-insensitive backup code verification

    BadRequestException: Invalid 2FA token or backup code

      201 |       }
      202 |
    > 203 |       throw new BadRequestException('Invalid 2FA token or backup code');
          |             ^
      204 |     } catch (error) {
      205 |       if (error instanceof BadRequestException) {
      206 |         throw error;

      at TwoFactorAuthService.verifyTwoFactor (src/auth/services/two-factor-auth.service.ts:203:13)
      at Object.<anonymous> (__tests__/unit/auth/services/two-factor-auth.service.spec.ts:663:22)

  ‚óè TwoFactorAuthService ‚Ä∫ Edge Cases and Advanced Scenarios ‚Ä∫ should prevent disabling 2FA with backup code (require TOTP)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"message": "Two-factor authentication disabled successfully", "success": true}

      682 |
      683 |       // Attempt to disable with backup code should fail
    > 684 |       await expect(service.disable2FA(userId, backupCode)).rejects.toThrow(BadRequestException);
          |             ^
      685 |     });
      686 |
      687 |     it('should handle malformed 2FA setup data in Redis', async () => {

      at expect (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (__tests__/unit/auth/services/two-factor-auth.service.spec.ts:684:13)

  ‚óè TwoFactorAuthService ‚Ä∫ Edge Cases and Advanced Scenarios ‚Ä∫ should handle setup expiration edge case (expires during verification)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"message": "Two-factor authentication enabled successfully", "success": true}

      711 |
      712 |       // Should fail with setup not found
    > 713 |       await expect(service.verifyAndEnable2FA(userId, token)).rejects.toThrow(BadRequestException);
          |             ^
      714 |     });
      715 |
      716 |     it('should generate exactly 10 unique backup codes every time', async () => {

      at expect (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (__tests__/unit/auth/services/two-factor-auth.service.spec.ts:713:13)

  ‚óè TwoFactorAuthService ‚Ä∫ Edge Cases and Advanced Scenarios ‚Ä∫ should handle TOTP token validation at time boundary (clock skew)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"secret": "JBSWY3DPEHPK3PXP", "token": "123456", "window": 1}
    Received: {"encoding": "base32", "secret": "JBSWY3DPEHPK3PXP", "token": "123456", "window": 2}

    Number of calls: 1

      760 |
      761 |       expect(result.success).toBe(true);
    > 762 |       expect(speakeasy.totp.verify).toHaveBeenCalledWith(
          |                                     ^
      763 |         expect.objectContaining({
      764 |           secret: 'JBSWY3DPEHPK3PXP',
      765 |           token,

      at Object.<anonymous> (__tests__/unit/auth/services/two-factor-auth.service.spec.ts:762:37)

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:27 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError generating verification token:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:27 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis connection failed[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:27 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError verifying email:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:27 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mTypeError: Cannot destructure property 'passwordHash' of 'user' as it is undefined.[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError verifying email:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database connection failed[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError resending verification email:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mTypeError: tokenData.expiresAt.getTime is not a function[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError resending verification email:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mTypeError: tokenData.expiresAt.getTime is not a function[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError resending verification email:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError checking verification requirement:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError getting token info:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError cleaning up expired tokens:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError getting verification stats:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError getting token info:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:28 AM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mSyntaxError: Unexpected token 'i', "invalid-json{{{" is not valid JSON[39m
FAIL @money-wise/backend __tests__/unit/auth/services/email-verification.service.spec.ts
  EmailVerificationService
    generateVerificationToken
      ‚úì should generate and store verification token for valid user (7 ms)
      ‚úì should set token expiration to 24 hours from creation (3 ms)
      ‚úì should generate unique tokens for multiple calls (3 ms)
      ‚úì should handle Redis errors gracefully during token generation (20 ms)
      ‚úì should store both token data and user reverse lookup (3 ms)
    verifyEmail
      ‚úì should successfully verify email with valid token (5 ms)
      ‚úì should reject invalid token (8 ms)
      ‚úï should reject expired token (15 ms)
      ‚úì should reject token for non-existent user (6 ms)
      ‚úï should reject token if email does not match user (4 ms)
      ‚úì should handle already verified email gracefully (2 ms)
      ‚úì should sanitize user data in response (exclude password) (3 ms)
      ‚úì should handle database errors during verification (2 ms)
    resendVerificationEmail
      ‚úì should resend verification email for valid user (3 ms)
      ‚úì should reject resend for non-existent user (2 ms)
      ‚úì should reject resend for already verified email (3 ms)
      ‚úï should prevent resending if token was sent recently (within 1 hour) (7 ms)
      ‚úï should allow resending if existing token expires soon (less than 1 hour) (3 ms)
      ‚úì should clean up expired existing token before generating new one (3 ms)
      ‚úì should handle database errors during resend (3 ms)
    isVerificationRequired
      ‚úì should return true for unverified user (2 ms)
      ‚úì should return false for verified user (2 ms)
      ‚úì should return true for non-existent user (fail-safe) (3 ms)
      ‚úì should return true on database error (fail-safe) (3 ms)
    getTokenInfo
      ‚úì should return token information for valid token (2 ms)
      ‚úì should return null for non-existent token (2 ms)
      ‚úì should handle Redis errors gracefully (3 ms)
    cleanupExpiredTokens
      ‚úï should delete expired tokens (3 ms)
      ‚úì should return 0 if no expired tokens found (2 ms)
      ‚úì should handle Redis errors gracefully during cleanup (4 ms)
    getVerificationStats
      ‚úï should return correct statistics (8 ms)
      ‚úì should return zero stats on error (2 ms)
    onModuleDestroy
      ‚úì should close Redis connection on module destroy (2 ms)
    Edge Cases and Race Conditions
      ‚úì should handle multiple concurrent token generation requests (2 ms)
      ‚úì should handle token generation with special characters in email (2 ms)
      ‚úì should handle very long email addresses (2 ms)
      ‚úì should handle verification when Redis is slow (timeout scenario) (110 ms)
      ‚úï should handle cleanup when user has abandoned verification (never completed) (5 ms)
      ‚úì should handle getTokenInfo for malformed token data (5 ms)
      ‚úì should handle resend when previous token was manually deleted (2 ms)
      ‚úì should handle stats calculation with no tokens (2 ms)
      ‚úì should handle verification when user status changes between checks (6 ms)

  ‚óè EmailVerificationService ‚Ä∫ verifyEmail ‚Ä∫ should reject expired token

    expect(received).rejects.toThrow(expected)

    Expected constructor: BadRequestException
    Received constructor: Error

    Received message: "Failed to verify email"

          147 |
          148 |       this.logger.error('Error verifying email:', error);
        > 149 |       throw new Error('Failed to verify email');
              |             ^
          150 |     }
          151 |   }
          152 |

      at EmailVerificationService.verifyEmail (src/auth/services/email-verification.service.ts:149:13)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:300:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:300:56)

  ‚óè EmailVerificationService ‚Ä∫ verifyEmail ‚Ä∫ should reject token if email does not match user

    expect(received).rejects.toThrow(expected)

    Expected substring: "Email verification token does not match user email"
    Received message:   "User not found"

          100 |
          101 |       if (!user) {
        > 102 |         throw new NotFoundException('User not found');
              |               ^
          103 |       }
          104 |
          105 |       // Check if email matches

      at EmailVerificationService.verifyEmail (src/auth/services/email-verification.service.ts:102:15)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:343:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:343:56)

  ‚óè EmailVerificationService ‚Ä∫ resendVerificationEmail ‚Ä∫ should prevent resending if token was sent recently (within 1 hour)

    expect(received).rejects.toThrow(expected)

    Expected constructor: BadRequestException
    Received constructor: Error

    Received message: "Failed to resend verification email"

          203 |
          204 |       this.logger.error('Error resending verification email:', error);
        > 205 |       throw new Error('Failed to resend verification email');
              |             ^
          206 |     }
          207 |   }
          208 |

      at EmailVerificationService.resendVerificationEmail (src/auth/services/email-verification.service.ts:205:13)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:485:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:485:70)

  ‚óè EmailVerificationService ‚Ä∫ resendVerificationEmail ‚Ä∫ should allow resending if existing token expires soon (less than 1 hour)

    Failed to resend verification email

      203 |
      204 |       this.logger.error('Error resending verification email:', error);
    > 205 |       throw new Error('Failed to resend verification email');
          |             ^
      206 |     }
      207 |   }
      208 |

      at EmailVerificationService.resendVerificationEmail (src/auth/services/email-verification.service.ts:205:13)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:511:24)

  ‚óè EmailVerificationService ‚Ä∫ cleanupExpiredTokens ‚Ä∫ should delete expired tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      672 |       const deletedCount = await service.cleanupExpiredTokens();
      673 |
    > 674 |       expect(deletedCount).toBe(2);
          |                            ^
      675 |
      676 |       // Verify expired tokens were deleted
      677 |       expect(await mockRedis.get(`email_verification:${expiredToken1}`)).toBeNull();

      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:674:28)

  ‚óè EmailVerificationService ‚Ä∫ getVerificationStats ‚Ä∫ should return correct statistics

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 3

      768 |       const stats = await service.getVerificationStats();
      769 |
    > 770 |       expect(stats.totalPendingVerifications).toBe(2);
          |                                               ^
      771 |       expect(stats.expiredTokens).toBe(1);
      772 |       expect(stats.recentVerifications).toBe(5);
      773 |     });

      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:770:47)

  ‚óè EmailVerificationService ‚Ä∫ Edge Cases and Race Conditions ‚Ä∫ should handle cleanup when user has abandoned verification (never completed)

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      912 |
      913 |       const deletedCount = await service.cleanupExpiredTokens();
    > 914 |       expect(deletedCount).toBe(2);
          |                            ^
      915 |
      916 |       // Verify tokens were actually deleted
      917 |       expect(await mockRedis.get(`email_verification:${expiredToken1}`)).toBeNull();

      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:914:28)

  console.log
    üê≥ Starting PostgreSQL test container...

      at DatabaseTestManager.start (src/core/database/tests/database-test.config.ts:51:15)

  console.log
    ‚úÖ Test container started on port 33036

      at DatabaseTestManager.startContainer (src/core/database/tests/database-test.config.ts:85:15)

  console.log
    ‚úÖ Test database initialized

      at DatabaseTestManager.initializeDataSource (src/core/database/tests/database-test.config.ts:137:15)

  console.warn
    ‚ö†Ô∏è TimescaleDB extension not available: extension "timescaledb" is not available

      142 |         console.log('‚úÖ TimescaleDB extension enabled');
      143 |       } catch (error) {
    > 144 |         console.warn('‚ö†Ô∏è TimescaleDB extension not available:', error.message);
          |                 ^
      145 |       }
      146 |     } catch (error) {
      147 |       console.error('‚ùå Failed to initialize test database:', error);

      at DatabaseTestManager.initializeDataSource (src/core/database/tests/database-test.config.ts:144:17)
      at DatabaseTestManager.start (src/core/database/tests/database-test.config.ts:58:5)
      at Object.<anonymous> (__tests__/unit/core/database/migrations/migration.test.ts:17:18)

  console.log
    üõë Test database stopped

      at DatabaseTestManager.stop (src/core/database/tests/database-test.config.ts:227:13)

PASS @money-wise/backend __tests__/unit/core/database/migrations/migration.test.ts (15.938 s)
  Database Migrations
    Schema Creation
      ‚úì should create all tables with correct structure (447 ms)
      ‚úì should create all required columns for users table (429 ms)
      ‚úì should create all required columns for accounts table (446 ms)
      ‚úì should create all required columns for transactions table (442 ms)
      ‚úì should create all required columns for categories table (451 ms)
    Indexes and Constraints
      ‚úì should create all required indexes (429 ms)
      ‚úì should create all foreign key constraints (479 ms)
      ‚úì should create unique constraints (496 ms)
    Migration Rollback
      ‚úì should be able to drop and recreate schema (739 ms)
      ‚úì should handle schema changes gracefully (792 ms)
    Data Type Validation
      ‚úì should validate JSONB columns work correctly (434 ms)
      ‚úì should validate enum constraints (423 ms)
      ‚úì should validate decimal precision for monetary values (448 ms)
    Performance and Scalability
      ‚úì should handle large schema operations efficiently (560 ms)
      ‚úì should validate entity metadata matches database schema (476 ms)

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:45 AM [31m  ERROR[39m [38;5;3m[AuthSecurityService] [39m[31mLogin error:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:45 AM [31m  ERROR[39m [38;5;3m[AuthSecurityService] [39m[31mTypeError: Cannot read properties of undefined (reading 'isLocked')[39m
PASS @money-wise/backend __tests__/unit/auth/auth-security.service.spec.ts
  AuthSecurityService
    ‚úì should be defined (5 ms)
    register
      ‚úì should successfully register a new user (3 ms)
      ‚úì should throw ConflictException if user already exists (20 ms)
      ‚úì should throw BadRequestException for weak password (3 ms)
    login
      ‚úì should successfully login with valid credentials (2 ms)
      ‚úì should throw UnauthorizedException if account is locked (2 ms)
      ‚úì should throw UnauthorizedException for invalid credentials (3 ms)
      ‚úì should record failed attempt on invalid password (3 ms)
    changePassword
      ‚úì should successfully change password (4 ms)
      ‚úì should throw UnauthorizedException for invalid current password (3 ms)
      ‚úì should throw BadRequestException for weak new password (4 ms)
      ‚úì should throw BadRequestException if new password is same as current (3 ms)
    requestPasswordReset
      ‚úì should request password reset (3 ms)
    verifyEmail
      ‚úì should verify email successfully (3 ms)
    checkPasswordStrength
      ‚úì should return password strength analysis (4 ms)
    refreshToken
      ‚úì should successfully refresh token (8 ms)
      ‚úì should throw UnauthorizedException for invalid token (2 ms)

PASS @money-wise/backend __tests__/unit/auth/auth.controller.spec.ts
  AuthController
    register
      ‚úì should register a new user successfully (8 ms)
      ‚úì should throw ConflictException when user already exists (10 ms)
      ‚úì should handle invalid registration data (4 ms)
    login
      ‚úì should login user successfully (3 ms)
      ‚úì should throw UnauthorizedException with invalid credentials (2 ms)
      ‚úì should throw UnauthorizedException for inactive user (9 ms)
      ‚úì should handle empty credentials (3 ms)
    refreshToken
      ‚úì should refresh token successfully (3 ms)
      ‚úì should throw UnauthorizedException with invalid refresh token (2 ms)
      ‚úì should throw UnauthorizedException with expired refresh token (3 ms)
      ‚úì should handle malformed refresh token (2 ms)
    getProfile
      ‚úì should return current user profile (3 ms)
      ‚úì should include virtual properties in profile (2 ms)
      ‚úì should handle user with null optional fields (2 ms)
    logout
      ‚úì should logout successfully (2 ms)
      ‚úì should handle logout for any authenticated user (2 ms)
    error handling
      ‚úì should propagate service errors correctly (2 ms)
      ‚úì should handle unexpected errors during login (10 ms)

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError validating reset token:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError resetting password:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Database error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError getting password reset stats:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError cleaning up expired tokens:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError revoking user tokens:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:48 AM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
PASS @money-wise/backend __tests__/unit/auth/services/password-reset.service.spec.ts
  PasswordResetService
    Token Generation (requestPasswordReset)
      ‚úì should generate and store reset token for valid user (8 ms)
      ‚úì should prevent multiple token generation within 5 minutes (9 ms)
      ‚úì should set token expiration to 30 minutes from creation (4 ms)
      ‚úì should store token data with metadata in Redis (4 ms)
      ‚úì should clean up expired tokens before creating new one (3 ms)
      ‚úì should handle database errors gracefully during token creation (3 ms)
      ‚úì should log token generation in audit trail (2 ms)
    Rate Limiting
      ‚úì should reject request when rate limit exceeded (3 ms)
      ‚úì should reject request when account is locked out (3 ms)
      ‚úì should log rate limit events in audit trail (3 ms)
    User Enumeration Prevention
      ‚úì should return same success message for non-existent users (7 ms)
      ‚úì should return same success message for inactive users (3 ms)
      ‚úì should record failed attempts for non-existent users (2 ms)
    Token Validation (validateResetToken)
      ‚úì should accept valid unexpired tokens (3 ms)
      ‚úì should reject expired tokens (2 ms)
      ‚úì should reject already-used tokens (3 ms)
      ‚úì should reject invalid token format (2 ms)
      ‚úì should reject tokens for non-existent users (3 ms)
      ‚úì should reject tokens for inactive users (2 ms)
      ‚úì should handle validation errors gracefully (3 ms)
    Password Reset (resetPassword)
      ‚úì should reset password successfully with valid token (2 ms)
      ‚úì should reject mismatched passwords (9 ms)
      ‚úì should reject weak passwords (4 ms)
      ‚úì should mark token as used after successful reset (4 ms)
      ‚úì should clear rate limits after successful reset (3 ms)
      ‚úì should log successful password reset in audit trail (4 ms)
      ‚úì should return email verification requirement status (4 ms)
      ‚úì should handle password change errors gracefully (4 ms)
    Token Management
      ‚úì should handle token cleanup errors gracefully (5 ms)
      ‚úì should not cleanup recent tokens (< 5 minutes old) (4 ms)
    Statistics and Maintenance
      ‚úì should return password reset statistics (3 ms)
      ‚úì should handle errors in statistics gracefully (2 ms)
      ‚úì should cleanup all expired tokens (8 ms)
      ‚úì should handle cleanup errors gracefully (3 ms)
      ‚úì should revoke all tokens for a specific user (2 ms)
      ‚úì should handle revocation when no tokens exist (2 ms)
      ‚úì should handle revocation errors gracefully (3 ms)
    Resource Cleanup
      ‚úì should cleanup Redis connection on module destroy (3 ms)

PASS @money-wise/backend __tests__/unit/auth/auth.service.spec.ts
  AuthService
    register
      ‚úì should register a new user successfully (5 ms)
      ‚úì should throw ConflictException if user already exists (15 ms)
    login
      ‚úì should login user successfully (5 ms)
      ‚úì should throw UnauthorizedException if user not found (4 ms)
      ‚úì should throw UnauthorizedException if password is invalid (2 ms)
      ‚úì should throw UnauthorizedException if user is not active (2 ms)
    refreshToken
      ‚úì should refresh token successfully with valid refresh token (8 ms)
      ‚úì should throw UnauthorizedException with invalid refresh token (4 ms)
      ‚úì should throw UnauthorizedException if user not found (2 ms)
      ‚úì should throw UnauthorizedException if user is not active (3 ms)
      ‚úì should throw UnauthorizedException with expired refresh token (2 ms)
    validateUser
      ‚úì should return user if valid (2 ms)
      ‚úì should throw UnauthorizedException if user not found (2 ms)
      ‚úì should throw UnauthorizedException if user is not active (2 ms)
    generateAuthResponse
      ‚úì should generate proper auth response with tokens (3 ms)
    error scenarios
      ‚úì should handle password hashing errors during registration (3 ms)
      ‚úì should handle database errors during user creation (2 ms)
      ‚úì should handle password verification errors during login (9 ms)

PASS @money-wise/backend __tests__/unit/auth/controllers/password.controller.spec.ts
  PasswordController
    checkPasswordStrength
      ‚úì should return password strength result (4 ms)
    changePassword
      ‚úì should change password successfully (8 ms)
      ‚úì should throw error for mismatched passwords (10 ms)
      ‚úì should throw error when rate limited (4 ms)
      ‚úì should throw error for incorrect current password (3 ms)
    requestPasswordReset
      ‚úì should request password reset successfully (2 ms)
    validateResetToken
      ‚úì should validate reset token successfully (2 ms)
      ‚úì should return invalid for bad token (3 ms)
    resetPassword
      ‚úì should reset password successfully (4 ms)
      ‚úì should throw error for failed reset (4 ms)
    getPasswordPolicy
      ‚úì should return password policy (8 ms)
    getPasswordStatus
      ‚úì should return password status (2 ms)
      ‚úì should return expired status (3 ms)

PASS @money-wise/backend __tests__/unit/auth/jwt.strategy.spec.ts
  JwtStrategy
    constructor
      ‚úì should be defined (5 ms)
      ‚úì should configure strategy with correct options (2 ms)
    validate
      ‚úì should return user for valid payload (3 ms)
      ‚úì should throw UnauthorizedException when user validation fails (7 ms)
      ‚úì should throw UnauthorizedException with custom message for invalid token (9 ms)
      ‚úì should handle payload with different user roles (3 ms)
      ‚úì should handle payload with missing fields (3 ms)
      ‚úì should handle payload with invalid user ID format (3 ms)
      ‚úì should handle null or undefined payload gracefully (2 ms)
      ‚úì should handle empty payload object (2 ms)
      ‚úì should propagate specific error messages from AuthService (3 ms)
      ‚úì should handle concurrent validation requests (2 ms)
    error scenarios
      ‚úì should handle AuthService throwing non-UnauthorizedException errors (2 ms)
      ‚úì should handle AuthService returning null unexpectedly (2 ms)
      ‚úì should handle malformed JWT payload structure (7 ms)

PASS @money-wise/backend __tests__/unit/common/interceptors/sentry.interceptor.spec.ts
  SentryInterceptor
    intercept
      ‚úì should create interceptor instance (1 ms)

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mFailed to log audit event:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mError: ID generation failed[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] suspicious_activity: anonymous from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033761_hno7crdz6",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.761Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033761_hno7crdz6",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.761Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: anonymous from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033766_qvqterr0e",
  "eventType": "account_locked",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.766Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033766_qvqterr0e",
  "eventType": "account_locked",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.766Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-123 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033789_5465goo5d",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-123",
  "email": "test@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "failedAttempts": 5,
    "lockDuration": 3600
  },
  "timestamp": "2025-10-03T08:43:53.789Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033789_5465goo5d",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-123",
  "email": "test@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "failedAttempts": 5,
    "lockDuration": 3600
  },
  "timestamp": "2025-10-03T08:43:53.789Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] suspicious_activity: user-123 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033792_4azxxgn40",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "userId": "user-123",
  "email": "test@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "description": "Multiple failed 2FA attempts from different IPs"
  },
  "timestamp": "2025-10-03T08:43:53.792Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033792_4azxxgn40",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "userId": "user-123",
  "email": "test@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "description": "Multiple failed 2FA attempts from different IPs"
  },
  "timestamp": "2025-10-03T08:43:53.792Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] suspicious_activity: anonymous from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033796_uhd6fek7w",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "description": "Brute force attack detected"
  },
  "timestamp": "2025-10-03T08:43:53.796Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033796_uhd6fek7w",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "description": "Brute force attack detected"
  },
  "timestamp": "2025-10-03T08:43:53.796Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033809_ck1xdv84n",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.809Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033809_ck1xdv84n",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.809Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033813_z8m9fr2at",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.813Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033813_z8m9fr2at",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.813Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033818_mxa4axgzf",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.818Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033818_mxa4axgzf",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.818Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033831_n1djiv427",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.831Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033831_n1djiv427",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.831Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033836_xiccu0pch",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.836Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033836_xiccu0pch",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.836Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033841_9v51z0ij5",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.841Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033841_9v51z0ij5",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.841Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033846_ln788tgps",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.846Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033846_ln788tgps",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.846Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033851_i06yw3kyo",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.851Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033851_i06yw3kyo",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.851Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033855_awlegl6ag",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.855Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033855_awlegl6ag",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.855Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033858_1n9z7zrln",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.858Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033858_1n9z7zrln",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.858Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033861_69riyqqhc",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.861Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033861_69riyqqhc",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.861Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033866_a1cyjzhxq",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.866Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033866_a1cyjzhxq",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.866Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033869_exn9hrx2m",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.869Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033869_exn9hrx2m",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.869Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033875_9pzsmzmnp",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.875Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033875_9pzsmzmnp",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.875Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mError querying audit logs:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mTypeError: this.auditLogs is not iterable[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033880_4ijwkmai1",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.880Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033880_4ijwkmai1",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.880Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033889_0218g0ack",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.889Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033889_0218g0ack",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.889Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033891_8kf1hv7fp",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.891Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033891_8kf1hv7fp",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.891Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033896_ym26ky5cg",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.896Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033896_ym26ky5cg",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.896Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033900_cyk5lhfp5",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.900Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033900_cyk5lhfp5",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.900Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033905_3uyno1byd",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.905Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033905_3uyno1byd",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.905Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033908_jktz199bs",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.908Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033908_jktz199bs",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.908Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033912_5bk4loe5x",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.912Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033912_5bk4loe5x",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.912Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033917_47jexi0z4",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.917Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033917_47jexi0z4",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.917Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033921_fs00s7v7j",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.921Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033921_fs00s7v7j",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.921Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mError getting audit stats:[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mTypeError: Cannot read properties of null (reading 'filter')[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033924_jdjdwj4v6",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.924Z"
}

[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 1770395  - [39m10/03/2025, 10:43:53 AM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759481033924_jdjdwj4v6",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T08:43:53.924Z"
}

PASS @money-wise/backend __tests__/unit/auth/services/audit-log.service.spec.ts
  AuditLogService
    logEvent
      ‚úì should log a basic audit event (6 ms)
      ‚úì should extract client IP from x-forwarded-for header (3 ms)
      ‚úì should extract client IP from x-real-ip header when x-forwarded-for not available (2 ms)
      ‚úì should fall back to connection.remoteAddress for IP (9 ms)
      ‚úì should use "unknown" when no IP can be determined (3 ms)
      ‚úì should extract session ID from x-session-id header (5 ms)
      ‚úì should extract user-agent from request (3 ms)
      ‚úì should use "unknown" for missing user-agent (2 ms)
      ‚úì should store custom details in audit event (3 ms)
      ‚úì should not throw on logging errors (3 ms)
      ‚úì should cap audit logs at maxLogEntries (10000) (8 ms)
    determineSeverity
      ‚úì should assign CRITICAL severity to suspicious activity (4 ms)
      ‚úì should assign CRITICAL severity to account locked (5 ms)
      ‚úì should assign HIGH severity to login failed (8 ms)
      ‚úì should assign HIGH severity to rate limit exceeded (2 ms)
      ‚úì should assign MEDIUM severity to password change success (2 ms)
      ‚úì should assign LOW severity to login success (1 ms)
    logLoginSuccess
      ‚úì should log successful login with user details (2 ms)
    logLoginFailed
      ‚úì should log failed login attempt with reason (3 ms)
    logAccountLocked
      ‚úì should log account lockout with details (3 ms)
    logSuspiciousActivity
      ‚úì should log suspicious activity with description (3 ms)
      ‚úì should log anonymous suspicious activity (5 ms)
    logPasswordChange
      ‚úì should log successful password change (4 ms)
      ‚úì should log failed password change (3 ms)
    queryLogs
      ‚úì should query all logs without filters (5 ms)
      ‚úì should filter logs by userId (3 ms)
      ‚úì should filter logs by single eventType (15 ms)
      ‚úì should filter logs by multiple eventTypes (3 ms)
      ‚úì should filter logs by single severity (5 ms)
      ‚úì should filter logs by multiple severities (4 ms)
      ‚úì should filter logs by ipAddress (5 ms)
      ‚úì should filter logs by date range (startDate) (4 ms)
      ‚úì should filter logs by date range (endDate) (4 ms)
      ‚úì should filter logs by date range (startDate and endDate) (3 ms)
      ‚úì should sort logs by timestamp (newest first) (3 ms)
      ‚úì should apply pagination with offset and limit (3 ms)
      ‚úì should apply default pagination (limit 100) (4 ms)
      ‚úì should handle errors gracefully (5 ms)
      ‚úì should combine multiple filters (9 ms)
    getAuditStats
      ‚úì should return stats for hour timeframe (4 ms)
      ‚úì should return stats for day timeframe (default) (3 ms)
      ‚úì should count unique users correctly (4 ms)
      ‚úì should count unique IPs correctly (4 ms)
      ‚úì should count events by severity (5 ms)
      ‚úì should handle week timeframe (3 ms)
      ‚úì should handle month timeframe (4 ms)
      ‚úì should exclude events outside timeframe (4 ms)
      ‚úì should handle errors gracefully (4 ms)
      ‚úì should handle empty audit logs (3 ms)
    Edge Cases
      ‚úì should handle multiple events from same user at different IPs (2 ms)
      ‚úì should handle events with empty details (2 ms)
      ‚úì should handle events without userId or email (9 ms)
      ‚úì should generate unique IDs for all events (2 ms)
      ‚úì should handle very large details objects (3 ms)
      ‚úì should handle pagination beyond available logs (2 ms)
      ‚úì should handle concurrent logging of multiple events (4 ms)

PASS @money-wise/backend __tests__/unit/auth/jwt-auth.guard.spec.ts
  JwtAuthGuard
    canActivate
      ‚úì should return true for public routes (8 ms)
      ‚úì should call super.canActivate for protected routes (19 ms)
      ‚úì should handle undefined public key (5 ms)
      ‚úì should properly check method and class decorators (5 ms)
    handleRequest
      ‚úì should return user when no error and user exists (4 ms)
      ‚úì should throw UnauthorizedException when error exists (8 ms)
      ‚úì should throw UnauthorizedException when user is null (7 ms)
      ‚úì should throw UnauthorizedException when user is undefined (11 ms)
      ‚úì should throw custom UnauthorizedException with proper message (4 ms)
      ‚úì should prioritize original error over missing user (2 ms)
      ‚úì should handle falsy user values (4 ms)
      ‚úì should handle truthy user values (10 ms)
    integration scenarios
      ‚úì should handle public route with missing user gracefully (4 ms)
      ‚úì should handle protected route with valid token (3 ms)

PASS @money-wise/backend __tests__/unit/core/health/health.controller.spec.ts
  HealthController
    ‚úì should be defined (4 ms)
    getHealth
      ‚úì should return basic health status (2 ms)
      ‚úì should return consistent timestamp format (2 ms)
      ‚úì should return positive uptime (4 ms)
      ‚úì should return memory usage (4 ms)
    getDetailedHealth
      ‚úì should return detailed health with services status (10 ms)
      ‚úì should include database response time (5 ms)
    getReadiness
      ‚úì should return readiness status (3 ms)
    getLiveness
      ‚úì should return liveness status (2 ms)

PASS @money-wise/backend __tests__/unit/auth/services/password-strength.service.spec.ts
  PasswordStrengthService
    calculateStrength
      ‚úì should return very weak for simple passwords (4 ms)
      ‚úì should return strong for complex passwords (2 ms)
      ‚úì should detect common passwords (2 ms)
      ‚úì should detect personal information in password (7 ms)
      ‚úì should detect repeating characters (2 ms)
      ‚úì should detect sequential characters (2 ms)
    validatePolicy
      ‚úì should validate minimum length requirement (1 ms)
      ‚úì should validate character requirements (1 ms)
      ‚úì should pass for valid passwords (2 ms)

PASS @money-wise/backend __tests__/unit/docs/openapi.spec.ts
  OpenAPI Specification
    ‚úì should generate valid OpenAPI spec (1 ms)

PASS @money-wise/backend __tests__/unit/common/decorators/sentry-transaction.decorator.spec.ts
  SentryTransactionDecorator
    withSentryTransaction
      ‚úì should wrap function with Sentry transaction (2 ms)
      ‚úì should handle errors in wrapped function (3 ms)
    SentryTransactionManager
      ‚úì should manage transaction lifecycle (1 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/user.repository.spec.ts
  UserRepository
    findByEmail
      ‚úì should find user by email with case insensitivity (5 ms)
      ‚úì should return null when user not found (4 ms)
      ‚úì should handle findByEmail errors (19 ms)
    isEmailTaken
      ‚úì should return true when email is taken (8 ms)
      ‚úì should return false when email is not taken (2 ms)
      ‚úì should exclude specific user when checking email availability (3 ms)
      ‚úì should handle isEmailTaken errors (3 ms)
    findByEmailVerificationToken
      ‚úì should return null for email verification token (not implemented) (4 ms)
      ‚úì should handle findByEmailVerificationToken errors (6 ms)
    findByPasswordResetToken
      ‚úì should return null for password reset token (not implemented) (3 ms)
      ‚úì should handle findByPasswordResetToken errors (2 ms)
    markEmailAsVerified
      ‚úì should mark email as verified successfully (2 ms)
      ‚úì should return false when no user was updated (2 ms)
      ‚úì should handle markEmailAsVerified errors (3 ms)
    updatePasswordHash
      ‚úì should update password hash successfully (3 ms)
      ‚úì should return false when no user was updated (3 ms)
      ‚úì should handle updatePasswordHash errors (9 ms)
    setPasswordResetToken
      ‚úì should return false for password reset token (not implemented) (3 ms)
      ‚úì should handle setPasswordResetToken errors (3 ms)
    clearPasswordResetToken
      ‚úì should return false for clear password reset token (not implemented) (2 ms)
      ‚úì should handle clearPasswordResetToken errors (2 ms)
    findWithAccounts
      ‚úì should find user with their accounts (2 ms)
      ‚úì should return null when user not found (1 ms)
      ‚úì should handle findWithAccounts errors (2 ms)
    findByDateRange
      ‚úì should find users within date range (4 ms)
      ‚úì should handle findByDateRange errors (4 ms)
    getUserStats
      ‚úì should return user statistics (2 ms)
      ‚úì should handle getUserStats errors (3 ms)
    softDelete
      ‚úì should log soft delete request (9 ms)
      ‚úì should handle softDelete errors (3 ms)
    search
      ‚úì should search users by first name, last name, and email (2 ms)
      ‚úì should use default limit when not provided (2 ms)
      ‚úì should handle search errors (3 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/transaction.repository.spec.ts
  TransactionRepository
    findByAccountId
      ‚úì should find transactions by account ID (5 ms)
      ‚úì should apply date range filters (2 ms)
      ‚úì should apply pagination (2 ms)
      ‚úì should include hidden transactions when requested (2 ms)
      ‚úì should handle findByAccountId errors (26 ms)
    findByCategoryId
      ‚úì should find transactions by category ID (3 ms)
      ‚úì should apply date range and pagination (2 ms)
      ‚úì should handle findByCategoryId errors (3 ms)
    findByUserId
      ‚úì should find transactions by user ID (4 ms)
      ‚úì should apply complex filters (4 ms)
      ‚úì should handle findByUserId errors (2 ms)
    findByPlaidTransactionId
      ‚úì should find transaction by Plaid ID (2 ms)
      ‚úì should return null when Plaid transaction not found (7 ms)
      ‚úì should handle findByPlaidTransactionId errors (1 ms)
    findByType
      ‚úì should find transactions by type (2 ms)
      ‚úì should apply optional filters (1 ms)
      ‚úì should handle findByType errors (1 ms)
    findByStatus
      ‚úì should find transactions by status (2 ms)
      ‚úì should apply optional filters (2 ms)
      ‚úì should handle findByStatus errors (2 ms)
    findBySource
      ‚úì should find transactions by source (2 ms)
      ‚úì should apply optional filters (2 ms)
      ‚úì should handle findBySource errors (2 ms)
    findUncategorized
      ‚úì should find uncategorized transactions (3 ms)
      ‚úì should apply optional filters (12 ms)
      ‚úì should handle findUncategorized errors (2 ms)
    findDuplicates
      ‚úì should find duplicate transactions (2 ms)
      ‚úì should apply duplicate detection options (2 ms)
      ‚úì should handle findDuplicates errors (2 ms)
    findRecent
      ‚úì should find recent transactions (2 ms)
      ‚úì should use custom days and limit (2 ms)
      ‚úì should handle findRecent errors (3 ms)
    searchTransactions
      ‚úì should search transactions by term (3 ms)
      ‚úì should apply search filters (2 ms)
      ‚úì should handle searchTransactions errors (2 ms)
    getTransactionStats
      ‚úì should get transaction statistics (3 ms)
      ‚úì should handle getTransactionStats errors (9 ms)
    updateCategory
      ‚úì should update transaction category (4 ms)
      ‚úì should handle null category (uncategorize) (4 ms)
      ‚úì should return null when transaction not found (2 ms)
      ‚úì should handle updateCategory errors (2 ms)
    updateDescription
      ‚úì should update transaction description (2 ms)
      ‚úì should handle updateDescription errors (2 ms)
    toggleHidden
      ‚úì should toggle hidden status from false to true (3 ms)
      ‚úì should toggle hidden status from true to false (3 ms)
      ‚úì should return null when transaction not found (2 ms)
      ‚úì should handle toggleHidden errors (2 ms)
    addNotes
      ‚úì should add notes to transaction (3 ms)
      ‚úì should handle addNotes errors (2 ms)
    addTags
      ‚úì should add tags to transaction (8 ms)
      ‚úì should handle addTags errors (2 ms)
    getMonthlySpendingByCategory
      ‚úì should throw not implemented error (2 ms)
    createSplit
      ‚úì should throw not implemented error (2 ms)
    bulkCategorize
      ‚úì should throw not implemented error (4 ms)
    findNeedingCategorization
      ‚úì should throw not implemented error (4 ms)
    getCashFlow
      ‚úì should throw not implemented error (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/category.repository.spec.ts
  CategoryRepository
    findBySlug
      ‚úì should find category by slug (5 ms)
      ‚úì should return null when category not found (3 ms)
      ‚úì should handle findBySlug errors (27 ms)
    findByType
      ‚úì should find categories by type (active only) (3 ms)
      ‚úì should include inactive categories when requested (4 ms)
      ‚úì should handle findByType errors (4 ms)
    findByStatus
      ‚úì should find categories by status (3 ms)
      ‚úì should handle findByStatus errors (2 ms)
    findRootCategories
      ‚úì should find all root categories (2 ms)
      ‚úì should filter root categories by type (2 ms)
      ‚úì should handle findRootCategories errors (2 ms)
    findChildCategories
      ‚úì should find child categories (active only) (10 ms)
      ‚úì should include inactive children when requested (2 ms)
      ‚úì should handle findChildCategories errors (2 ms)
    findCategoryTree
      ‚úì should find full category tree (2 ms)
      ‚úì should find tree starting from specific parent (2 ms)
      ‚úì should handle findCategoryTree errors (2 ms)
    findCategoriesWithRules
      ‚úì should find categories with rules (2 ms)
      ‚úì should filter by type (2 ms)
      ‚úì should handle findCategoriesWithRules errors (2 ms)
    findDefaultCategories
      ‚úì should find default categories (2 ms)
      ‚úì should filter default categories by type (2 ms)
      ‚úì should handle findDefaultCategories errors (2 ms)
    findSystemCategories
      ‚úì should find system categories (2 ms)
      ‚úì should filter system categories by type (10 ms)
      ‚úì should handle findSystemCategories errors (3 ms)
    searchCategories
      ‚úì should search categories by name and description (2 ms)
      ‚úì should filter search by type (2 ms)
      ‚úì should handle searchCategories errors (2 ms)
    isSlugAvailable
      ‚úì should return true when slug is available (2 ms)
      ‚úì should return false when slug is taken (3 ms)
      ‚úì should exclude specified category from check (3 ms)
      ‚úì should handle isSlugAvailable errors (3 ms)
    updateStatus
      ‚úì should update category status (2 ms)
      ‚úì should return null when category not found (2 ms)
      ‚úì should handle updateStatus errors (2 ms)
    moveCategory
      ‚úì should move category to new parent (3 ms)
      ‚úì should move category to root level (7 ms)
      ‚úì should handle moveCategory errors (2 ms)
    updateSortOrder
      ‚úì should update category sort order (2 ms)
      ‚úì should handle updateSortOrder errors (2 ms)
    getCategoryUsageStats
      ‚úì should get category usage statistics (3 ms)
      ‚úì should handle null values in stats (2 ms)
      ‚úì should handle getCategoryUsageStats errors (2 ms)
    findMatchingCategories
      ‚úì should find matching categories based on keywords (2 ms)
      ‚úì should match by merchant patterns (2 ms)
      ‚úì should match by amount ranges (2 ms)
      ‚úì should return empty array when no matches (2 ms)
      ‚úì should handle findMatchingCategories errors (2 ms)
    archiveAndReassign
      ‚úì should archive category and reassign transactions (8 ms)
      ‚úì should handle archiveAndReassign errors (3 ms)
    createDefaultCategories
      ‚úì should create default categories (2 ms)
      ‚úì should handle createDefaultCategories errors (3 ms)
    updateRules
      ‚úì should update category rules (2 ms)
      ‚úì should handle updateRules errors (1 ms)
    updateMetadata
      ‚úì should update category metadata (2 ms)
      ‚úì should handle updateMetadata errors (3 ms)
    reorderCategories
      ‚úì should reorder categories under parent (3 ms)
      ‚úì should reorder categories at root level (3 ms)
      ‚úì should handle reorderCategories errors (2 ms)
    Edge Cases
      ‚úì should handle empty string slug (2 ms)
      ‚úì should handle special characters in search (2 ms)
      ‚úì should handle large category trees (11 ms)
      ‚úì should handle category with no transactions in usage stats (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/base.repository.spec.ts
  BaseRepository
    constructor
      ‚úì should initialize repository with correct entity (5 ms)
    create
      ‚úì should create and save a new entity successfully (3 ms)
      ‚úì should handle creation errors and throw descriptive error (18 ms)
    save
      ‚úì should save an existing entity successfully (4 ms)
      ‚úì should handle save errors (2 ms)
    findById
      ‚úì should find entity by ID successfully (10 ms)
      ‚úì should return null when entity not found (2 ms)
      ‚úì should handle findById errors (4 ms)
    findOne
      ‚úì should find one entity with FindOptionsWhere (4 ms)
      ‚úì should find one entity with FindOneOptions (4 ms)
      ‚úì should handle findOne errors (4 ms)
    find
      ‚úì should find multiple entities with options (5 ms)
      ‚úì should find all entities when no options provided (5 ms)
      ‚úì should handle find errors (5 ms)
    findWithPagination
      ‚úì should return paginated results (6 ms)
      ‚úì should handle pagination with criteria (2 ms)
      ‚úì should handle pagination errors (3 ms)
    update
      ‚úì should update entity successfully (9 ms)
      ‚úì should return null when entity to update not found (2 ms)
      ‚úì should handle update errors (2 ms)
    delete
      ‚úì should delete entity successfully (2 ms)
      ‚úì should return false when no entity was deleted (2 ms)
      ‚úì should handle delete errors (2 ms)
    deleteBy
      ‚úì should delete entities by criteria (4 ms)
      ‚úì should handle deleteBy errors (4 ms)
    count
      ‚úì should count entities with criteria (2 ms)
      ‚úì should count all entities when no criteria provided (3 ms)
      ‚úì should handle count errors (3 ms)
    exists
      ‚úì should return true when entity exists (3 ms)
      ‚úì should return false when entity does not exist (3 ms)
      ‚úì should handle exists errors (11 ms)
    bulkInsert
      ‚úì should perform bulk insert successfully (3 ms)
      ‚úì should handle bulk insert errors (2 ms)
    bulkUpdate
      ‚úì should perform bulk update successfully (2 ms)
      ‚úì should handle bulk update errors (2 ms)
    query
      ‚úì should execute raw query successfully (2 ms)
      ‚úì should execute parameterized query (2 ms)
      ‚úì should handle query errors (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/account.repository.spec.ts
  AccountRepository
    findByUserId
      ‚úì should find accounts by user ID (10 ms)
      ‚úì should handle findByUserId errors (54 ms)
    findActiveAccountsByUserId
      ‚úì should find active accounts by user ID (8 ms)
      ‚úì should handle findActiveAccountsByUserId errors (6 ms)
    updateBalance
      ‚úì should update account currentBalance successfully (4 ms)
      ‚úì should return false when no account was updated (4 ms)
      ‚úì should handle updateBalance errors (4 ms)
    incrementBalance
      ‚úì should increment account currentBalance successfully (21 ms)
      ‚úì should return false when no account was updated (4 ms)
      ‚úì should handle incrementBalance errors (4 ms)
      ‚úì should increment account balance (3 ms)
      ‚úì should return false if account not found (2 ms)
      ‚úì should handle incrementBalance errors (3 ms)
    decrementBalance
      ‚úì should decrement account currentBalance successfully (6 ms)
      ‚úì should handle decrementBalance errors (4 ms)
      ‚úì should decrement account balance (4 ms)
      ‚úì should handle decrementBalance errors (3 ms)
    getTotalBalanceForUser
      ‚úì should get total currentBalance for user (4 ms)
      ‚úì should return 0 when no total found (4 ms)
      ‚úì should handle getTotalBalanceForUser errors (8 ms)
    findByPlaidAccountId
      ‚úì should find account by Plaid account ID (5 ms)
      ‚úì should return null when Plaid account not found (6 ms)
      ‚úì should handle findByPlaidAccountId errors (6 ms)
    deactivateAccount
      ‚úì should deactivate account successfully (20 ms)
      ‚úì should return false when no account was deactivated (7 ms)
      ‚úì should handle deactivateAccount errors (27 ms)
    reactivateAccount
      ‚úì should reactivate account successfully (2 ms)
      ‚úì should handle reactivateAccount errors (4 ms)
    findAccountsForSync
      ‚úì should find accounts for sync with user filter (4 ms)
      ‚úì should find all accounts for sync without user filter (3 ms)
      ‚úì should handle findAccountsForSync errors (2 ms)
    getAccountBalancesSummary
      ‚úì should get account currentBalances summary by type (3 ms)
      ‚úì should handle getAccountBalancesSummary errors (3 ms)
    findLowBalanceAccounts
      ‚úì should find low currentBalance accounts with user filter (4 ms)
      ‚úì should handle findLowBalanceAccounts errors (3 ms)
    findByType
      ‚úì should find accounts by type with userId (4 ms)
      ‚úì should find accounts by type without userId (3 ms)
      ‚úì should handle findByType errors (2 ms)
    findByPlaidItemId
      ‚úì should find accounts by Plaid item ID (11 ms)
      ‚úì should return empty array if no accounts found (4 ms)
      ‚úì should handle findByPlaidItemId errors (4 ms)
    updateLastSyncedAt
      ‚úì should update sync timestamp successfully (3 ms)
      ‚úì should return false if account not found (2 ms)
      ‚úì should handle update errors (2 ms)
    findWithTransactions
      ‚úì should find account with transactions and apply limit (8 ms)
      ‚úì should use default limit of 50 (2 ms)
      ‚úì should return null if account not found (9 ms)
      ‚úì should handle errors (2 ms)
    findByCurrency
      ‚úì should find accounts by currency with userId (2 ms)
      ‚úì should find accounts by currency without userId (1 ms)
      ‚úì should handle errors (2 ms)
    groupByInstitution
      ‚úì should group accounts by institution with totals (2 ms)
      ‚úì should return empty array if no accounts found (2 ms)
      ‚úì should handle errors (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/entities/entity-relationships.test.ts (10.465 s)
  Entity Relationships
    User -> Account Relationship
      ‚úì should create user with multiple accounts (542 ms)
      ‚úì should cascade delete accounts when user is deleted (474 ms)
      ‚úì should enforce foreign key constraint (541 ms)
    Account -> Transaction Relationship
      ‚úì should create account with multiple transactions (481 ms)
      ‚úì should cascade delete transactions when account is deleted (527 ms)
    Category -> Transaction Relationship
      ‚úì should associate transaction with category (491 ms)
      ‚úì should handle category deletion with SET NULL (526 ms)
      ‚úì should allow transaction without category (525 ms)
    Category Tree Structure
      ‚úì should create parent-child category relationships (468 ms)
      ‚úì should cascade delete child categories when parent is deleted (508 ms)
      ‚úì should validate category tree depth (566 ms)
    Complex Relationship Queries
      ‚úì should find all transactions for a user across accounts (500 ms)
      ‚úì should calculate account balance from transactions (474 ms)
      ‚úì should find categories with transaction counts (497 ms)
    Constraint Validation
      ‚úì should enforce unique email constraint (521 ms)
      ‚úì should enforce unique category slug constraint (469 ms)
      ‚úì should enforce transaction amount precision (489 ms)
      ‚úì should enforce enum constraints (476 ms)
    Index Performance
      ‚úì should use indexes for common queries (523 ms)

PASS @money-wise/backend __tests__/unit/auth/services/password-security.service.spec.ts
  PasswordSecurityService
    hashPassword
      ‚úì should hash password with bcrypt (298 ms)
      ‚úì should hash password with argon2 (173 ms)
    verifyPassword
      ‚úì should verify bcrypt password correctly (859 ms)
      ‚úì should verify argon2 password correctly (562 ms)
      ‚úì should auto-detect hashing algorithm (929 ms)
    validatePassword
      ‚úì should validate strong password (3 ms)
      ‚úì should reject weak password (3 ms)
    isPasswordExpired
      ‚úì should return false for recent password (3 ms)
      ‚úì should return true for old password (2 ms)
    getDaysUntilExpiration
      ‚úì should calculate days until expiration correctly (3 ms)
    shouldWarnPasswordExpiry
      ‚úì should warn when password expires soon (2 ms)
      ‚úì should not warn when password is not expiring soon (3 ms)

Summary of all failing tests
FAIL __tests__/unit/auth/services/two-factor-auth.service.spec.ts (9.744 s)
  ‚óè TwoFactorAuthService ‚Ä∫ Edge Cases and Advanced Scenarios ‚Ä∫ should handle case-insensitive backup code verification

    BadRequestException: Invalid 2FA token or backup code

      201 |       }
      202 |
    > 203 |       throw new BadRequestException('Invalid 2FA token or backup code');
          |             ^
      204 |     } catch (error) {
      205 |       if (error instanceof BadRequestException) {
      206 |         throw error;

      at TwoFactorAuthService.verifyTwoFactor (src/auth/services/two-factor-auth.service.ts:203:13)
      at Object.<anonymous> (__tests__/unit/auth/services/two-factor-auth.service.spec.ts:663:22)

  ‚óè TwoFactorAuthService ‚Ä∫ Edge Cases and Advanced Scenarios ‚Ä∫ should prevent disabling 2FA with backup code (require TOTP)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"message": "Two-factor authentication disabled successfully", "success": true}

      682 |
      683 |       // Attempt to disable with backup code should fail
    > 684 |       await expect(service.disable2FA(userId, backupCode)).rejects.toThrow(BadRequestException);
          |             ^
      685 |     });
      686 |
      687 |     it('should handle malformed 2FA setup data in Redis', async () => {

      at expect (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (__tests__/unit/auth/services/two-factor-auth.service.spec.ts:684:13)

  ‚óè TwoFactorAuthService ‚Ä∫ Edge Cases and Advanced Scenarios ‚Ä∫ should handle setup expiration edge case (expires during verification)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"message": "Two-factor authentication enabled successfully", "success": true}

      711 |
      712 |       // Should fail with setup not found
    > 713 |       await expect(service.verifyAndEnable2FA(userId, token)).rejects.toThrow(BadRequestException);
          |             ^
      714 |     });
      715 |
      716 |     it('should generate exactly 10 unique backup codes every time', async () => {

      at expect (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (__tests__/unit/auth/services/two-factor-auth.service.spec.ts:713:13)

  ‚óè TwoFactorAuthService ‚Ä∫ Edge Cases and Advanced Scenarios ‚Ä∫ should handle TOTP token validation at time boundary (clock skew)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"secret": "JBSWY3DPEHPK3PXP", "token": "123456", "window": 1}
    Received: {"encoding": "base32", "secret": "JBSWY3DPEHPK3PXP", "token": "123456", "window": 2}

    Number of calls: 1

      760 |
      761 |       expect(result.success).toBe(true);
    > 762 |       expect(speakeasy.totp.verify).toHaveBeenCalledWith(
          |                                     ^
      763 |         expect.objectContaining({
      764 |           secret: 'JBSWY3DPEHPK3PXP',
      765 |           token,

      at Object.<anonymous> (__tests__/unit/auth/services/two-factor-auth.service.spec.ts:762:37)

FAIL __tests__/unit/auth/services/email-verification.service.spec.ts
  ‚óè EmailVerificationService ‚Ä∫ verifyEmail ‚Ä∫ should reject expired token

    expect(received).rejects.toThrow(expected)

    Expected constructor: BadRequestException
    Received constructor: Error

    Received message: "Failed to verify email"

          147 |
          148 |       this.logger.error('Error verifying email:', error);
        > 149 |       throw new Error('Failed to verify email');
              |             ^
          150 |     }
          151 |   }
          152 |

      at EmailVerificationService.verifyEmail (src/auth/services/email-verification.service.ts:149:13)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:300:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:300:56)

  ‚óè EmailVerificationService ‚Ä∫ verifyEmail ‚Ä∫ should reject token if email does not match user

    expect(received).rejects.toThrow(expected)

    Expected substring: "Email verification token does not match user email"
    Received message:   "User not found"

          100 |
          101 |       if (!user) {
        > 102 |         throw new NotFoundException('User not found');
              |               ^
          103 |       }
          104 |
          105 |       // Check if email matches

      at EmailVerificationService.verifyEmail (src/auth/services/email-verification.service.ts:102:15)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:343:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:343:56)

  ‚óè EmailVerificationService ‚Ä∫ resendVerificationEmail ‚Ä∫ should prevent resending if token was sent recently (within 1 hour)

    expect(received).rejects.toThrow(expected)

    Expected constructor: BadRequestException
    Received constructor: Error

    Received message: "Failed to resend verification email"

          203 |
          204 |       this.logger.error('Error resending verification email:', error);
        > 205 |       throw new Error('Failed to resend verification email');
              |             ^
          206 |     }
          207 |   }
          208 |

      at EmailVerificationService.resendVerificationEmail (src/auth/services/email-verification.service.ts:205:13)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:485:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:485:70)

  ‚óè EmailVerificationService ‚Ä∫ resendVerificationEmail ‚Ä∫ should allow resending if existing token expires soon (less than 1 hour)

    Failed to resend verification email

      203 |
      204 |       this.logger.error('Error resending verification email:', error);
    > 205 |       throw new Error('Failed to resend verification email');
          |             ^
      206 |     }
      207 |   }
      208 |

      at EmailVerificationService.resendVerificationEmail (src/auth/services/email-verification.service.ts:205:13)
      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:511:24)

  ‚óè EmailVerificationService ‚Ä∫ cleanupExpiredTokens ‚Ä∫ should delete expired tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      672 |       const deletedCount = await service.cleanupExpiredTokens();
      673 |
    > 674 |       expect(deletedCount).toBe(2);
          |                            ^
      675 |
      676 |       // Verify expired tokens were deleted
      677 |       expect(await mockRedis.get(`email_verification:${expiredToken1}`)).toBeNull();

      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:674:28)

  ‚óè EmailVerificationService ‚Ä∫ getVerificationStats ‚Ä∫ should return correct statistics

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 3

      768 |       const stats = await service.getVerificationStats();
      769 |
    > 770 |       expect(stats.totalPendingVerifications).toBe(2);
          |                                               ^
      771 |       expect(stats.expiredTokens).toBe(1);
      772 |       expect(stats.recentVerifications).toBe(5);
      773 |     });

      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:770:47)

  ‚óè EmailVerificationService ‚Ä∫ Edge Cases and Race Conditions ‚Ä∫ should handle cleanup when user has abandoned verification (never completed)

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      912 |
      913 |       const deletedCount = await service.cleanupExpiredTokens();
    > 914 |       expect(deletedCount).toBe(2);
          |                            ^
      915 |
      916 |       // Verify tokens were actually deleted
      917 |       expect(await mockRedis.get(`email_verification:${expiredToken1}`)).toBeNull();

      at Object.<anonymous> (__tests__/unit/auth/services/email-verification.service.spec.ts:914:28)


Test Suites: 2 failed, 21 passed, 23 total
Tests:       11 failed, 572 passed, 583 total
Snapshots:   0 total
Time:        61.697 s
Ran all test suites matching /__tests__\/unit/i.
‚ÄâELIFECYCLE‚Äâ Command failed with exit code 1.
