
> @money-wise/backend@0.1.0 test:unit /home/nemesi/dev/money-wise/apps/backend
> jest --passWithNoTests --testPathPattern='__tests__/unit'

PASS @money-wise/backend __tests__/unit/core/health/health.controller.spec.ts
  HealthController
    âœ“ should be defined (12 ms)
    getHealth
      âœ“ should return basic health status (6 ms)
      âœ“ should return consistent timestamp format (4 ms)
      âœ“ should return positive uptime (4 ms)
      âœ“ should return memory usage (4 ms)
    getDetailedHealth
      âœ“ should return detailed health with services status (11 ms)
      âœ“ should include database response time (33 ms)
    getReadiness
      âœ“ should return readiness status (2 ms)
    getLiveness
      âœ“ should return liveness status (3 ms)

  console.log
    ğŸ³ Starting PostgreSQL test container...

      at DatabaseTestManager.start (src/core/database/tests/database-test.config.ts:50:15)

  console.log
    âœ… Test container started on port 32982

      at DatabaseTestManager.startContainer (src/core/database/tests/database-test.config.ts:84:15)

  console.log
    âœ… Test database initialized

      at DatabaseTestManager.initializeDataSource (src/core/database/tests/database-test.config.ts:136:15)

  console.warn
    âš ï¸ TimescaleDB extension not available: extension "timescaledb" is not available

      141 |         console.log('âœ… TimescaleDB extension enabled');
      142 |       } catch (error) {
    > 143 |         console.warn('âš ï¸ TimescaleDB extension not available:', error.message);
          |                 ^
      144 |       }
      145 |     } catch (error) {
      146 |       console.error('âŒ Failed to initialize test database:', error);

      at DatabaseTestManager.initializeDataSource (src/core/database/tests/database-test.config.ts:143:17)
      at DatabaseTestManager.start (src/core/database/tests/database-test.config.ts:57:5)
      at Object.<anonymous> (__tests__/unit/core/database/migrations/migration.test.ts:17:18)

  console.log
    ğŸ›‘ Test database stopped

      at DatabaseTestManager.stop (src/core/database/tests/database-test.config.ts:226:13)

PASS @money-wise/backend __tests__/unit/core/database/migrations/migration.test.ts (14.013 s)
  Database Migrations
    Schema Creation
      âœ“ should create all tables with correct structure (463 ms)
      âœ“ should create all required columns for users table (469 ms)
      âœ“ should create all required columns for accounts table (437 ms)
      âœ“ should create all required columns for transactions table (435 ms)
      âœ“ should create all required columns for categories table (426 ms)
    Indexes and Constraints
      âœ“ should create all required indexes (466 ms)
      âœ“ should create all foreign key constraints (470 ms)
      âœ“ should create unique constraints (451 ms)
    Migration Rollback
      âœ“ should be able to drop and recreate schema (743 ms)
      âœ“ should handle schema changes gracefully (819 ms)
    Data Type Validation
      âœ“ should validate JSONB columns work correctly (445 ms)
      âœ“ should validate enum constraints (427 ms)
      âœ“ should validate decimal precision for monetary values (472 ms)
    Performance and Scalability
      âœ“ should handle large schema operations efficiently (513 ms)
      âœ“ should validate entity metadata matches database schema (485 ms)

PASS @money-wise/backend __tests__/unit/core/database/entities/entity-relationships.test.ts (10.49 s)
  Entity Relationships
    User -> Account Relationship
      âœ“ should create user with multiple accounts (532 ms)
      âœ“ should cascade delete accounts when user is deleted (503 ms)
      âœ“ should enforce foreign key constraint (528 ms)
    Account -> Transaction Relationship
      âœ“ should create account with multiple transactions (481 ms)
      âœ“ should cascade delete transactions when account is deleted (538 ms)
    Category -> Transaction Relationship
      âœ“ should associate transaction with category (492 ms)
      âœ“ should handle category deletion with SET NULL (507 ms)
      âœ“ should allow transaction without category (473 ms)
    Category Tree Structure
      âœ“ should create parent-child category relationships (603 ms)
      âœ“ should cascade delete child categories when parent is deleted (516 ms)
      âœ“ should validate category tree depth (505 ms)
    Complex Relationship Queries
      âœ“ should find all transactions for a user across accounts (511 ms)
      âœ“ should calculate account balance from transactions (481 ms)
      âœ“ should find categories with transaction counts (543 ms)
    Constraint Validation
      âœ“ should enforce unique email constraint (449 ms)
      âœ“ should enforce unique category slug constraint (499 ms)
      âœ“ should enforce transaction amount precision (485 ms)
      âœ“ should enforce enum constraints (477 ms)
    Index Performance
      âœ“ should use indexes for common queries (548 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/category.repository.spec.ts
  CategoryRepository
    findBySlug
      âœ“ should find category by slug (6 ms)
      âœ“ should return null when category not found (3 ms)
      âœ“ should handle findBySlug errors (22 ms)
    findByType
      âœ“ should find categories by type (active only) (3 ms)
      âœ“ should include inactive categories when requested (2 ms)
      âœ“ should handle findByType errors (7 ms)
    findByStatus
      âœ“ should find categories by status (2 ms)
      âœ“ should handle findByStatus errors (2 ms)
    findRootCategories
      âœ“ should find all root categories (2 ms)
      âœ“ should filter root categories by type (2 ms)
      âœ“ should handle findRootCategories errors (4 ms)
    findChildCategories
      âœ“ should find child categories (active only) (4 ms)
      âœ“ should include inactive children when requested (2 ms)
      âœ“ should handle findChildCategories errors (3 ms)
    findCategoryTree
      âœ“ should find full category tree (2 ms)
      âœ“ should find tree starting from specific parent (2 ms)
      âœ“ should handle findCategoryTree errors (3 ms)
    findCategoriesWithRules
      âœ“ should find categories with rules (8 ms)
      âœ“ should filter by type (2 ms)
      âœ“ should handle findCategoriesWithRules errors (2 ms)
    findDefaultCategories
      âœ“ should find default categories (3 ms)
      âœ“ should filter default categories by type (2 ms)
      âœ“ should handle findDefaultCategories errors (3 ms)
    findSystemCategories
      âœ“ should find system categories (4 ms)
      âœ“ should filter system categories by type (3 ms)
      âœ“ should handle findSystemCategories errors (3 ms)
    searchCategories
      âœ“ should search categories by name and description (3 ms)
      âœ“ should filter search by type (3 ms)
      âœ“ should handle searchCategories errors (3 ms)
    isSlugAvailable
      âœ“ should return true when slug is available (2 ms)
      âœ“ should return false when slug is taken (8 ms)
      âœ“ should exclude specified category from check (5 ms)
      âœ“ should handle isSlugAvailable errors (3 ms)
    updateStatus
      âœ“ should update category status (3 ms)
      âœ“ should return null when category not found (2 ms)
      âœ“ should handle updateStatus errors (2 ms)
    moveCategory
      âœ“ should move category to new parent (3 ms)
      âœ“ should move category to root level (2 ms)
      âœ“ should handle moveCategory errors (3 ms)
    updateSortOrder
      âœ“ should update category sort order (2 ms)
      âœ“ should handle updateSortOrder errors (2 ms)
    getCategoryUsageStats
      âœ“ should get category usage statistics (4 ms)
      âœ“ should handle null values in stats (7 ms)
      âœ“ should handle getCategoryUsageStats errors (4 ms)
    findMatchingCategories
      âœ“ should find matching categories based on keywords (3 ms)
      âœ“ should match by merchant patterns (2 ms)
      âœ“ should match by amount ranges (1 ms)
      âœ“ should return empty array when no matches (2 ms)
      âœ“ should handle findMatchingCategories errors (2 ms)
    archiveAndReassign
      âœ“ should archive category and reassign transactions (3 ms)
      âœ“ should handle archiveAndReassign errors (4 ms)
    createDefaultCategories
      âœ“ should create default categories (4 ms)
      âœ“ should handle createDefaultCategories errors (4 ms)
    updateRules
      âœ“ should update category rules (4 ms)
      âœ“ should handle updateRules errors (2 ms)
    updateMetadata
      âœ“ should update category metadata (8 ms)
      âœ“ should handle updateMetadata errors (4 ms)
    reorderCategories
      âœ“ should reorder categories under parent (3 ms)
      âœ“ should reorder categories at root level (3 ms)
      âœ“ should handle reorderCategories errors (3 ms)
    Edge Cases
      âœ“ should handle empty string slug (1 ms)
      âœ“ should handle special characters in search (1 ms)
      âœ“ should handle large category trees (2 ms)
      âœ“ should handle category with no transactions in usage stats (2 ms)

PASS @money-wise/backend __tests__/unit/auth/services/password-security.service.spec.ts
  PasswordSecurityService
    hashPassword
      âœ“ should hash password with bcrypt (300 ms)
      âœ“ should hash password with argon2 (157 ms)
    verifyPassword
      âœ“ should verify bcrypt password correctly (838 ms)
      âœ“ should verify argon2 password correctly (490 ms)
      âœ“ should auto-detect hashing algorithm (866 ms)
    validatePassword
      âœ“ should validate strong password (3 ms)
      âœ“ should reject weak password (3 ms)
    isPasswordExpired
      âœ“ should return false for recent password (2 ms)
      âœ“ should return true for old password (3 ms)
    getDaysUntilExpiration
      âœ“ should calculate days until expiration correctly (3 ms)
    shouldWarnPasswordExpiry
      âœ“ should warn when password expires soon (2 ms)
      âœ“ should not warn when password is not expiring soon (3 ms)

[31m[Nest] 1289685  - [39m10/02/2025, 11:37:51 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError setting up 2FA:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:51 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mBadRequestException: User not found[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:51 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError setting up 2FA:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:51 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: QR generation failed[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA setup:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError disabling 2FA:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Failed to verify two-factor authentication[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError checking 2FA status:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError generating new backup codes:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:52 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
PASS @money-wise/backend __tests__/unit/auth/services/two-factor-auth.service.spec.ts
  TwoFactorAuthService
    setupTwoFactor
      âœ“ should generate 2FA setup with secret, QR code, and backup codes (6 ms)
      âœ“ should throw error if user not found (17 ms)
      âœ“ should throw error if QR code generation fails (4 ms)
      âœ“ should store setup data with 10-minute expiration (9 ms)
      âœ“ should generate unique backup codes (3 ms)
    verifyAndEnable2FA
      âœ“ should enable 2FA with valid token (4 ms)
      âœ“ should throw error for invalid token (2 ms)
      âœ“ should throw error if setup data not found (3 ms)
      âœ“ should throw error if setup data expired (1107 ms)
      âœ“ should handle Redis errors gracefully (4 ms)
    verifyTwoFactor
      âœ“ should verify valid TOTP token (4 ms)
      âœ“ should verify valid backup code when TOTP fails (5 ms)
      âœ“ should throw error for already used backup code (9 ms)
      âœ“ should throw error for invalid token and backup code (3 ms)
      âœ“ should throw error if 2FA not enabled (3 ms)
      âœ“ should handle Redis errors gracefully (3 ms)
    disable2FA
      âœ“ should disable 2FA with valid token (2 ms)
      âœ“ should throw error for invalid token when disabling (3 ms)
      âœ“ should handle Redis errors gracefully (3 ms)
    is2FAEnabled
      âœ“ should return true if 2FA is enabled (2 ms)
      âœ“ should return false if 2FA is not enabled (2 ms)
      âœ“ should return false on Redis errors (2 ms)
    generateNewBackupCodes
      âœ“ should generate new backup codes with valid token (9 ms)
      âœ“ should throw error for invalid token when generating new codes (3 ms)
      âœ“ should throw error if 2FA not enabled (2 ms)
      âœ“ should handle Redis errors gracefully (3 ms)
    onModuleDestroy
      âœ“ should close Redis connection on module destroy (3 ms)

PASS @money-wise/backend __tests__/unit/auth/auth.controller.spec.ts
  AuthController
    register
      âœ“ should register a new user successfully (8 ms)
      âœ“ should throw ConflictException when user already exists (10 ms)
      âœ“ should handle invalid registration data (4 ms)
    login
      âœ“ should login user successfully (2 ms)
      âœ“ should throw UnauthorizedException with invalid credentials (3 ms)
      âœ“ should throw UnauthorizedException for inactive user (9 ms)
      âœ“ should handle empty credentials (3 ms)
    refreshToken
      âœ“ should refresh token successfully (3 ms)
      âœ“ should throw UnauthorizedException with invalid refresh token (3 ms)
      âœ“ should throw UnauthorizedException with expired refresh token (2 ms)
      âœ“ should handle malformed refresh token (5 ms)
    getProfile
      âœ“ should return current user profile (5 ms)
      âœ“ should include virtual properties in profile (2 ms)
      âœ“ should handle user with null optional fields (4 ms)
    logout
      âœ“ should logout successfully (3 ms)
      âœ“ should handle logout for any authenticated user (2 ms)
    error handling
      âœ“ should propagate service errors correctly (7 ms)
      âœ“ should handle unexpected errors during login (2 ms)

PASS @money-wise/backend __tests__/unit/common/interceptors/sentry.interceptor.spec.ts
  SentryInterceptor
    intercept
      âœ“ should create interceptor instance (1 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/transaction.repository.spec.ts
  TransactionRepository
    findByAccountId
      âœ“ should find transactions by account ID (6 ms)
      âœ“ should apply date range filters (2 ms)
      âœ“ should apply pagination (2 ms)
      âœ“ should include hidden transactions when requested (4 ms)
      âœ“ should handle findByAccountId errors (24 ms)
    findByCategoryId
      âœ“ should find transactions by category ID (10 ms)
      âœ“ should apply date range and pagination (4 ms)
      âœ“ should handle findByCategoryId errors (4 ms)
    findByUserId
      âœ“ should find transactions by user ID (4 ms)
      âœ“ should apply complex filters (3 ms)
      âœ“ should handle findByUserId errors (4 ms)
    findByPlaidTransactionId
      âœ“ should find transaction by Plaid ID (3 ms)
      âœ“ should return null when Plaid transaction not found (2 ms)
      âœ“ should handle findByPlaidTransactionId errors (3 ms)
    findByType
      âœ“ should find transactions by type (2 ms)
      âœ“ should apply optional filters (2 ms)
      âœ“ should handle findByType errors (6 ms)
    findByStatus
      âœ“ should find transactions by status (3 ms)
      âœ“ should apply optional filters (4 ms)
      âœ“ should handle findByStatus errors (4 ms)
    findBySource
      âœ“ should find transactions by source (4 ms)
      âœ“ should apply optional filters (3 ms)
      âœ“ should handle findBySource errors (3 ms)
    findUncategorized
      âœ“ should find uncategorized transactions (3 ms)
      âœ“ should apply optional filters (2 ms)
      âœ“ should handle findUncategorized errors (2 ms)
    findDuplicates
      âœ“ should find duplicate transactions (3 ms)
      âœ“ should apply duplicate detection options (2 ms)
      âœ“ should handle findDuplicates errors (2 ms)
    findRecent
      âœ“ should find recent transactions (9 ms)
      âœ“ should use custom days and limit (3 ms)
      âœ“ should handle findRecent errors (3 ms)
    searchTransactions
      âœ“ should search transactions by term (2 ms)
      âœ“ should apply search filters (3 ms)
      âœ“ should handle searchTransactions errors (3 ms)
    getTransactionStats
      âœ“ should get transaction statistics (5 ms)
      âœ“ should handle getTransactionStats errors (3 ms)
    updateCategory
      âœ“ should update transaction category (2 ms)
      âœ“ should handle null category (uncategorize) (2 ms)
      âœ“ should return null when transaction not found (2 ms)
      âœ“ should handle updateCategory errors (3 ms)
    updateDescription
      âœ“ should update transaction description (6 ms)
      âœ“ should handle updateDescription errors (1 ms)
    toggleHidden
      âœ“ should toggle hidden status from false to true (2 ms)
      âœ“ should toggle hidden status from true to false (2 ms)
      âœ“ should return null when transaction not found (2 ms)
      âœ“ should handle toggleHidden errors (3 ms)
    addNotes
      âœ“ should add notes to transaction (2 ms)
      âœ“ should handle addNotes errors (1 ms)
    addTags
      âœ“ should add tags to transaction (1 ms)
      âœ“ should handle addTags errors (1 ms)
    getMonthlySpendingByCategory
      âœ“ should throw not implemented error (2 ms)
    createSplit
      âœ“ should throw not implemented error (2 ms)
    bulkCategorize
      âœ“ should throw not implemented error (7 ms)
    findNeedingCategorization
      âœ“ should throw not implemented error (3 ms)
    getCashFlow
      âœ“ should throw not implemented error (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/user.repository.spec.ts
  UserRepository
    findByEmail
      âœ“ should find user by email with case insensitivity (6 ms)
      âœ“ should return null when user not found (3 ms)
      âœ“ should handle findByEmail errors (17 ms)
    isEmailTaken
      âœ“ should return true when email is taken (2 ms)
      âœ“ should return false when email is not taken (2 ms)
      âœ“ should exclude specific user when checking email availability (4 ms)
      âœ“ should handle isEmailTaken errors (4 ms)
    findByEmailVerificationToken
      âœ“ should return null for email verification token (not implemented) (3 ms)
      âœ“ should handle findByEmailVerificationToken errors (3 ms)
    findByPasswordResetToken
      âœ“ should return null for password reset token (not implemented) (2 ms)
      âœ“ should handle findByPasswordResetToken errors (7 ms)
    markEmailAsVerified
      âœ“ should mark email as verified successfully (2 ms)
      âœ“ should return false when no user was updated (2 ms)
      âœ“ should handle markEmailAsVerified errors (2 ms)
    updatePasswordHash
      âœ“ should update password hash successfully (3 ms)
      âœ“ should return false when no user was updated (2 ms)
      âœ“ should handle updatePasswordHash errors (2 ms)
    setPasswordResetToken
      âœ“ should return false for password reset token (not implemented) (2 ms)
      âœ“ should handle setPasswordResetToken errors (1 ms)
    clearPasswordResetToken
      âœ“ should return false for clear password reset token (not implemented) (1 ms)
      âœ“ should handle clearPasswordResetToken errors (2 ms)
    findWithAccounts
      âœ“ should find user with their accounts (2 ms)
      âœ“ should return null when user not found (2 ms)
      âœ“ should handle findWithAccounts errors (7 ms)
    findByDateRange
      âœ“ should find users within date range (3 ms)
      âœ“ should handle findByDateRange errors (3 ms)
    getUserStats
      âœ“ should return user statistics (4 ms)
      âœ“ should handle getUserStats errors (4 ms)
    softDelete
      âœ“ should log soft delete request (3 ms)
      âœ“ should handle softDelete errors (2 ms)
    search
      âœ“ should search users by first name, last name, and email (3 ms)
      âœ“ should use default limit when not provided (3 ms)
      âœ“ should handle search errors (3 ms)

[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError validating reset token:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError resetting password:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Database error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError getting password reset stats:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError cleaning up expired tokens:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError revoking user tokens:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:57 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
PASS @money-wise/backend __tests__/unit/auth/services/password-reset.service.spec.ts
  PasswordResetService
    Token Generation (requestPasswordReset)
      âœ“ should generate and store reset token for valid user (8 ms)
      âœ“ should prevent multiple token generation within 5 minutes (9 ms)
      âœ“ should set token expiration to 30 minutes from creation (6 ms)
      âœ“ should store token data with metadata in Redis (4 ms)
      âœ“ should clean up expired tokens before creating new one (3 ms)
      âœ“ should handle database errors gracefully during token creation (3 ms)
      âœ“ should log token generation in audit trail (3 ms)
    Rate Limiting
      âœ“ should reject request when rate limit exceeded (3 ms)
      âœ“ should reject request when account is locked out (5 ms)
      âœ“ should log rate limit events in audit trail (4 ms)
    User Enumeration Prevention
      âœ“ should return same success message for non-existent users (11 ms)
      âœ“ should return same success message for inactive users (5 ms)
      âœ“ should record failed attempts for non-existent users (5 ms)
    Token Validation (validateResetToken)
      âœ“ should accept valid unexpired tokens (3 ms)
      âœ“ should reject expired tokens (2 ms)
      âœ“ should reject already-used tokens (3 ms)
      âœ“ should reject invalid token format (2 ms)
      âœ“ should reject tokens for non-existent users (3 ms)
      âœ“ should reject tokens for inactive users (3 ms)
      âœ“ should handle validation errors gracefully (2 ms)
    Password Reset (resetPassword)
      âœ“ should reset password successfully with valid token (3 ms)
      âœ“ should reject mismatched passwords (6 ms)
      âœ“ should reject weak passwords (4 ms)
      âœ“ should mark token as used after successful reset (2 ms)
      âœ“ should clear rate limits after successful reset (2 ms)
      âœ“ should log successful password reset in audit trail (3 ms)
      âœ“ should return email verification requirement status (2 ms)
      âœ“ should handle password change errors gracefully (2 ms)
    Token Management
      âœ“ should handle token cleanup errors gracefully (3 ms)
      âœ“ should not cleanup recent tokens (< 5 minutes old) (3 ms)
    Statistics and Maintenance
      âœ“ should return password reset statistics (3 ms)
      âœ“ should handle errors in statistics gracefully (10 ms)
      âœ“ should cleanup all expired tokens (3 ms)
      âœ“ should handle cleanup errors gracefully (2 ms)
      âœ“ should revoke all tokens for a specific user (2 ms)
      âœ“ should handle revocation when no tokens exist (3 ms)
      âœ“ should handle revocation errors gracefully (4 ms)
    Resource Cleanup
      âœ“ should cleanup Redis connection on module destroy (3 ms)

[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError generating verification token:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis connection failed[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError verifying email:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database connection failed[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError resending verification email:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError checking verification requirement:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError getting token info:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError cleaning up expired tokens:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError getting verification stats:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:58 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
PASS @money-wise/backend __tests__/unit/auth/services/email-verification.service.spec.ts
  EmailVerificationService
    generateVerificationToken
      âœ“ should generate and store verification token for valid user (7 ms)
      âœ“ should set token expiration to 24 hours from creation (3 ms)
      âœ“ should generate unique tokens for multiple calls (3 ms)
      âœ“ should handle Redis errors gracefully during token generation (18 ms)
      âœ“ should store both token data and user reverse lookup (2 ms)
    verifyEmail
      âœ“ should successfully verify email with valid token (3 ms)
      âœ“ should reject invalid token (3 ms)
      âœ“ should reject token for non-existent user (5 ms)
      âœ“ should handle already verified email gracefully (8 ms)
      âœ“ should sanitize user data in response (exclude password) (4 ms)
      âœ“ should handle database errors during verification (3 ms)
      â—‹ skipped should reject expired token - FIX IN PHASE 4 (date comparison bug)
      â—‹ skipped should reject token if email does not match user - FIX IN PHASE 4 (mock setup issue)
    resendVerificationEmail
      âœ“ should resend verification email for valid user (2 ms)
      âœ“ should reject resend for non-existent user (4 ms)
      âœ“ should reject resend for already verified email (3 ms)
      âœ“ should clean up expired existing token before generating new one (3 ms)
      âœ“ should handle database errors during resend (2 ms)
      â—‹ skipped should prevent resending if token was sent recently (within 1 hour) - FIX IN PHASE 4
      â—‹ skipped should allow resending if existing token expires soon (less than 1 hour) - FIX IN PHASE 4
    isVerificationRequired
      âœ“ should return true for unverified user (2 ms)
      âœ“ should return false for verified user (3 ms)
      âœ“ should return true for non-existent user (fail-safe) (2 ms)
      âœ“ should return true on database error (fail-safe) (2 ms)
    getTokenInfo
      âœ“ should return token information for valid token (3 ms)
      âœ“ should return null for non-existent token (10 ms)
      âœ“ should handle Redis errors gracefully (4 ms)
    cleanupExpiredTokens
      âœ“ should return 0 if no expired tokens found (5 ms)
      âœ“ should handle Redis errors gracefully during cleanup (3 ms)
      â—‹ skipped should delete expired tokens - FIX IN PHASE 4
    getVerificationStats
      âœ“ should return zero stats on error (9 ms)
      â—‹ skipped should return correct statistics - FIX IN PHASE 4
    onModuleDestroy
      âœ“ should close Redis connection on module destroy (4 ms)

[31m[Nest] 1289685  - [39m10/02/2025, 11:37:59 PM [31m  ERROR[39m [38;5;3m[AuthSecurityService] [39m[31mLogin error:[39m
[31m[Nest] 1289685  - [39m10/02/2025, 11:37:59 PM [31m  ERROR[39m [38;5;3m[AuthSecurityService] [39m[31mTypeError: Cannot read properties of undefined (reading 'isLocked')[39m
PASS @money-wise/backend __tests__/unit/auth/auth-security.service.spec.ts
  AuthSecurityService
    âœ“ should be defined (5 ms)
    register
      âœ“ should successfully register a new user (7 ms)
      âœ“ should throw ConflictException if user already exists (15 ms)
      âœ“ should throw BadRequestException for weak password (3 ms)
    login
      âœ“ should successfully login with valid credentials (3 ms)
      âœ“ should throw UnauthorizedException if account is locked (2 ms)
      âœ“ should throw UnauthorizedException for invalid credentials (4 ms)
      âœ“ should record failed attempt on invalid password (2 ms)
    changePassword
      âœ“ should successfully change password (2 ms)
      âœ“ should throw UnauthorizedException for invalid current password (8 ms)
      âœ“ should throw BadRequestException for weak new password (2 ms)
      âœ“ should throw BadRequestException if new password is same as current (2 ms)
    requestPasswordReset
      âœ“ should request password reset (2 ms)
    verifyEmail
      âœ“ should verify email successfully (2 ms)
    checkPasswordStrength
      âœ“ should return password strength analysis (3 ms)
    refreshToken
      âœ“ should successfully refresh token (2 ms)
      âœ“ should throw UnauthorizedException for invalid token (2 ms)

PASS @money-wise/backend __tests__/unit/auth/auth.service.spec.ts
  AuthService
    register
      âœ“ should register a new user successfully (6 ms)
      âœ“ should throw ConflictException if user already exists (23 ms)
    login
      âœ“ should login user successfully (5 ms)
      âœ“ should throw UnauthorizedException if user not found (4 ms)
      âœ“ should throw UnauthorizedException if password is invalid (3 ms)
      âœ“ should throw UnauthorizedException if user is not active (2 ms)
    refreshToken
      âœ“ should refresh token successfully with valid refresh token (3 ms)
      âœ“ should throw UnauthorizedException with invalid refresh token (3 ms)
      âœ“ should throw UnauthorizedException if user not found (9 ms)
      âœ“ should throw UnauthorizedException if user is not active (2 ms)
      âœ“ should throw UnauthorizedException with expired refresh token (3 ms)
    validateUser
      âœ“ should return user if valid (2 ms)
      âœ“ should throw UnauthorizedException if user not found (2 ms)
      âœ“ should throw UnauthorizedException if user is not active (2 ms)
    generateAuthResponse
      âœ“ should generate proper auth response with tokens (3 ms)
    error scenarios
      âœ“ should handle password hashing errors during registration (3 ms)
      âœ“ should handle database errors during user creation (2 ms)
      âœ“ should handle password verification errors during login (3 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/base.repository.spec.ts
  BaseRepository
    constructor
      âœ“ should initialize repository with correct entity (4 ms)
    create
      âœ“ should create and save a new entity successfully (2 ms)
      âœ“ should handle creation errors and throw descriptive error (30 ms)
    save
      âœ“ should save an existing entity successfully (3 ms)
      âœ“ should handle save errors (2 ms)
    findById
      âœ“ should find entity by ID successfully (4 ms)
      âœ“ should return null when entity not found (4 ms)
      âœ“ should handle findById errors (2 ms)
    findOne
      âœ“ should find one entity with FindOptionsWhere (2 ms)
      âœ“ should find one entity with FindOneOptions (2 ms)
      âœ“ should handle findOne errors (11 ms)
    find
      âœ“ should find multiple entities with options (9 ms)
      âœ“ should find all entities when no options provided (3 ms)
      âœ“ should handle find errors (3 ms)
    findWithPagination
      âœ“ should return paginated results (2 ms)
      âœ“ should handle pagination with criteria (4 ms)
      âœ“ should handle pagination errors (4 ms)
    update
      âœ“ should update entity successfully (2 ms)
      âœ“ should return null when entity to update not found (5 ms)
      âœ“ should handle update errors (2 ms)
    delete
      âœ“ should delete entity successfully (2 ms)
      âœ“ should return false when no entity was deleted (2 ms)
      âœ“ should handle delete errors (2 ms)
    deleteBy
      âœ“ should delete entities by criteria (2 ms)
      âœ“ should handle deleteBy errors (11 ms)
    count
      âœ“ should count entities with criteria (2 ms)
      âœ“ should count all entities when no criteria provided (2 ms)
      âœ“ should handle count errors (2 ms)
    exists
      âœ“ should return true when entity exists (2 ms)
      âœ“ should return false when entity does not exist (3 ms)
      âœ“ should handle exists errors (4 ms)
    bulkInsert
      âœ“ should perform bulk insert successfully (3 ms)
      âœ“ should handle bulk insert errors (3 ms)
    bulkUpdate
      âœ“ should perform bulk update successfully (2 ms)
      âœ“ should handle bulk update errors (1 ms)
    query
      âœ“ should execute raw query successfully (2 ms)
      âœ“ should execute parameterized query (2 ms)
      âœ“ should handle query errors (8 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/account.repository.spec.ts
  AccountRepository
    findByUserId
      âœ“ should find accounts by user ID (6 ms)
      âœ“ should handle findByUserId errors (27 ms)
    findActiveAccountsByUserId
      âœ“ should find active accounts by user ID (3 ms)
      âœ“ should handle findActiveAccountsByUserId errors (5 ms)
    updateBalance
      âœ“ should update account currentBalance successfully (3 ms)
      âœ“ should return false when no account was updated (2 ms)
      âœ“ should handle updateBalance errors (2 ms)
    incrementBalance
      âœ“ should increment account currentBalance successfully (3 ms)
      âœ“ should return false when no account was updated (2 ms)
      âœ“ should handle incrementBalance errors (2 ms)
    decrementBalance
      âœ“ should decrement account currentBalance successfully (2 ms)
      âœ“ should handle decrementBalance errors (9 ms)
    getTotalBalanceForUser
      âœ“ should get total currentBalance for user (2 ms)
      âœ“ should return 0 when no total found (2 ms)
      âœ“ should handle getTotalBalanceForUser errors (2 ms)
    findByPlaidAccountId
      âœ“ should find account by Plaid account ID (2 ms)
      âœ“ should return null when Plaid account not found (2 ms)
      âœ“ should handle findByPlaidAccountId errors (1 ms)
    deactivateAccount
      âœ“ should deactivate account successfully (2 ms)
      âœ“ should return false when no account was deactivated (2 ms)
      âœ“ should handle deactivateAccount errors (3 ms)
    reactivateAccount
      âœ“ should reactivate account successfully (1 ms)
      âœ“ should handle reactivateAccount errors (2 ms)
    findAccountsForSync
      âœ“ should find accounts for sync with user filter (8 ms)
      âœ“ should find all accounts for sync without user filter (2 ms)
      âœ“ should handle findAccountsForSync errors (2 ms)
    getAccountBalancesSummary
      âœ“ should get account currentBalances summary by type (3 ms)
      âœ“ should handle getAccountBalancesSummary errors (2 ms)
    findLowBalanceAccounts
      âœ“ should find low currentBalance accounts with user filter (2 ms)
      âœ“ should handle findLowBalanceAccounts errors (2 ms)

PASS @money-wise/backend __tests__/unit/auth/jwt.strategy.spec.ts
  JwtStrategy
    constructor
      âœ“ should be defined (10 ms)
      âœ“ should configure strategy with correct options (2 ms)
    validate
      âœ“ should return user for valid payload (2 ms)
      âœ“ should throw UnauthorizedException when user validation fails (7 ms)
      âœ“ should throw UnauthorizedException with custom message for invalid token (2 ms)
      âœ“ should handle payload with different user roles (3 ms)
      âœ“ should handle payload with missing fields (3 ms)
      âœ“ should handle payload with invalid user ID format (2 ms)
      âœ“ should handle null or undefined payload gracefully (2 ms)
      âœ“ should handle empty payload object (11 ms)
      âœ“ should propagate specific error messages from AuthService (3 ms)
      âœ“ should handle concurrent validation requests (3 ms)
    error scenarios
      âœ“ should handle AuthService throwing non-UnauthorizedException errors (3 ms)
      âœ“ should handle AuthService returning null unexpectedly (4 ms)
      âœ“ should handle malformed JWT payload structure (2 ms)

PASS @money-wise/backend __tests__/unit/auth/controllers/password.controller.spec.ts
  PasswordController
    checkPasswordStrength
      âœ“ should return password strength result (4 ms)
    changePassword
      âœ“ should change password successfully (3 ms)
      âœ“ should throw error for mismatched passwords (19 ms)
      âœ“ should throw error when rate limited (3 ms)
      âœ“ should throw error for incorrect current password (4 ms)
    requestPasswordReset
      âœ“ should request password reset successfully (3 ms)
    validateResetToken
      âœ“ should validate reset token successfully (2 ms)
      âœ“ should return invalid for bad token (3 ms)
    resetPassword
      âœ“ should reset password successfully (2 ms)
      âœ“ should throw error for failed reset (2 ms)
    getPasswordPolicy
      âœ“ should return password policy (2 ms)
    getPasswordStatus
      âœ“ should return password status (9 ms)
      âœ“ should return expired status (3 ms)

PASS @money-wise/backend __tests__/unit/auth/jwt-auth.guard.spec.ts
  JwtAuthGuard
    canActivate
      âœ“ should return true for public routes (4 ms)
      âœ“ should call super.canActivate for protected routes (2 ms)
      âœ“ should handle undefined public key (2 ms)
      âœ“ should properly check method and class decorators (8 ms)
    handleRequest
      âœ“ should return user when no error and user exists (3 ms)
      âœ“ should throw UnauthorizedException when error exists (8 ms)
      âœ“ should throw UnauthorizedException when user is null (4 ms)
      âœ“ should throw UnauthorizedException when user is undefined (2 ms)
      âœ“ should throw custom UnauthorizedException with proper message (3 ms)
      âœ“ should prioritize original error over missing user (5 ms)
      âœ“ should handle falsy user values (4 ms)
      âœ“ should handle truthy user values (2 ms)
    integration scenarios
      âœ“ should handle public route with missing user gracefully (2 ms)
      âœ“ should handle protected route with valid token (1 ms)

PASS @money-wise/backend __tests__/unit/auth/services/password-strength.service.spec.ts
  PasswordStrengthService
    calculateStrength
      âœ“ should return very weak for simple passwords (5 ms)
      âœ“ should return strong for complex passwords (3 ms)
      âœ“ should detect common passwords (2 ms)
      âœ“ should detect personal information in password (2 ms)
      âœ“ should detect repeating characters (2 ms)
      âœ“ should detect sequential characters (2 ms)
    validatePolicy
      âœ“ should validate minimum length requirement (7 ms)
      âœ“ should validate character requirements (2 ms)
      âœ“ should pass for valid passwords (1 ms)

PASS @money-wise/backend __tests__/unit/docs/openapi.spec.ts
  OpenAPI Specification
    âœ“ should generate valid OpenAPI spec (1 ms)

PASS @money-wise/backend __tests__/unit/common/decorators/sentry-transaction.decorator.spec.ts
  SentryTransactionDecorator
    withSentryTransaction
      âœ“ should wrap function with Sentry transaction (1 ms)
      âœ“ should handle errors in wrapped function (3 ms)
    SentryTransactionManager
      âœ“ should manage transaction lifecycle (1 ms)

Test Suites: 22 passed, 22 total
Tests:       6 skipped, 477 passed, 483 total
Snapshots:   0 total
Time:        48.878 s
Ran all test suites matching /__tests__\/unit/i.
