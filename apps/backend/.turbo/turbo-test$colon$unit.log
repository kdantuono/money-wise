
> @money-wise/backend@0.4.1 test:unit /home/nemesi/dev/money-wise/apps/backend
> jest --passWithNoTests --testPathPattern='__tests__/unit'

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError recording failed attempt:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError: Redis connection failed[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError clearing failed attempts:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError getting lockout info:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError unlocking account:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError getting lockout stats:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError updating user lockout status:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError: Database error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError recording failed attempt:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:07 PM [31m  ERROR[39m [38;5;3m[AccountLockoutService] [39m[31mError: Connection refused[39m
FAIL @money-wise/backend __tests__/unit/auth/services/account-lockout.service.spec.ts (7.707 s)
  AccountLockoutService
    recordFailedAttempt
      âœ• should record first failed attempt (20 ms)
      âœ• should increment failed attempts on subsequent failures (7 ms)
      âœ“ should lock account after max failed attempts (6 ms)
      âœ• should apply progressive lockout duration (7 ms)
      âœ“ should cap progressive lockout at 24 hours (5 ms)
      âœ• should reset failed attempts after reset time (4 ms)
      âœ“ should return current lockout if account is already locked (10 ms)
      âœ• should reset failed attempts to 0 after lockout (4 ms)
      âœ• should increment lockout count on each lockout (4 ms)
      âœ“ should update user status to SUSPENDED when locked by email (9 ms)
      âœ“ should update user status to SUSPENDED when locked by user ID (3 ms)
      âœ“ should use custom lockout settings (3 ms)
      âœ“ should handle Redis errors gracefully (5 ms)
      âœ“ should set appropriate expiration on lockout data (3 ms)
    clearFailedAttempts
      âœ“ should clear lockout data on successful login (3 ms)
      âœ“ should update user status to ACTIVE when unlocking by email (3 ms)
      âœ“ should update user status to ACTIVE when unlocking by user ID (2 ms)
      âœ“ should not update status if user is not SUSPENDED (3 ms)
      âœ“ should handle user not found gracefully (4 ms)
      âœ“ should handle Redis errors gracefully (10 ms)
    getLockoutInfo
      âœ“ should return lockout info for active lockout (3 ms)
      âœ“ should return unlocked info when no lockout exists (3 ms)
      âœ“ should return unlocked info when lockout has expired (3 ms)
      âœ“ should return failed attempts even when not locked (3 ms)
      âœ“ should handle Redis errors gracefully (3 ms)
    unlockAccount
      âœ“ should manually unlock an account (admin function) (3 ms)
      âœ“ should handle unlocking non-existent lockout (3 ms)
      âœ“ should handle Redis errors gracefully (2 ms)
    getLockoutStats
      âœ“ should return statistics for currently locked accounts (11 ms)
      âœ“ should exclude expired lockouts from stats (2 ms)
      âœ“ should limit recent lockouts to 10 entries (3 ms)
      âœ“ should sort recent lockouts by lockedUntil descending (2 ms)
      âœ“ should handle empty lockout data (3 ms)
      âœ“ should handle Redis errors gracefully (4 ms)
    Progressive Lockout Calculation
      âœ• should calculate progressive lockout durations correctly (4 ms)
      âœ“ should cap at 24 hours even with high lockout count (3 ms)
      âœ“ should disable progressive lockout when configured (4 ms)
    User Status Integration
      âœ“ should distinguish between email and user ID identifiers (9 ms)
      âœ“ should not update status if user is already ACTIVE (5 ms)
      âœ“ should not update status if user is INACTIVE (6 ms)
      âœ“ should handle database errors gracefully (4 ms)
    onModuleDestroy
      âœ“ should close Redis connection on module destroy (3 ms)
      âœ“ should handle null Redis instance gracefully (2 ms)
    Edge Cases and Boundary Conditions
      âœ“ should handle concurrent failed attempts correctly (4 ms)
      âœ• should handle time boundary conditions for reset (4 ms)
      âœ• should handle malformed Redis data gracefully (3 ms)
      âœ“ should handle Redis connection errors with safe defaults (4 ms)
      âœ“ should handle lockout at exact max attempts boundary (4 ms)

  â— AccountLockoutService â€º recordFailedAttempt â€º should record first failed attempt

    expect(received).toBe(expected) // Object.is equality

    Expected: "1"
    Received: 1

      104 |       const key = `lockout:${identifier}`;
      105 |       const data = await mockRedis.hmget(key, 'failedAttempts', 'firstFailedAt');
    > 106 |       expect(data[0]).toBe('1');
          |                       ^
      107 |       expect(data[1]).toBeDefined();
      108 |     });
      109 |

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:106:23)

  â— AccountLockoutService â€º recordFailedAttempt â€º should increment failed attempts on subsequent failures

    expect(received).toBe(expected) // Object.is equality

    Expected: "3"
    Received: 3

      127 |       // Verify count was incremented
      128 |       const data = await mockRedis.hmget(key, 'failedAttempts');
    > 129 |       expect(data[0]).toBe('3');
          |                       ^
      130 |     });
      131 |
      132 |     it('should lock account after max failed attempts', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:129:23)

  â— AccountLockoutService â€º recordFailedAttempt â€º should apply progressive lockout duration

    expect(received).toBeLessThanOrEqual(expected)

    Expected: <= 1759498448020
    Received:    1759502047019

      174 |       const expectedLockout = Date.now() + (60 * 60 * 1000);
      175 |       expect(result.lockedUntil!.getTime()).toBeGreaterThanOrEqual(expectedLockout - 1000);
    > 176 |       expect(result.lockedUntil!.getTime()).toBeLessThanOrEqual(expectedLockout + 1000);
          |                                             ^
      177 |     });
      178 |
      179 |     it('should cap progressive lockout at 24 hours', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:176:45)

  â— AccountLockoutService â€º recordFailedAttempt â€º should reset failed attempts after reset time

    expect(received).toBe(expected) // Object.is equality

    Expected: "1"
    Received: 1

      218 |       // Verify new firstFailedAt was set
      219 |       const data = await mockRedis.hmget(key, 'failedAttempts', 'firstFailedAt');
    > 220 |       expect(data[0]).toBe('1');
          |                       ^
      221 |       expect(parseInt(data[1]!)).toBeGreaterThan(oldFirstFailedAt);
      222 |     });
      223 |

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:220:23)

  â— AccountLockoutService â€º recordFailedAttempt â€º should reset failed attempts to 0 after lockout

    expect(received).toBe(expected) // Object.is equality

    Expected: "0"
    Received: null

      257 |       // Verify failedAttempts was reset to 0 (not incremented further)
      258 |       const data = await mockRedis.hmget(key, 'failedAttempts');
    > 259 |       expect(data[0]).toBe('0');
          |                       ^
      260 |     });
      261 |
      262 |     it('should increment lockout count on each lockout', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:259:23)

  â— AccountLockoutService â€º recordFailedAttempt â€º should increment lockout count on each lockout

    expect(received).toBe(expected) // Object.is equality

    Expected: "1"
    Received: 1

      274 |
      275 |       const data = await mockRedis.hmget(key, 'lockoutCount');
    > 276 |       expect(data[0]).toBe('1');
          |                       ^
      277 |     });
      278 |
      279 |     it('should update user status to SUSPENDED when locked by email', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:276:23)

  â— AccountLockoutService â€º Progressive Lockout Calculation â€º should calculate progressive lockout durations correctly

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1759498446150
    Received:    1759496647150

      698 |
      699 |         expect(result.isLocked).toBe(true);
    > 700 |         expect(result.lockedUntil!.getTime()).toBeGreaterThanOrEqual(expectedLockout - 1000);
          |                                               ^
      701 |         expect(result.lockedUntil!.getTime()).toBeLessThanOrEqual(expectedLockout + 1000);
      702 |       }
      703 |     });

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:700:47)

  â— AccountLockoutService â€º Edge Cases and Boundary Conditions â€º should handle time boundary conditions for reset

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      856 |
      857 |       // Should be treated as expired and reset
    > 858 |       expect(result.isLocked).toBe(false);
          |                               ^
      859 |       expect(result.failedAttempts).toBe(1);
      860 |     });
      861 |

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:858:31)

  â— AccountLockoutService â€º Edge Cases and Boundary Conditions â€º should handle malformed Redis data gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: NaN

      875 |
      876 |       expect(result.isLocked).toBe(false);
    > 877 |       expect(result.failedAttempts).toBe(1);
          |                                     ^
      878 |     });
      879 |
      880 |     it('should handle Redis connection errors with safe defaults', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:877:37)

FAIL @money-wise/backend __tests__/unit/users/users.service.spec.ts
  UsersService
    findAll
      âœ“ should return paginated users with default pagination (8 ms)
      âœ“ should return paginated users with custom pagination (3 ms)
      âœ“ should return empty array when no users exist (3 ms)
      âœ“ should handle large datasets with proper pagination (3 ms)
    findOne
      âœ“ should return a user by id (3 ms)
      âœ“ should throw NotFoundException when user not found (13 ms)
      âœ“ should include accounts relation in response (3 ms)
    findByEmail
      âœ“ should return a user by email (7 ms)
      âœ“ should return null when user not found (3 ms)
    update
      âœ“ should allow user to update their own profile (4 ms)
      âœ“ should allow admin to update any user profile (4 ms)
      âœ“ should throw ForbiddenException when non-admin tries to update another user (4 ms)
      âœ“ should throw NotFoundException when user not found (2 ms)
      âœ“ should check email uniqueness when updating email (2 ms)
      âœ• should throw ConflictException when email already in use (13 ms)
      âœ“ should not check email uniqueness when email unchanged (3 ms)
      âœ“ should update multiple fields at once (2 ms)
    updateStatus
      âœ“ should allow admin to update user status (3 ms)
      âœ“ should throw ForbiddenException when non-admin tries to update status (3 ms)
      âœ“ should throw NotFoundException when user not found (9 ms)
      âœ“ should update status to ACTIVE (4 ms)
      âœ“ should update status to INACTIVE (4 ms)
    remove
      âœ“ should allow admin to delete user (5 ms)
      âœ“ should throw ForbiddenException when non-admin tries to delete user (2 ms)
      âœ“ should throw NotFoundException when user not found (2 ms)
      âœ“ should not call repository.remove when authorization fails (5 ms)
    getStats
      âœ“ should return user statistics (3 ms)
      âœ“ should return zero stats when no users exist (2 ms)
      âœ“ should call count with correct status filters (2 ms)
    toResponseDto (private method - tested through public methods)
      âœ“ should map user to response DTO correctly (2 ms)
      âœ“ should exclude sensitive fields like passwordHash (3 ms)
      âœ• should include computed properties (3 ms)
    edge cases and error handling
      âœ“ should handle repository errors gracefully (9 ms)
      âœ“ should handle invalid UUID format (2 ms)
      âœ“ should handle save errors during update (2 ms)
      âœ“ should handle concurrent update scenarios (4 ms)

  â— UsersService â€º update â€º should throw ConflictException when email already in use

    expect(received).rejects.toThrow(expected)

    Expected message: "Email already in use"
    Received message: "Cannot read properties of undefined (reading 'id')"

          123 |   private toResponseDto(user: User): UserResponseDto {
          124 |     return {
        > 125 |       id: user.id,
              |                ^
          126 |       email: user.email,
          127 |       firstName: user.firstName,
          128 |       lastName: user.lastName,

      at UsersService.toResponseDto (src/users/users.service.ts:125:16)
      at UsersService.update (src/users/users.service.ts:76:17)
      at Object.<anonymous> (__tests__/unit/users/users.service.spec.ts:309:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (__tests__/unit/users/users.service.spec.ts:316:17)

  â— UsersService â€º toResponseDto (private method - tested through public methods) â€º should include computed properties

    expect(received).toBe(expected) // Object.is equality

    Expected: "Test User"
    Received: "New Name"

      582 |       const result = await service.findOne(mockUser.id);
      583 |
    > 584 |       expect(result.fullName).toBe('Test User');
          |                               ^
      585 |       expect(result.isEmailVerified).toBe(true);
      586 |       expect(result.isActive).toBe(true);
      587 |     });

      at Object.<anonymous> (__tests__/unit/users/users.service.spec.ts:584:31)

  console.log
    ğŸ³ Starting PostgreSQL test container...

      at DatabaseTestManager.start (src/core/database/tests/database-test.config.ts:53:15)

  console.log
    âœ… Test container started on port 33151

      at DatabaseTestManager.startContainer (src/core/database/tests/database-test.config.ts:92:15)

  console.log
    âœ… Test database initialized

      at DatabaseTestManager.initializeDataSource (src/core/database/tests/database-test.config.ts:144:15)

  console.warn
    âš ï¸ TimescaleDB extension not available: extension "timescaledb" is not available

      149 |         console.log('âœ… TimescaleDB extension enabled');
      150 |       } catch (error) {
    > 151 |         console.warn('âš ï¸ TimescaleDB extension not available:', error.message);
          |                 ^
      152 |       }
      153 |     } catch (error) {
      154 |       console.error('âŒ Failed to initialize test database:', error);

      at DatabaseTestManager.initializeDataSource (src/core/database/tests/database-test.config.ts:151:17)
      at DatabaseTestManager.start (src/core/database/tests/database-test.config.ts:60:5)
      at Object.<anonymous> (__tests__/unit/core/database/migrations/migration.test.ts:17:18)

  console.log
    ğŸ›‘ Test database stopped

      at DatabaseTestManager.stop (src/core/database/tests/database-test.config.ts:235:13)

PASS @money-wise/backend __tests__/unit/core/database/migrations/migration.test.ts (13.914 s)
  Database Migrations
    Schema Creation
      âœ“ should create all tables with correct structure (442 ms)
      âœ“ should create all required columns for users table (452 ms)
      âœ“ should create all required columns for accounts table (458 ms)
      âœ“ should create all required columns for transactions table (446 ms)
      âœ“ should create all required columns for categories table (460 ms)
    Indexes and Constraints
      âœ“ should create all required indexes (428 ms)
      âœ“ should create all foreign key constraints (484 ms)
      âœ“ should create unique constraints (441 ms)
    Migration Rollback
      âœ“ should be able to drop and recreate schema (733 ms)
      âœ“ should handle schema changes gracefully (749 ms)
    Data Type Validation
      âœ“ should validate JSONB columns work correctly (542 ms)
      âœ“ should validate enum constraints (444 ms)
      âœ“ should validate decimal precision for monetary values (448 ms)
    Performance and Scalability
      âœ“ should handle large schema operations efficiently (583 ms)
      âœ“ should validate entity metadata matches database schema (499 ms)

PASS @money-wise/backend __tests__/unit/core/database/entities/entity-relationships.test.ts (10.833 s)
  Entity Relationships
    User -> Account Relationship
      âœ“ should create user with multiple accounts (583 ms)
      âœ“ should cascade delete accounts when user is deleted (546 ms)
      âœ“ should enforce foreign key constraint (575 ms)
    Account -> Transaction Relationship
      âœ“ should create account with multiple transactions (512 ms)
      âœ“ should cascade delete transactions when account is deleted (586 ms)
    Category -> Transaction Relationship
      âœ“ should associate transaction with category (523 ms)
      âœ“ should handle category deletion with SET NULL (504 ms)
      âœ“ should allow transaction without category (466 ms)
    Category Tree Structure
      âœ“ should create parent-child category relationships (505 ms)
      âœ“ should cascade delete child categories when parent is deleted (532 ms)
      âœ“ should validate category tree depth (542 ms)
    Complex Relationship Queries
      âœ“ should find all transactions for a user across accounts (557 ms)
      âœ“ should calculate account balance from transactions (501 ms)
      âœ“ should find categories with transaction counts (518 ms)
    Constraint Validation
      âœ“ should enforce unique email constraint (476 ms)
      âœ“ should enforce unique category slug constraint (498 ms)
      âœ“ should enforce transaction amount precision (519 ms)
      âœ“ should enforce enum constraints (516 ms)
    Index Performance
      âœ“ should use indexes for common queries (563 ms)

PASS @money-wise/backend __tests__/unit/auth/services/password-security.service.spec.ts
  PasswordSecurityService
    hashPassword
      âœ“ should hash password with bcrypt (285 ms)
      âœ“ should hash password with argon2 (198 ms)
    verifyPassword
      âœ“ should verify bcrypt password correctly (828 ms)
      âœ“ should verify argon2 password correctly (568 ms)
      âœ“ should auto-detect hashing algorithm (923 ms)
    validatePassword
      âœ“ should validate strong password (3 ms)
      âœ“ should reject weak password (3 ms)
    isPasswordExpired
      âœ“ should return false for recent password (3 ms)
      âœ“ should return true for old password (2 ms)
    getDaysUntilExpiration
      âœ“ should calculate days until expiration correctly (2 ms)
    shouldWarnPasswordExpiry
      âœ“ should warn when password expires soon (2 ms)
      âœ“ should not warn when password is not expiring soon (2 ms)

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:37 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError setting up 2FA:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:37 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mBadRequestException: User not found[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:37 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError setting up 2FA:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:37 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: QR generation failed[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA setup:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError disabling 2FA:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError checking 2FA status:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError generating new backup codes:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: ECONNREFUSED: Redis connection refused[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError verifying 2FA setup:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:38 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mSyntaxError: Unexpected token 'i', "invalid-json{{{" is not valid JSON[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:39 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError generating new backup codes:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:39 PM [31m  ERROR[39m [38;5;3m[TwoFactorAuthService] [39m[31mError: Redis write failed[39m
PASS @money-wise/backend __tests__/unit/auth/services/two-factor-auth.service.spec.ts
  TwoFactorAuthService
    setupTwoFactor
      âœ“ should generate 2FA setup with secret, QR code, and backup codes (11 ms)
      âœ“ should throw error if user not found (17 ms)
      âœ“ should throw error if QR code generation fails (4 ms)
      âœ“ should store setup data with 10-minute expiration (3 ms)
      âœ“ should generate unique backup codes (3 ms)
    verifyAndEnable2FA
      âœ“ should enable 2FA with valid token (3 ms)
      âœ“ should throw error for invalid token (2 ms)
      âœ“ should throw error if setup data not found (8 ms)
      âœ“ should throw error if setup data expired (1117 ms)
      âœ“ should handle Redis errors gracefully (5 ms)
    verifyTwoFactor
      âœ“ should verify valid TOTP token (4 ms)
      âœ“ should verify valid backup code when TOTP fails (3 ms)
      âœ“ should throw error for already used backup code (3 ms)
      âœ“ should throw error for invalid token and backup code (3 ms)
      âœ“ should throw error if 2FA not enabled (2 ms)
      âœ“ should handle Redis errors gracefully (3 ms)
    disable2FA
      âœ“ should disable 2FA with valid token (9 ms)
      âœ“ should throw error for invalid token when disabling (3 ms)
      âœ“ should handle Redis errors gracefully (2 ms)
    is2FAEnabled
      âœ“ should return true if 2FA is enabled (2 ms)
      âœ“ should return false if 2FA is not enabled (3 ms)
      âœ“ should return false on Redis errors (4 ms)
    generateNewBackupCodes
      âœ“ should generate new backup codes with valid token (3 ms)
      âœ“ should throw error for invalid token when generating new codes (3 ms)
      âœ“ should throw error if 2FA not enabled (3 ms)
      âœ“ should handle Redis errors gracefully (4 ms)
    onModuleDestroy
      âœ“ should close Redis connection on module destroy (4 ms)
    Edge Cases and Advanced Scenarios
      âœ“ should handle backup code exhaustion (all codes used) (9 ms)
      âœ“ should handle concurrent 2FA setup attempts by same user (3 ms)
      âœ“ should handle 2FA verification with Redis connection failure (2 ms)
      âœ“ should handle backup code verification when only 1 code remains (3 ms)
      âœ“ should handle case-insensitive backup code verification (2 ms)
      âœ“ should prevent disabling 2FA with backup code (require TOTP) (2 ms)
      âœ“ should handle malformed 2FA setup data in Redis (3 ms)
      âœ“ should handle setup expiration edge case (expires during verification) (1104 ms)
      âœ“ should generate exactly 10 unique backup codes every time (3 ms)
      âœ“ should handle TOTP token validation at time boundary (clock skew) (3 ms)
      âœ“ should handle new backup code generation when Redis save fails (8 ms)

PASS @money-wise/backend __tests__/unit/auth/auth.controller.spec.ts
  AuthController
    register
      âœ“ should register a new user successfully (11 ms)
      âœ“ should throw ConflictException when user already exists (18 ms)
      âœ“ should handle invalid registration data (5 ms)
    login
      âœ“ should login user successfully (2 ms)
      âœ“ should throw UnauthorizedException with invalid credentials (2 ms)
      âœ“ should throw UnauthorizedException for inactive user (2 ms)
      âœ“ should handle empty credentials (3 ms)
    refreshToken
      âœ“ should refresh token successfully (3 ms)
      âœ“ should throw UnauthorizedException with invalid refresh token (2 ms)
      âœ“ should throw UnauthorizedException with expired refresh token (2 ms)
      âœ“ should handle malformed refresh token (8 ms)
    getProfile
      âœ“ should return current user profile (3 ms)
      âœ“ should include virtual properties in profile (3 ms)
      âœ“ should handle user with null optional fields (2 ms)
    logout
      âœ“ should logout successfully (3 ms)
      âœ“ should handle logout for any authenticated user (3 ms)
    changePassword
      âœ“ should change password successfully (3 ms)
      âœ“ should throw error for invalid current password (4 ms)
      âœ“ should throw error for weak new password (2 ms)
    requestPasswordReset
      âœ“ should request password reset successfully (2 ms)
      âœ“ should handle non-existent email gracefully (2 ms)
      âœ“ should handle service errors (7 ms)
    resetPassword
      âœ“ should reset password successfully (3 ms)
      âœ“ should throw error for invalid token (2 ms)
      âœ“ should throw error for weak password (3 ms)
      âœ“ should throw error for expired token (2 ms)
    validatePasswordResetToken
      âœ“ should validate token successfully (2 ms)
      âœ“ should return invalid for expired token (3 ms)
      âœ“ should return invalid for malformed token (2 ms)
    verifyEmail
      âœ“ should verify email successfully (2 ms)
      âœ“ should throw error for invalid token (3 ms)
      âœ“ should throw error for expired token (2 ms)
      âœ“ should throw error for already verified email (2 ms)
    resendEmailVerification
      âœ“ should resend verification email successfully (2 ms)
      âœ“ should throw error for already verified email (9 ms)
      âœ“ should handle rate limiting (3 ms)
      âœ“ should handle email service errors (3 ms)
    checkPasswordStrength
      âœ“ should return strong password result (2 ms)
      âœ“ should return weak password result (3 ms)
      âœ“ should detect password with user information (2 ms)
      âœ“ should handle empty password (2 ms)
    error handling
      âœ“ should propagate service errors correctly (2 ms)
      âœ“ should handle unexpected errors during login (2 ms)
      âœ“ should handle service timeout errors (3 ms)

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError generating verification token:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis connection failed[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError verifying email:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database connection failed[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError resending verification email:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError checking verification requirement:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Database error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError getting token info:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError cleaning up expired tokens:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError getting verification stats:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mError getting token info:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:41 PM [31m  ERROR[39m [38;5;3m[EmailVerificationService] [39m[31mSyntaxError: Unexpected token 'i', "invalid-json{{{" is not valid JSON[39m
PASS @money-wise/backend __tests__/unit/auth/services/email-verification.service.spec.ts
  EmailVerificationService
    generateVerificationToken
      âœ“ should generate and store verification token for valid user (5 ms)
      âœ“ should set token expiration to 24 hours from creation (2 ms)
      âœ“ should generate unique tokens for multiple calls (3 ms)
      âœ“ should handle Redis errors gracefully during token generation (24 ms)
      âœ“ should store both token data and user reverse lookup (4 ms)
    verifyEmail
      âœ“ should successfully verify email with valid token (3 ms)
      âœ“ should reject invalid token (2 ms)
      âœ“ should reject expired token (3 ms)
      âœ“ should reject token for non-existent user (3 ms)
      âœ“ should reject token if email does not match user (2 ms)
      âœ“ should handle already verified email gracefully (3 ms)
      âœ“ should sanitize user data in response (exclude password) (2 ms)
      âœ“ should handle database errors during verification (2 ms)
    resendVerificationEmail
      âœ“ should resend verification email for valid user (2 ms)
      âœ“ should reject resend for non-existent user (2 ms)
      âœ“ should reject resend for already verified email (8 ms)
      âœ“ should prevent resending if token was sent recently (within 1 hour) (2 ms)
      âœ“ should allow resending if existing token expires soon (less than 1 hour) (3 ms)
      âœ“ should clean up expired existing token before generating new one (5 ms)
      âœ“ should handle database errors during resend (3 ms)
    isVerificationRequired
      âœ“ should return true for unverified user (3 ms)
      âœ“ should return false for verified user (2 ms)
      âœ“ should return true for non-existent user (fail-safe) (2 ms)
      âœ“ should return true on database error (fail-safe) (3 ms)
    getTokenInfo
      âœ“ should return token information for valid token (2 ms)
      âœ“ should return null for non-existent token (2 ms)
      âœ“ should handle Redis errors gracefully (3 ms)
    cleanupExpiredTokens
      âœ“ should delete expired tokens (3 ms)
      âœ“ should return 0 if no expired tokens found (2 ms)
      âœ“ should handle Redis errors gracefully during cleanup (8 ms)
    getVerificationStats
      âœ“ should return correct statistics (2 ms)
      âœ“ should return zero stats on error (3 ms)
    onModuleDestroy
      âœ“ should close Redis connection on module destroy (3 ms)
    Edge Cases and Race Conditions
      âœ“ should handle multiple concurrent token generation requests (5 ms)
      âœ“ should handle token generation with special characters in email (3 ms)
      âœ“ should handle very long email addresses (3 ms)
      âœ“ should handle verification when Redis is slow (timeout scenario) (114 ms)
      âœ“ should handle cleanup when user has abandoned verification (never completed) (2 ms)
      âœ“ should handle getTokenInfo for malformed token data (5 ms)
      âœ“ should handle resend when previous token was manually deleted (4 ms)
      âœ“ should handle stats calculation with no tokens (2 ms)
      âœ“ should handle verification when user status changes between checks (3 ms)

PASS @money-wise/backend __tests__/unit/database/timescaledb.service.spec.ts
  TimescaleDBService
    onModuleInit
      âœ“ should initialize TimescaleDB when enabled in configuration (5 ms)
      âœ“ should skip initialization when disabled in configuration (3 ms)
      âœ“ should skip initialization when configuration is not provided (3 ms)
      âœ“ should handle missing TimescaleDB extension gracefully (2 ms)
      âœ“ should throw error when initialization fails (16 ms)
    createHypertable
      âœ“ should create a basic hypertable with required parameters (3 ms)
      âœ“ should create hypertable with partition column (2 ms)
      âœ“ should create hypertable with chunk time interval (6 ms)
      âœ“ should add compression policy when specified (2 ms)
      âœ“ should add retention policy when specified (2 ms)
      âœ“ should throw error when hypertable creation fails (3 ms)
    addCompressionPolicy
      âœ“ should add compression policy successfully (3 ms)
      âœ“ should configure compression with segmentby (2 ms)
      âœ“ should throw error when compression policy fails (2 ms)
    addRetentionPolicy
      âœ“ should add retention policy successfully (3 ms)
      âœ“ should throw error when retention policy fails (2 ms)
    isTableHypertable
      âœ“ should return true when table is a hypertable (3 ms)
      âœ“ should return false when table is not a hypertable (2 ms)
      âœ“ should return false when query returns empty result (2 ms)
      âœ“ should return false on database error and log error (2 ms)
    getHypertableStatus
      âœ“ should return hypertable status successfully (8 ms)
      âœ“ should throw error when status query fails (3 ms)
    createContinuousAggregate
      âœ“ should create continuous aggregate with refresh policy (2 ms)
      âœ“ should throw error when continuous aggregate creation fails (2 ms)
    getTimescaleDBInfo
      âœ“ should return complete TimescaleDB information (3 ms)
      âœ“ should throw error when info query fails (2 ms)
    optimizeHypertable
      âœ“ should optimize hypertable chunks successfully (2 ms)
      âœ“ should throw error when optimization fails (2 ms)
    getTransactionTrends
      âœ“ should get transaction trends without filters (2 ms)
      âœ“ should get transaction trends with account filter (2 ms)
      âœ“ should get transaction trends with date range (3 ms)
      âœ“ should support custom time bucket period (2 ms)
    getCategorySpendingTrends
      âœ“ should get category spending trends without category filter (2 ms)
      âœ“ should get category spending trends with category filter (9 ms)
      âœ“ should respect limit parameter (2 ms)
    getAccountBalanceHistory
      âœ“ should get account balance history (2 ms)
      âœ“ should support custom period and limit (3 ms)
    getTopMerchantSpending
      âœ“ should get top merchant spending without account filter (2 ms)
      âœ“ should get top merchant spending with account filter (2 ms)
      âœ“ should support custom period and limit (2 ms)
    detectSpendingAnomalies
      âœ“ should detect spending anomalies with default threshold (2 ms)
      âœ“ should support custom period and threshold (2 ms)
      âœ“ should filter only anomalies using z-score (2 ms)
    getTransactionVelocity
      âœ“ should get transaction velocity without account filter (2 ms)
      âœ“ should get transaction velocity with account filter (2 ms)
      âœ“ should support custom period (2 ms)
    getContinuousAggregateData
      âœ“ should get continuous aggregate data with default limit (2 ms)
      âœ“ should support custom limit (8 ms)
    refreshContinuousAggregate
      âœ“ should refresh continuous aggregate successfully (3 ms)
      âœ“ should throw error when refresh fails (3 ms)
    getChunkStatistics
      âœ“ should get chunk statistics for hypertable (3 ms)
      âœ“ should return empty array when no chunks found (2 ms)
      âœ“ should order chunks by range_start descending (2 ms)
    Edge cases and error handling
      âœ“ should handle SQL injection attempts in table names (2 ms)
      âœ“ should handle empty result sets gracefully (2 ms)
      âœ“ should handle null/undefined parameters in query methods (2 ms)
      âœ“ should handle database connection timeouts (2 ms)
      âœ“ should handle concurrent policy creation attempts (2 ms)
    Integration scenarios
      âœ“ should setup complete hypertable with all policies (2 ms)
      âœ“ should handle full initialization flow (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/transaction.repository.spec.ts
  TransactionRepository
    findByAccountId
      âœ“ should find transactions by account ID (5 ms)
      âœ“ should apply date range filters (2 ms)
      âœ“ should apply pagination (7 ms)
      âœ“ should include hidden transactions when requested (2 ms)
      âœ“ should handle findByAccountId errors (24 ms)
    findByCategoryId
      âœ“ should find transactions by category ID (2 ms)
      âœ“ should apply date range and pagination (2 ms)
      âœ“ should handle findByCategoryId errors (2 ms)
    findByUserId
      âœ“ should find transactions by user ID (3 ms)
      âœ“ should apply complex filters (2 ms)
      âœ“ should handle findByUserId errors (2 ms)
    findByPlaidTransactionId
      âœ“ should find transaction by Plaid ID (7 ms)
      âœ“ should return null when Plaid transaction not found (3 ms)
      âœ“ should handle findByPlaidTransactionId errors (2 ms)
    findByType
      âœ“ should find transactions by type (2 ms)
      âœ“ should apply optional filters (2 ms)
      âœ“ should handle findByType errors (2 ms)
    findByStatus
      âœ“ should find transactions by status (2 ms)
      âœ“ should apply optional filters (2 ms)
      âœ“ should handle findByStatus errors (2 ms)
    findBySource
      âœ“ should find transactions by source (3 ms)
      âœ“ should apply optional filters (3 ms)
      âœ“ should handle findBySource errors (2 ms)
    findUncategorized
      âœ“ should find uncategorized transactions (9 ms)
      âœ“ should apply optional filters (3 ms)
      âœ“ should handle findUncategorized errors (3 ms)
    findDuplicates
      âœ“ should find duplicate transactions (2 ms)
      âœ“ should apply duplicate detection options (2 ms)
      âœ“ should handle findDuplicates errors (2 ms)
    findRecent
      âœ“ should find recent transactions (5 ms)
      âœ“ should use custom days and limit (2 ms)
      âœ“ should handle findRecent errors (2 ms)
    searchTransactions
      âœ“ should search transactions by term (2 ms)
      âœ“ should apply search filters (2 ms)
      âœ“ should handle searchTransactions errors (2 ms)
    getTransactionStats
      âœ“ should get transaction statistics (9 ms)
      âœ“ should handle getTransactionStats errors (2 ms)
    updateCategory
      âœ“ should update transaction category (2 ms)
      âœ“ should handle null category (uncategorize) (1 ms)
      âœ“ should return null when transaction not found (3 ms)
      âœ“ should handle updateCategory errors (2 ms)
    updateDescription
      âœ“ should update transaction description (2 ms)
      âœ“ should handle updateDescription errors (2 ms)
    toggleHidden
      âœ“ should toggle hidden status from false to true (4 ms)
      âœ“ should toggle hidden status from true to false (2 ms)
      âœ“ should return null when transaction not found (4 ms)
      âœ“ should handle toggleHidden errors (4 ms)
    addNotes
      âœ“ should add notes to transaction (3 ms)
      âœ“ should handle addNotes errors (14 ms)
    addTags
      âœ“ should add tags to transaction (3 ms)
      âœ“ should handle addTags errors (3 ms)
    getMonthlySpendingByCategory
      âœ“ should throw not implemented error (3 ms)
    createSplit
      âœ“ should throw not implemented error (2 ms)
    bulkCategorize
      âœ“ should throw not implemented error (2 ms)
    findNeedingCategorization
      âœ“ should throw not implemented error (3 ms)
    getCashFlow
      âœ“ should throw not implemented error (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/user.repository.spec.ts
  UserRepository
    findByEmail
      âœ“ should find user by email (case-insensitive) (4 ms)
      âœ“ should convert email to lowercase before querying (2 ms)
      âœ“ should return null when user not found (1 ms)
      âœ“ should handle findByEmail errors (17 ms)
    isEmailTaken
      âœ“ should return true when email is taken (3 ms)
      âœ“ should return false when email is not taken (8 ms)
      âœ“ should exclude specific user when checking email availability (2 ms)
      âœ“ should return true when email exists for different user (2 ms)
      âœ“ should handle isEmailTaken errors (2 ms)
    findByEmailVerificationToken
      âœ“ should return null and log warning (not implemented) (2 ms)
      âœ“ should handle errors in findByEmailVerificationToken (3 ms)
    findByPasswordResetToken
      âœ“ should return null and log warning (not implemented) (3 ms)
      âœ“ should handle errors in findByPasswordResetToken (4 ms)
    markEmailAsVerified
      âœ“ should mark email as verified successfully (5 ms)
      âœ“ should return false when user not found (3 ms)
      âœ“ should return false when affected is undefined (2 ms)
      âœ“ should handle markEmailAsVerified errors (3 ms)
    updatePasswordHash
      âœ“ should update password hash successfully (8 ms)
      âœ“ should return false when user not found (1 ms)
      âœ“ should handle updatePasswordHash errors (2 ms)
    setPasswordResetToken
      âœ“ should return false and log warning (not implemented) (2 ms)
      âœ“ should handle errors in setPasswordResetToken (2 ms)
    clearPasswordResetToken
      âœ“ should return false and log warning (not implemented) (2 ms)
      âœ“ should handle errors in clearPasswordResetToken (2 ms)
    findWithAccounts
      âœ“ should find user with accounts successfully (2 ms)
      âœ“ should return null when user not found (2 ms)
      âœ“ should handle findWithAccounts errors (2 ms)
    findByDateRange
      âœ“ should find users within date range (3 ms)
      âœ“ should return empty array when no users found in range (3 ms)
      âœ“ should handle findByDateRange errors (11 ms)
    getUserStats
      âœ“ should return comprehensive user statistics (3 ms)
      âœ“ should calculate stats with zero users (3 ms)
      âœ“ should calculate stats with all verified users (2 ms)
      âœ“ should use 7-day window for recently created (2 ms)
      âœ“ should handle getUserStats errors (2 ms)
    softDelete
      âœ“ should log soft delete and return true (1 ms)
      âœ“ should handle softDelete errors (2 ms)
    search
      âœ“ should search users by firstName (2 ms)
      âœ“ should search users by lastName (2 ms)
      âœ“ should search users by email (2 ms)
      âœ“ should apply custom limit (1 ms)
      âœ“ should use default limit of 10 (13 ms)
      âœ“ should return empty array when no matches found (3 ms)
      âœ“ should handle partial matches (5 ms)
      âœ“ should handle search errors (7 ms)
      âœ“ should handle special characters in search query (3 ms)
      âœ“ should be case-insensitive (4 ms)

PASS @money-wise/backend __tests__/unit/auth/controllers/password.controller.spec.ts
  PasswordController
    checkPasswordStrength
      âœ“ should return password strength result (5 ms)
      âœ“ should return weak password result (4 ms)
      âœ“ should detect personal information in password (3 ms)
      âœ“ should validate without personal information context (3 ms)
    changePassword
      âœ“ should change password successfully (2 ms)
      âœ“ should throw error for mismatched passwords (24 ms)
      âœ“ should throw error when rate limited (2 ms)
      âœ“ should throw error for incorrect current password (3 ms)
      âœ“ should handle password change failure from service (2 ms)
      âœ“ should clear rate limit on successful change (2 ms)
      âœ“ should extract IP from various headers (2 ms)
    requestPasswordReset
      âœ“ should request password reset successfully (2 ms)
      âœ“ should handle non-existent email gracefully (2 ms)
      âœ“ should extract IP from x-real-ip header (2 ms)
      âœ“ should handle unknown IP address (2 ms)
    validateResetToken
      âœ“ should validate reset token successfully (2 ms)
      âœ“ should return invalid for bad token (3 ms)
      âœ“ should return invalid for expired token (3 ms)
      âœ“ should pass IP and user agent to service (3 ms)
    resetPassword
      âœ“ should reset password successfully (10 ms)
      âœ“ should throw error for failed reset (2 ms)
      âœ“ should throw error for mismatched passwords (2 ms)
      âœ“ should throw error for weak password (3 ms)
      âœ“ should throw error for expired token (4 ms)
    getPasswordPolicy
      âœ“ should return password policy (2 ms)
    getPasswordStatus
      âœ“ should return password status (2 ms)
      âœ“ should return expired status (2 ms)
      âœ“ should return warning status (3 ms)
      âœ“ should handle negative days until expiration (3 ms)
    IP extraction (getClientIp)
      âœ“ should extract IP from x-forwarded-for header (4 ms)
      âœ“ should extract IP from x-real-ip header (2 ms)
      âœ“ should extract IP from connection.remoteAddress (2 ms)
      âœ“ should extract IP from socket.remoteAddress (3 ms)
      âœ“ should return unknown when no IP is found (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/category.repository.spec.ts
  CategoryRepository
    findBySlug
      âœ“ should find category by slug (5 ms)
      âœ“ should return null when category not found (3 ms)
      âœ“ should handle findBySlug errors (28 ms)
    findByType
      âœ“ should find categories by type (active only) (3 ms)
      âœ“ should include inactive categories when requested (3 ms)
      âœ“ should handle findByType errors (2 ms)
    findByStatus
      âœ“ should find categories by status (3 ms)
      âœ“ should handle findByStatus errors (3 ms)
    findRootCategories
      âœ“ should find all root categories (3 ms)
      âœ“ should filter root categories by type (3 ms)
      âœ“ should handle findRootCategories errors (3 ms)
    findChildCategories
      âœ“ should find child categories (active only) (10 ms)
      âœ“ should include inactive children when requested (3 ms)
      âœ“ should handle findChildCategories errors (2 ms)
    findCategoryTree
      âœ“ should find full category tree (2 ms)
      âœ“ should find tree starting from specific parent (2 ms)
      âœ“ should handle findCategoryTree errors (2 ms)
    findCategoriesWithRules
      âœ“ should find categories with rules (2 ms)
      âœ“ should filter by type (2 ms)
      âœ“ should handle findCategoriesWithRules errors (2 ms)
    findDefaultCategories
      âœ“ should find default categories (2 ms)
      âœ“ should filter default categories by type (1 ms)
      âœ“ should handle findDefaultCategories errors (2 ms)
    findSystemCategories
      âœ“ should find system categories (3 ms)
      âœ“ should filter system categories by type (9 ms)
      âœ“ should handle findSystemCategories errors (3 ms)
    searchCategories
      âœ“ should search categories by name and description (3 ms)
      âœ“ should filter search by type (2 ms)
      âœ“ should handle searchCategories errors (3 ms)
    isSlugAvailable
      âœ“ should return true when slug is available (3 ms)
      âœ“ should return false when slug is taken (2 ms)
      âœ“ should exclude specified category from check (3 ms)
      âœ“ should handle isSlugAvailable errors (2 ms)
    updateStatus
      âœ“ should update category status (2 ms)
      âœ“ should return null when category not found (2 ms)
      âœ“ should handle updateStatus errors (2 ms)
    moveCategory
      âœ“ should move category to new parent (9 ms)
      âœ“ should move category to root level (2 ms)
      âœ“ should handle moveCategory errors (2 ms)
    updateSortOrder
      âœ“ should update category sort order (3 ms)
      âœ“ should handle updateSortOrder errors (2 ms)
    getCategoryUsageStats
      âœ“ should get category usage statistics (2 ms)
      âœ“ should handle null values in stats (2 ms)
      âœ“ should handle getCategoryUsageStats errors (2 ms)
    findMatchingCategories
      âœ“ should find matching categories based on keywords (3 ms)
      âœ“ should match by merchant patterns (4 ms)
      âœ“ should match by amount ranges (4 ms)
      âœ“ should return empty array when no matches (3 ms)
      âœ“ should handle findMatchingCategories errors (2 ms)
    archiveAndReassign
      âœ“ should archive category and reassign transactions (7 ms)
      âœ“ should handle archiveAndReassign errors (3 ms)
    createDefaultCategories
      âœ“ should create default categories (3 ms)
      âœ“ should handle createDefaultCategories errors (2 ms)
    updateRules
      âœ“ should update category rules (2 ms)
      âœ“ should handle updateRules errors (2 ms)
    updateMetadata
      âœ“ should update category metadata (3 ms)
      âœ“ should handle updateMetadata errors (2 ms)
    reorderCategories
      âœ“ should reorder categories under parent (2 ms)
      âœ“ should reorder categories at root level (2 ms)
      âœ“ should handle reorderCategories errors (2 ms)
    Edge Cases
      âœ“ should handle empty string slug (1 ms)
      âœ“ should handle special characters in search (7 ms)
      âœ“ should handle large category trees (4 ms)
      âœ“ should handle category with no transactions in usage stats (2 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/base.repository.spec.ts
  BaseRepository
    constructor
      âœ“ should initialize repository with correct entity (7 ms)
    create
      âœ“ should create and save a new entity successfully (2 ms)
      âœ“ should handle creation errors and throw descriptive error (25 ms)
    save
      âœ“ should save an existing entity successfully (4 ms)
      âœ“ should handle save errors (5 ms)
    findById
      âœ“ should find entity by ID successfully (4 ms)
      âœ“ should return null when entity not found (2 ms)
      âœ“ should handle findById errors (12 ms)
    findOne
      âœ“ should find one entity with FindOptionsWhere (3 ms)
      âœ“ should find one entity with FindOneOptions (4 ms)
      âœ“ should return null when no entity found (3 ms)
      âœ“ should handle findOne errors (3 ms)
    find
      âœ“ should find multiple entities with options (3 ms)
      âœ“ should find all entities when no options provided (3 ms)
      âœ“ should handle find errors (3 ms)
    findWithPagination
      âœ“ should return paginated results (3 ms)
      âœ“ should handle pagination with criteria (3 ms)
      âœ“ should handle pagination errors (2 ms)
    update
      âœ“ should update entity successfully (2 ms)
      âœ“ should return null when entity to update not found (10 ms)
      âœ“ should handle update errors (3 ms)
    delete
      âœ“ should delete entity successfully (2 ms)
      âœ“ should return false when no entity was deleted (2 ms)
      âœ“ should handle delete errors (3 ms)
    deleteBy
      âœ“ should delete entities by criteria (2 ms)
      âœ“ should return 0 when no entities match deletion criteria (3 ms)
      âœ“ should handle deleteBy errors (3 ms)
    count
      âœ“ should count entities with criteria (2 ms)
      âœ“ should count all entities when no criteria provided (2 ms)
      âœ“ should handle count errors (2 ms)
    exists
      âœ“ should return true when entity exists (2 ms)
      âœ“ should return false when entity does not exist (2 ms)
      âœ“ should handle exists errors (10 ms)
    bulkInsert
      âœ“ should perform bulk insert successfully (3 ms)
      âœ“ should handle bulk insert errors (4 ms)
    bulkUpdate
      âœ“ should perform bulk update successfully (3 ms)
      âœ“ should return 0 when no entities match update criteria (2 ms)
      âœ“ should handle bulk update errors (2 ms)
    query
      âœ“ should execute raw query successfully (3 ms)
      âœ“ should execute parameterized query (2 ms)
      âœ“ should handle query errors (2 ms)
    softDelete
      âœ“ should soft delete entity successfully (3 ms)
      âœ“ should return false when no entity was soft deleted (3 ms)
      âœ“ should handle soft delete errors (4 ms)
      âœ“ should handle null affected count (7 ms)
    restore
      âœ“ should restore soft deleted entity successfully (2 ms)
      âœ“ should return false when no entity was restored (3 ms)
      âœ“ should handle restore errors (2 ms)
      âœ“ should handle undefined affected count (2 ms)
    deleteMany
      âœ“ should delete multiple entities by criteria (3 ms)
      âœ“ should return 0 affected when no entities deleted (2 ms)
      âœ“ should handle null affected count (2 ms)
      âœ“ should handle deleteMany errors (3 ms)
    findAndCount
      âœ“ should find entities with total count (2 ms)
      âœ“ should find and count all entities without options (1 ms)
      âœ“ should handle empty result set (2 ms)
      âœ“ should handle findAndCount errors (7 ms)
    createBulk
      âœ“ should create multiple entities successfully (2 ms)
      âœ“ should handle empty array (2 ms)
      âœ“ should handle createBulk errors (3 ms)
    updateMany
      âœ“ should update multiple entities successfully (2 ms)
      âœ“ should handle zero updates (1 ms)
      âœ“ should handle null affected count (2 ms)
      âœ“ should handle updateMany errors (2 ms)
    existsBy
      âœ“ should return true when entity exists by criteria (2 ms)
      âœ“ should return false when entity does not exist (2 ms)
      âœ“ should return true when multiple entities match criteria (4 ms)
      âœ“ should handle existsBy errors (3 ms)
    protected methods
      createQueryBuilder
        âœ“ should create query builder with alias (2 ms)
        âœ“ should create query builder without alias (9 ms)
      manager
        âœ“ should access entity manager from repository (2 ms)
    edge cases
      findById with options
        âœ“ should apply FindOneOptions when finding by ID (3 ms)
      delete with undefined affected
        âœ“ should handle undefined affected count in delete (2 ms)
      update partial data
        âœ“ should handle partial entity updates (2 ms)
      findWithPagination edge cases
        âœ“ should handle first page pagination (2 ms)
        âœ“ should handle large page numbers (2 ms)
        âœ“ should handle very large limit values (2 ms)
      count with complex options
        âœ“ should handle count with where and order options (2 ms)

PASS @money-wise/backend __tests__/unit/users/users.controller.spec.ts
  UsersController
    âœ“ should be defined (5 ms)
    findAll
      âœ“ should return paginated users for admin (4 ms)
      âœ“ should support custom pagination parameters (9 ms)
      âœ“ should use default pagination when not provided (3 ms)
    getCurrentUser
      âœ“ should return current user profile (3 ms)
    getStats
      âœ“ should return user statistics (2 ms)
    findOne
      âœ“ should return user by ID (2 ms)
      âœ“ should throw NotFoundException when user not found (9 ms)
    update
      âœ“ should allow user to update own profile (3 ms)
      âœ“ should allow admin to update any user profile (2 ms)
      âœ“ should throw ForbiddenException when non-admin tries to update another user (2 ms)
      âœ“ should throw ConflictException when email already exists (3 ms)
      âœ“ should throw NotFoundException when user not found (2 ms)
    updateStatus
      âœ“ should allow admin to update user status (9 ms)
      âœ“ should throw ForbiddenException when non-admin tries to update status (3 ms)
      âœ“ should throw NotFoundException when user not found (2 ms)
      âœ“ should support all status transitions (3 ms)
    remove
      âœ“ should allow admin to delete user (2 ms)
      âœ“ should throw ForbiddenException when non-admin tries to delete user (2 ms)
      âœ“ should throw NotFoundException when user not found (2 ms)

PASS @money-wise/backend __tests__/unit/common/interceptors/sentry.interceptor.spec.ts
  SentryInterceptor
    intercept
      âœ“ should create interceptor instance (2 ms)

PASS @money-wise/backend __tests__/unit/accounts/accounts.controller.spec.ts
  AccountsController
    âœ“ should be defined (5 ms)
    create
      âœ“ should create an account for the current user (3 ms)
      âœ“ should create account with default currency if not provided (3 ms)
      âœ“ should create account with optional fields (2 ms)
    findAll
      âœ“ should return all accounts for current user (10 ms)
      âœ“ should return empty array when user has no accounts (2 ms)
      âœ“ should return multiple accounts (2 ms)
    getSummary
      âœ“ should return accounts summary (3 ms)
      âœ“ should return summary with no accounts (2 ms)
    findOne
      âœ“ should return account by ID for owner (2 ms)
      âœ“ should allow admin to access any account (2 ms)
      âœ“ should throw NotFoundException when account not found (11 ms)
      âœ“ should throw ForbiddenException when user tries to access another user account (2 ms)
    getBalance
      âœ“ should return account balance (2 ms)
      âœ“ should return balance with null available balance (2 ms)
      âœ“ should throw ForbiddenException when accessing another user balance (3 ms)
      âœ“ should throw NotFoundException when account not found (2 ms)
    update
      âœ“ should allow user to update own account (11 ms)
      âœ“ should allow admin to update any account (2 ms)
      âœ“ should throw ForbiddenException when non-owner tries to update (2 ms)
      âœ“ should throw NotFoundException when account not found (3 ms)
      âœ“ should update status (2 ms)
      âœ“ should update settings (2 ms)
    remove
      âœ“ should allow user to delete own account (2 ms)
      âœ“ should allow admin to delete any account (2 ms)
      âœ“ should throw ForbiddenException when non-owner tries to delete (2 ms)
      âœ“ should throw NotFoundException when account not found (2 ms)
    syncAccount
      âœ“ should sync Plaid account (3 ms)
      âœ“ should throw ForbiddenException when trying to sync manual account (2 ms)
      âœ“ should throw ForbiddenException when non-owner tries to sync (2 ms)
      âœ“ should throw NotFoundException when account not found (3 ms)

PASS @money-wise/backend __tests__/unit/core/database/repositories/account.repository.spec.ts
  AccountRepository
    findByUserId
      âœ“ should find accounts by user ID (5 ms)
      âœ“ should handle findByUserId errors (25 ms)
    findActiveAccountsByUserId
      âœ“ should find active accounts by user ID (3 ms)
      âœ“ should handle findActiveAccountsByUserId errors (2 ms)
    updateBalance
      âœ“ should update account currentBalance successfully (2 ms)
      âœ“ should return false when no account was updated (2 ms)
      âœ“ should handle updateBalance errors (3 ms)
    incrementBalance
      âœ“ should increment account currentBalance successfully (3 ms)
      âœ“ should return false when no account was updated (2 ms)
      âœ“ should handle incrementBalance errors (2 ms)
      âœ“ should increment account balance (1 ms)
      âœ“ should return false if account not found (2 ms)
      âœ“ should handle incrementBalance errors (2 ms)
    decrementBalance
      âœ“ should decrement account currentBalance successfully (2 ms)
      âœ“ should handle decrementBalance errors (12 ms)
      âœ“ should decrement account balance (2 ms)
      âœ“ should handle decrementBalance errors (2 ms)
    getTotalBalanceForUser
      âœ“ should get total currentBalance for user (4 ms)
      âœ“ should return 0 when no total found (3 ms)
      âœ“ should handle getTotalBalanceForUser errors (2 ms)
    findByPlaidAccountId
      âœ“ should find account by Plaid account ID (3 ms)
      âœ“ should return null when Plaid account not found (2 ms)
      âœ“ should handle findByPlaidAccountId errors (3 ms)
    deactivateAccount
      âœ“ should deactivate account successfully (2 ms)
      âœ“ should return false when no account was deactivated (2 ms)
      âœ“ should handle deactivateAccount errors (3 ms)
    reactivateAccount
      âœ“ should reactivate account successfully (2 ms)
      âœ“ should handle reactivateAccount errors (3 ms)
    findAccountsForSync
      âœ“ should find accounts for sync with user filter (10 ms)
      âœ“ should find all accounts for sync without user filter (2 ms)
      âœ“ should handle findAccountsForSync errors (2 ms)
    getAccountBalancesSummary
      âœ“ should get account currentBalances summary by type (2 ms)
      âœ“ should handle getAccountBalancesSummary errors (2 ms)
    findLowBalanceAccounts
      âœ“ should find low currentBalance accounts with user filter (2 ms)
      âœ“ should handle findLowBalanceAccounts errors (3 ms)
    findByType
      âœ“ should find accounts by type with userId (2 ms)
      âœ“ should find accounts by type without userId (3 ms)
      âœ“ should handle findByType errors (3 ms)
    findByPlaidItemId
      âœ“ should find accounts by Plaid item ID (4 ms)
      âœ“ should return empty array if no accounts found (2 ms)
      âœ“ should handle findByPlaidItemId errors (7 ms)
    updateLastSyncedAt
      âœ“ should update sync timestamp successfully (2 ms)
      âœ“ should return false if account not found (2 ms)
      âœ“ should handle update errors (2 ms)
    findWithTransactions
      âœ“ should find account with transactions and apply limit (2 ms)
      âœ“ should use default limit of 50 (2 ms)
      âœ“ should return null if account not found (1 ms)
      âœ“ should handle errors (7 ms)
    findByCurrency
      âœ“ should find accounts by currency with userId (2 ms)
      âœ“ should find accounts by currency without userId (2 ms)
      âœ“ should handle errors (4 ms)
    groupByInstitution
      âœ“ should group accounts by institution with totals (4 ms)
      âœ“ should return empty array if no accounts found (4 ms)
      âœ“ should handle errors (2 ms)

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError validating reset token:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError resetting password:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Database error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mFailed to generate password reset token for test@example.com:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mTypeError: tokenData.createdAt.getTime is not a function[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError getting password reset stats:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError cleaning up expired tokens:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError revoking user tokens:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:51 PM [31m  ERROR[39m [38;5;3m[PasswordResetService] [39m[31mError: Redis error[39m
PASS @money-wise/backend __tests__/unit/auth/services/password-reset.service.spec.ts
  PasswordResetService
    Token Generation (requestPasswordReset)
      âœ“ should generate and store reset token for valid user (6 ms)
      âœ“ should prevent multiple token generation within 5 minutes (3 ms)
      âœ“ should set token expiration to 30 minutes from creation (2 ms)
      âœ“ should store token data with metadata in Redis (3 ms)
      âœ“ should clean up expired tokens before creating new one (8 ms)
      âœ“ should handle database errors gracefully during token creation (3 ms)
      âœ“ should log token generation in audit trail (2 ms)
    Rate Limiting
      âœ“ should reject request when rate limit exceeded (3 ms)
      âœ“ should reject request when account is locked out (3 ms)
      âœ“ should log rate limit events in audit trail (4 ms)
    User Enumeration Prevention
      âœ“ should return same success message for non-existent users (3 ms)
      âœ“ should return same success message for inactive users (2 ms)
      âœ“ should record failed attempts for non-existent users (3 ms)
    Token Validation (validateResetToken)
      âœ“ should accept valid unexpired tokens (2 ms)
      âœ“ should reject expired tokens (3 ms)
      âœ“ should reject already-used tokens (9 ms)
      âœ“ should reject invalid token format (2 ms)
      âœ“ should reject tokens for non-existent users (3 ms)
      âœ“ should reject tokens for inactive users (3 ms)
      âœ“ should handle validation errors gracefully (2 ms)
    Password Reset (resetPassword)
      âœ“ should reset password successfully with valid token (4 ms)
      âœ“ should reject mismatched passwords (2 ms)
      âœ“ should reject weak passwords (3 ms)
      âœ“ should mark token as used after successful reset (2 ms)
      âœ“ should clear rate limits after successful reset (3 ms)
      âœ“ should log successful password reset in audit trail (10 ms)
      âœ“ should return email verification requirement status (4 ms)
      âœ“ should handle password change errors gracefully (3 ms)
    Token Management
      âœ“ should handle token cleanup errors gracefully (3 ms)
      âœ“ should not cleanup recent tokens (< 5 minutes old) (3 ms)
    Statistics and Maintenance
      âœ“ should return password reset statistics (2 ms)
      âœ“ should handle errors in statistics gracefully (2 ms)
      âœ“ should cleanup all expired tokens (3 ms)
      âœ“ should handle cleanup errors gracefully (3 ms)
      âœ“ should revoke all tokens for a specific user (3 ms)
      âœ“ should handle revocation when no tokens exist (2 ms)
      âœ“ should handle revocation errors gracefully (8 ms)
    Resource Cleanup
      âœ“ should cleanup Redis connection on module destroy (4 ms)

PASS @money-wise/backend __tests__/unit/auth/auth.service.spec.ts
  AuthService
    register
      âœ“ should register a new user successfully (6 ms)
      âœ“ should throw ConflictException if user already exists (15 ms)
    login
      âœ“ should login user successfully (4 ms)
      âœ“ should throw UnauthorizedException if user not found (8 ms)
      âœ“ should throw UnauthorizedException if password is invalid (3 ms)
      âœ“ should throw UnauthorizedException if user is not active (3 ms)
    refreshToken
      âœ“ should refresh token successfully with valid refresh token (3 ms)
      âœ“ should throw UnauthorizedException with invalid refresh token (4 ms)
      âœ“ should throw UnauthorizedException if user not found (3 ms)
      âœ“ should throw UnauthorizedException if user is not active (2 ms)
      âœ“ should throw UnauthorizedException with expired refresh token (3 ms)
    validateUser
      âœ“ should return user if valid (2 ms)
      âœ“ should throw UnauthorizedException if user not found (7 ms)
      âœ“ should throw UnauthorizedException if user is not active (3 ms)
    generateAuthResponse
      âœ“ should generate proper auth response with tokens (5 ms)
    error scenarios
      âœ“ should handle password hashing errors during registration (6 ms)
      âœ“ should handle database errors during user creation (2 ms)
      âœ“ should handle password verification errors during login (3 ms)

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:53 PM [31m  ERROR[39m [38;5;3m[AuthSecurityService] [39m[31mLogin error:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:53 PM [31m  ERROR[39m [38;5;3m[AuthSecurityService] [39m[31mTypeError: Cannot read properties of undefined (reading 'isLocked')[39m
PASS @money-wise/backend __tests__/unit/auth/auth-security.service.spec.ts
  AuthSecurityService
    âœ“ should be defined (11 ms)
    register
      âœ“ should successfully register a new user (4 ms)
      âœ“ should throw ConflictException if user already exists (19 ms)
      âœ“ should throw BadRequestException for weak password (4 ms)
    login
      âœ“ should successfully login with valid credentials (4 ms)
      âœ“ should throw UnauthorizedException if account is locked (4 ms)
      âœ“ should throw UnauthorizedException for invalid credentials (5 ms)
      âœ“ should record failed attempt on invalid password (3 ms)
    changePassword
      âœ“ should successfully change password (11 ms)
      âœ“ should throw UnauthorizedException for invalid current password (3 ms)
      âœ“ should throw BadRequestException for weak new password (2 ms)
      âœ“ should throw BadRequestException if new password is same as current (4 ms)
    requestPasswordReset
      âœ“ should request password reset (2 ms)
    verifyEmail
      âœ“ should verify email successfully (4 ms)
    checkPasswordStrength
      âœ“ should return password strength analysis (4 ms)
    refreshToken
      âœ“ should successfully refresh token (3 ms)
      âœ“ should throw UnauthorizedException for invalid token (2 ms)

PASS @money-wise/backend __tests__/unit/auth/jwt.strategy.spec.ts
  JwtStrategy
    constructor
      âœ“ should be defined (6 ms)
      âœ“ should configure strategy with correct options (3 ms)
    validate
      âœ“ should return user for valid payload (2 ms)
      âœ“ should throw UnauthorizedException when user validation fails (8 ms)
      âœ“ should throw UnauthorizedException with custom message for invalid token (2 ms)
      âœ“ should handle payload with different user roles (2 ms)
      âœ“ should handle payload with missing fields (2 ms)
      âœ“ should handle payload with invalid user ID format (2 ms)
      âœ“ should handle null or undefined payload gracefully (8 ms)
      âœ“ should handle empty payload object (2 ms)
      âœ“ should propagate specific error messages from AuthService (2 ms)
      âœ“ should handle concurrent validation requests (2 ms)
    error scenarios
      âœ“ should handle AuthService throwing non-UnauthorizedException errors (2 ms)
      âœ“ should handle AuthService returning null unexpectedly (3 ms)
      âœ“ should handle malformed JWT payload structure (3 ms)

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mFailed to log audit event:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mError: ID generation failed[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] suspicious_activity: anonymous from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894876_xnxcog6fs",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.876Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894876_xnxcog6fs",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.876Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: anonymous from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894880_uum2p72jh",
  "eventType": "account_locked",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.880Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894880_uum2p72jh",
  "eventType": "account_locked",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.880Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-123 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894898_5vmas3dhx",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-123",
  "email": "test@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "failedAttempts": 5,
    "lockDuration": 3600
  },
  "timestamp": "2025-10-03T12:34:54.898Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894898_5vmas3dhx",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-123",
  "email": "test@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "failedAttempts": 5,
    "lockDuration": 3600
  },
  "timestamp": "2025-10-03T12:34:54.898Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] suspicious_activity: user-123 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894900_clgjnny0f",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "userId": "user-123",
  "email": "test@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "description": "Multiple failed 2FA attempts from different IPs"
  },
  "timestamp": "2025-10-03T12:34:54.900Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894900_clgjnny0f",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "userId": "user-123",
  "email": "test@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "description": "Multiple failed 2FA attempts from different IPs"
  },
  "timestamp": "2025-10-03T12:34:54.900Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] suspicious_activity: anonymous from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894903_9vvju4n2o",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "description": "Brute force attack detected"
  },
  "timestamp": "2025-10-03T12:34:54.903Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894903_9vvju4n2o",
  "eventType": "suspicious_activity",
  "severity": "critical",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {
    "description": "Brute force attack detected"
  },
  "timestamp": "2025-10-03T12:34:54.903Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894916_pvmjolzw7",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.916Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894916_pvmjolzw7",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.916Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894919_7ym27og58",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.919Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894919_7ym27og58",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.919Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894922_0woo1yexw",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.922Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894922_0woo1yexw",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.922Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894925_xmkf6zijf",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.925Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894925_xmkf6zijf",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.925Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894928_l4c92j67k",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.928Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894928_l4c92j67k",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.928Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894931_azwliaeq9",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.931Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894931_azwliaeq9",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.931Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894933_wxhy3ogec",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.933Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894933_wxhy3ogec",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.933Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894937_quec7rk8u",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.937Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894937_quec7rk8u",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.937Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894940_mttifwayg",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.940Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894940_mttifwayg",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.940Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894945_nagjx8hxv",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.945Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894945_nagjx8hxv",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.945Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894953_oa9t3et4v",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.953Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894953_oa9t3et4v",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.953Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894955_c7o6ni6ab",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.955Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894955_c7o6ni6ab",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.955Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894958_9n3v13rwj",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.958Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894958_9n3v13rwj",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.958Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894961_a0a69g72i",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.961Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894961_a0a69g72i",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.961Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mError querying audit logs:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mTypeError: this.auditLogs is not iterable[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894964_gyppbdgvk",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.964Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894964_gyppbdgvk",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.964Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894966_5t3ks0f68",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.966Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894966_5t3ks0f68",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.966Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894969_cbngmrrk2",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.969Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894969_cbngmrrk2",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.969Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894971_nf6eb8b6n",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.971Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894971_nf6eb8b6n",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.971Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894974_va669wmfo",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.974Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894974_va669wmfo",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.974Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894976_37fiayzw2",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.976Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894976_37fiayzw2",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.976Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894979_okqhd8oa3",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.979Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894979_okqhd8oa3",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.979Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894981_xh3f49gcv",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.981Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894981_xh3f49gcv",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.981Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894991_ny673tudt",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.991Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894991_ny673tudt",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.991Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894994_yz3j1tslp",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.994Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894994_yz3j1tslp",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.994Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mError getting audit stats:[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mTypeError: Cannot read properties of null (reading 'filter')[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31m[AUDIT] account_locked: user-2 from 192.168.1.1[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894998_lghjt7qi2",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.998Z"
}

[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mSECURITY ALERT[39m
[31m[Nest] 2204799  - [39m10/03/2025, 2:34:54 PM [31m  ERROR[39m [38;5;3m[AuditLogService] [39m[31mObject:[39m
{
  "id": "audit_1759494894998_lghjt7qi2",
  "eventType": "account_locked",
  "severity": "critical",
  "userId": "user-2",
  "email": "user2@example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0",
  "details": {},
  "timestamp": "2025-10-03T12:34:54.998Z"
}

PASS @money-wise/backend __tests__/unit/auth/services/audit-log.service.spec.ts
  AuditLogService
    logEvent
      âœ“ should log a basic audit event (6 ms)
      âœ“ should extract client IP from x-forwarded-for header (3 ms)
      âœ“ should extract client IP from x-real-ip header when x-forwarded-for not available (4 ms)
      âœ“ should fall back to connection.remoteAddress for IP (2 ms)
      âœ“ should use "unknown" when no IP can be determined (3 ms)
      âœ“ should extract session ID from x-session-id header (2 ms)
      âœ“ should extract user-agent from request (2 ms)
      âœ“ should use "unknown" for missing user-agent (2 ms)
      âœ“ should store custom details in audit event (2 ms)
      âœ“ should not throw on logging errors (2 ms)
      âœ“ should cap audit logs at maxLogEntries (10000) (13 ms)
    determineSeverity
      âœ“ should assign CRITICAL severity to suspicious activity (2 ms)
      âœ“ should assign CRITICAL severity to account locked (4 ms)
      âœ“ should assign HIGH severity to login failed (2 ms)
      âœ“ should assign HIGH severity to rate limit exceeded (2 ms)
      âœ“ should assign MEDIUM severity to password change success (3 ms)
      âœ“ should assign LOW severity to login success (2 ms)
    logLoginSuccess
      âœ“ should log successful login with user details (3 ms)
    logLoginFailed
      âœ“ should log failed login attempt with reason (3 ms)
    logAccountLocked
      âœ“ should log account lockout with details (3 ms)
    logSuspiciousActivity
      âœ“ should log suspicious activity with description (2 ms)
      âœ“ should log anonymous suspicious activity (2 ms)
    logPasswordChange
      âœ“ should log successful password change (9 ms)
      âœ“ should log failed password change (2 ms)
    queryLogs
      âœ“ should query all logs without filters (3 ms)
      âœ“ should filter logs by userId (2 ms)
      âœ“ should filter logs by single eventType (3 ms)
      âœ“ should filter logs by multiple eventTypes (3 ms)
      âœ“ should filter logs by single severity (3 ms)
      âœ“ should filter logs by multiple severities (3 ms)
      âœ“ should filter logs by ipAddress (2 ms)
      âœ“ should filter logs by date range (startDate) (3 ms)
      âœ“ should filter logs by date range (endDate) (4 ms)
      âœ“ should filter logs by date range (startDate and endDate) (4 ms)
      âœ“ should sort logs by timestamp (newest first) (3 ms)
      âœ“ should apply pagination with offset and limit (2 ms)
      âœ“ should apply default pagination (limit 100) (3 ms)
      âœ“ should handle errors gracefully (3 ms)
      âœ“ should combine multiple filters (2 ms)
    getAuditStats
      âœ“ should return stats for hour timeframe (3 ms)
      âœ“ should return stats for day timeframe (default) (3 ms)
      âœ“ should count unique users correctly (2 ms)
      âœ“ should count unique IPs correctly (3 ms)
      âœ“ should count events by severity (2 ms)
      âœ“ should handle week timeframe (3 ms)
      âœ“ should handle month timeframe (2 ms)
      âœ“ should exclude events outside timeframe (10 ms)
      âœ“ should handle errors gracefully (4 ms)
      âœ“ should handle empty audit logs (2 ms)
    Edge Cases
      âœ“ should handle multiple events from same user at different IPs (3 ms)
      âœ“ should handle events with empty details (3 ms)
      âœ“ should handle events without userId or email (2 ms)
      âœ“ should generate unique IDs for all events (2 ms)
      âœ“ should handle very large details objects (2 ms)
      âœ“ should handle pagination beyond available logs (2 ms)
      âœ“ should handle concurrent logging of multiple events (2 ms)

PASS @money-wise/backend __tests__/unit/core/health/health.controller.spec.ts
  HealthController
    âœ“ should be defined (4 ms)
    getHealth
      âœ“ should return basic health status (3 ms)
      âœ“ should return consistent timestamp format (4 ms)
      âœ“ should return positive uptime (10 ms)
      âœ“ should return memory usage (4 ms)
    getDetailedHealth
      âœ“ should return detailed health with services status (6 ms)
      âœ“ should include database response time (3 ms)
    getReadiness
      âœ“ should return readiness status (2 ms)
    getLiveness
      âœ“ should return liveness status (1 ms)

PASS @money-wise/backend __tests__/unit/auth/jwt-auth.guard.spec.ts
  JwtAuthGuard
    canActivate
      âœ“ should return true for public routes (6 ms)
      âœ“ should call super.canActivate for protected routes (3 ms)
      âœ“ should handle undefined public key (3 ms)
      âœ“ should properly check method and class decorators (3 ms)
    handleRequest
      âœ“ should return user when no error and user exists (2 ms)
      âœ“ should throw UnauthorizedException when error exists (7 ms)
      âœ“ should throw UnauthorizedException when user is null (3 ms)
      âœ“ should throw UnauthorizedException when user is undefined (3 ms)
      âœ“ should throw custom UnauthorizedException with proper message (2 ms)
      âœ“ should prioritize original error over missing user (9 ms)
      âœ“ should handle falsy user values (4 ms)
      âœ“ should handle truthy user values (4 ms)
    integration scenarios
      âœ“ should handle public route with missing user gracefully (3 ms)
      âœ“ should handle protected route with valid token (2 ms)

PASS @money-wise/backend __tests__/unit/auth/services/password-strength.service.spec.ts
  PasswordStrengthService
    calculateStrength
      âœ“ should return very weak for simple passwords (10 ms)
      âœ“ should return strong for complex passwords (3 ms)
      âœ“ should detect common passwords (3 ms)
      âœ“ should detect personal information in password (4 ms)
      âœ“ should detect repeating characters (4 ms)
      âœ“ should detect sequential characters (2 ms)
    validatePolicy
      âœ“ should validate minimum length requirement (2 ms)
      âœ“ should validate character requirements (2 ms)
      âœ“ should pass for valid passwords (2 ms)

PASS @money-wise/backend __tests__/unit/docs/openapi.spec.ts
  OpenAPI Specification
    âœ“ should generate valid OpenAPI spec (2 ms)

PASS @money-wise/backend __tests__/unit/common/decorators/sentry-transaction.decorator.spec.ts
  SentryTransactionDecorator
    withSentryTransaction
      âœ“ should wrap function with Sentry transaction (1 ms)
      âœ“ should handle errors in wrapped function (3 ms)
    SentryTransactionManager
      âœ“ should manage transaction lifecycle (1 ms)

FAIL @money-wise/backend __tests__/unit/auth/services/rate-limit.service.spec.ts
  â— Test suite failed to run

    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m59[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m59[0m         await mockRedis.hset(key, {
    [7m  [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m78[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m78[0m         await mockRedis.hset(key, {
    [7m  [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m100[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m100[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m123[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m123[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m149[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m149[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m195[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m195[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m245[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m245[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m263[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m263[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m287[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m287[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m323[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m323[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m350[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m350[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m382[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m382[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m401[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m401[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m432[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m432[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m454[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m454[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m484[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m484[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m579[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m579[0m       await mockRedis.hset(key1, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m648[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m648[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m666[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m666[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m700[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m700[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m720[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m720[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m

FAIL @money-wise/backend __tests__/unit/accounts/accounts.service.spec.ts
  AccountsService
    create
      âœ“ should create a new account with provided data (5 ms)
      âœ“ should default currency to USD when not provided (2 ms)
      âœ“ should default syncEnabled to true when not provided (2 ms)
      âœ“ should set syncEnabled from DTO when provided (3 ms)
      âœ“ should set isActive to true on creation (3 ms)
      âœ“ should associate account with correct userId (3 ms)
    findAll
      âœ“ should return all accounts for a user (4 ms)
      âœ“ should return empty array when user has no accounts (3 ms)
      âœ“ should order accounts by creation date descending (2 ms)
    findOne
      âœ“ should return account when user owns it (11 ms)
      âœ“ should allow admin to access any account (2 ms)
      âœ“ should throw ForbiddenException when non-owner non-admin tries to access (17 ms)
      âœ“ should throw NotFoundException when account does not exist (3 ms)
      âœ“ should include transactions relation (2 ms)
    update
      âœ“ should allow user to update their own account (4 ms)
      âœ“ should allow admin to update any account (2 ms)
      âœ“ should throw ForbiddenException when non-owner non-admin tries to update (3 ms)
      âœ“ should throw NotFoundException when account does not exist (3 ms)
      âœ“ should update multiple fields at once (2 ms)
    remove
      âœ“ should allow user to delete their own account (3 ms)
      âœ“ should allow admin to delete any account (2 ms)
      âœ“ should throw ForbiddenException when non-owner non-admin tries to delete (2 ms)
      âœ“ should throw NotFoundException when account does not exist (10 ms)
      âœ“ should not call remove when authorization fails (3 ms)
    getBalance
      âœ“ should return balance for account owner (3 ms)
      âœ“ should allow admin to get any account balance (2 ms)
      âœ“ should throw ForbiddenException when non-owner non-admin tries to access (3 ms)
      âœ“ should throw NotFoundException when account does not exist (2 ms)
      âœ“ should return null for availableBalance when not set (2 ms)
    getSummary
      âœ• should calculate summary for user accounts (3 ms)
      âœ• should group accounts by type (5 ms)
      âœ• should count accounts needing sync (2 ms)
      âœ“ should only include active accounts (3 ms)
      âœ“ should return zero summary when user has no accounts (3 ms)
      âœ“ should handle negative balances in credit accounts (2 ms)
    syncAccount
      âœ“ should sync Plaid account for owner (2 ms)
      âœ“ should allow admin to sync any Plaid account (12 ms)
      âœ“ should throw ForbiddenException when non-owner tries to sync (3 ms)
      âœ“ should throw NotFoundException when account does not exist (3 ms)
      âœ“ should throw ForbiddenException when trying to sync non-Plaid account (2 ms)
      âœ“ should clear sync error on successful sync (3 ms)
    toResponseDto (private method - tested through public methods)
      âœ“ should map account to response DTO correctly (2 ms)
      âœ“ should exclude sensitive fields like plaidAccessToken (1 ms)
    edge cases and error handling
      âœ“ should handle repository errors gracefully (3 ms)
      âœ“ should handle save errors during create (3 ms)
      âœ“ should handle concurrent update scenarios (2 ms)
      âœ“ should handle invalid account ID format (3 ms)
      âœ“ should handle accounts with null optional fields (2 ms)

  â— AccountsService â€º getSummary â€º should calculate summary for user accounts

    expect(received).toBe(expected) // Object.is equality

    Expected: 5500
    Received: 9500

      505 |       });
      506 |       expect(result.totalAccounts).toBe(3);
    > 507 |       expect(result.totalBalance).toBe(5500); // 1000 + 5000 - 500
          |                                   ^
      508 |       expect(result.activeAccounts).toBe(3);
      509 |     });
      510 |

      at Object.<anonymous> (__tests__/unit/accounts/accounts.service.spec.ts:507:35)

  â— AccountsService â€º getSummary â€º should group accounts by type

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

      Object {
        "count": 1,
    -   "totalBalance": 1000,
    +   "totalBalance": 5000,
      }

      519 |       const result = await service.getSummary(userId);
      520 |
    > 521 |       expect(result.byType[AccountType.CHECKING]).toEqual({
          |                                                   ^
      522 |         count: 1,
      523 |         totalBalance: 1000,
      524 |       });

      at Object.<anonymous> (__tests__/unit/accounts/accounts.service.spec.ts:521:51)

  â— AccountsService â€º getSummary â€º should count accounts needing sync

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      539 |       const result = await service.getSummary(userId);
      540 |
    > 541 |       expect(result.accountsNeedingSync).toBe(2);
          |                                          ^
      542 |     });
      543 |
      544 |     it('should only include active accounts', async () => {

      at Object.<anonymous> (__tests__/unit/accounts/accounts.service.spec.ts:541:42)

Summary of all failing tests
FAIL __tests__/unit/auth/services/account-lockout.service.spec.ts (7.707 s)
  â— AccountLockoutService â€º recordFailedAttempt â€º should record first failed attempt

    expect(received).toBe(expected) // Object.is equality

    Expected: "1"
    Received: 1

      104 |       const key = `lockout:${identifier}`;
      105 |       const data = await mockRedis.hmget(key, 'failedAttempts', 'firstFailedAt');
    > 106 |       expect(data[0]).toBe('1');
          |                       ^
      107 |       expect(data[1]).toBeDefined();
      108 |     });
      109 |

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:106:23)

  â— AccountLockoutService â€º recordFailedAttempt â€º should increment failed attempts on subsequent failures

    expect(received).toBe(expected) // Object.is equality

    Expected: "3"
    Received: 3

      127 |       // Verify count was incremented
      128 |       const data = await mockRedis.hmget(key, 'failedAttempts');
    > 129 |       expect(data[0]).toBe('3');
          |                       ^
      130 |     });
      131 |
      132 |     it('should lock account after max failed attempts', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:129:23)

  â— AccountLockoutService â€º recordFailedAttempt â€º should apply progressive lockout duration

    expect(received).toBeLessThanOrEqual(expected)

    Expected: <= 1759498448020
    Received:    1759502047019

      174 |       const expectedLockout = Date.now() + (60 * 60 * 1000);
      175 |       expect(result.lockedUntil!.getTime()).toBeGreaterThanOrEqual(expectedLockout - 1000);
    > 176 |       expect(result.lockedUntil!.getTime()).toBeLessThanOrEqual(expectedLockout + 1000);
          |                                             ^
      177 |     });
      178 |
      179 |     it('should cap progressive lockout at 24 hours', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:176:45)

  â— AccountLockoutService â€º recordFailedAttempt â€º should reset failed attempts after reset time

    expect(received).toBe(expected) // Object.is equality

    Expected: "1"
    Received: 1

      218 |       // Verify new firstFailedAt was set
      219 |       const data = await mockRedis.hmget(key, 'failedAttempts', 'firstFailedAt');
    > 220 |       expect(data[0]).toBe('1');
          |                       ^
      221 |       expect(parseInt(data[1]!)).toBeGreaterThan(oldFirstFailedAt);
      222 |     });
      223 |

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:220:23)

  â— AccountLockoutService â€º recordFailedAttempt â€º should reset failed attempts to 0 after lockout

    expect(received).toBe(expected) // Object.is equality

    Expected: "0"
    Received: null

      257 |       // Verify failedAttempts was reset to 0 (not incremented further)
      258 |       const data = await mockRedis.hmget(key, 'failedAttempts');
    > 259 |       expect(data[0]).toBe('0');
          |                       ^
      260 |     });
      261 |
      262 |     it('should increment lockout count on each lockout', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:259:23)

  â— AccountLockoutService â€º recordFailedAttempt â€º should increment lockout count on each lockout

    expect(received).toBe(expected) // Object.is equality

    Expected: "1"
    Received: 1

      274 |
      275 |       const data = await mockRedis.hmget(key, 'lockoutCount');
    > 276 |       expect(data[0]).toBe('1');
          |                       ^
      277 |     });
      278 |
      279 |     it('should update user status to SUSPENDED when locked by email', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:276:23)

  â— AccountLockoutService â€º Progressive Lockout Calculation â€º should calculate progressive lockout durations correctly

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1759498446150
    Received:    1759496647150

      698 |
      699 |         expect(result.isLocked).toBe(true);
    > 700 |         expect(result.lockedUntil!.getTime()).toBeGreaterThanOrEqual(expectedLockout - 1000);
          |                                               ^
      701 |         expect(result.lockedUntil!.getTime()).toBeLessThanOrEqual(expectedLockout + 1000);
      702 |       }
      703 |     });

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:700:47)

  â— AccountLockoutService â€º Edge Cases and Boundary Conditions â€º should handle time boundary conditions for reset

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      856 |
      857 |       // Should be treated as expired and reset
    > 858 |       expect(result.isLocked).toBe(false);
          |                               ^
      859 |       expect(result.failedAttempts).toBe(1);
      860 |     });
      861 |

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:858:31)

  â— AccountLockoutService â€º Edge Cases and Boundary Conditions â€º should handle malformed Redis data gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: NaN

      875 |
      876 |       expect(result.isLocked).toBe(false);
    > 877 |       expect(result.failedAttempts).toBe(1);
          |                                     ^
      878 |     });
      879 |
      880 |     it('should handle Redis connection errors with safe defaults', async () => {

      at Object.<anonymous> (__tests__/unit/auth/services/account-lockout.service.spec.ts:877:37)

FAIL __tests__/unit/users/users.service.spec.ts
  â— UsersService â€º update â€º should throw ConflictException when email already in use

    expect(received).rejects.toThrow(expected)

    Expected message: "Email already in use"
    Received message: "Cannot read properties of undefined (reading 'id')"

          123 |   private toResponseDto(user: User): UserResponseDto {
          124 |     return {
        > 125 |       id: user.id,
              |                ^
          126 |       email: user.email,
          127 |       firstName: user.firstName,
          128 |       lastName: user.lastName,

      at UsersService.toResponseDto (src/users/users.service.ts:125:16)
      at UsersService.update (src/users/users.service.ts:76:17)
      at Object.<anonymous> (__tests__/unit/users/users.service.spec.ts:309:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (__tests__/unit/users/users.service.spec.ts:316:17)

  â— UsersService â€º toResponseDto (private method - tested through public methods) â€º should include computed properties

    expect(received).toBe(expected) // Object.is equality

    Expected: "Test User"
    Received: "New Name"

      582 |       const result = await service.findOne(mockUser.id);
      583 |
    > 584 |       expect(result.fullName).toBe('Test User');
          |                               ^
      585 |       expect(result.isEmailVerified).toBe(true);
      586 |       expect(result.isActive).toBe(true);
      587 |     });

      at Object.<anonymous> (__tests__/unit/users/users.service.spec.ts:584:31)

FAIL __tests__/unit/auth/services/rate-limit.service.spec.ts
  â— Test suite failed to run

    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m59[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m59[0m         await mockRedis.hset(key, {
    [7m  [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m78[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m78[0m         await mockRedis.hset(key, {
    [7m  [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m100[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m100[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m123[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m123[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m149[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m149[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m195[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m195[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m245[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m245[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m263[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m263[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m287[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m287[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m323[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m323[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m350[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m350[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m382[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m382[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m401[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m401[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m432[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m432[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m454[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m454[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m484[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m484[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m579[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m579[0m       await mockRedis.hset(key1, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m648[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m648[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m666[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m666[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m700[0m:[93m23[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m700[0m       await mockRedis.hset(key, {
    [7m   [0m [91m                      ~~~~[0m
    [96m__tests__/unit/auth/services/rate-limit.service.spec.ts[0m:[93m720[0m:[93m25[0m - [91merror[0m[90m TS2554: [0mExpected 3 arguments, but got 2.

    [7m720[0m         await mockRedis.hset(key, {
    [7m   [0m [91m                        ~~~~[0m

FAIL __tests__/unit/accounts/accounts.service.spec.ts
  â— AccountsService â€º getSummary â€º should calculate summary for user accounts

    expect(received).toBe(expected) // Object.is equality

    Expected: 5500
    Received: 9500

      505 |       });
      506 |       expect(result.totalAccounts).toBe(3);
    > 507 |       expect(result.totalBalance).toBe(5500); // 1000 + 5000 - 500
          |                                   ^
      508 |       expect(result.activeAccounts).toBe(3);
      509 |     });
      510 |

      at Object.<anonymous> (__tests__/unit/accounts/accounts.service.spec.ts:507:35)

  â— AccountsService â€º getSummary â€º should group accounts by type

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

      Object {
        "count": 1,
    -   "totalBalance": 1000,
    +   "totalBalance": 5000,
      }

      519 |       const result = await service.getSummary(userId);
      520 |
    > 521 |       expect(result.byType[AccountType.CHECKING]).toEqual({
          |                                                   ^
      522 |         count: 1,
      523 |         totalBalance: 1000,
      524 |       });

      at Object.<anonymous> (__tests__/unit/accounts/accounts.service.spec.ts:521:51)

  â— AccountsService â€º getSummary â€º should count accounts needing sync

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      539 |       const result = await service.getSummary(userId);
      540 |
    > 541 |       expect(result.accountsNeedingSync).toBe(2);
          |                                          ^
      542 |     });
      543 |
      544 |     it('should only include active accounts', async () => {

      at Object.<anonymous> (__tests__/unit/accounts/accounts.service.spec.ts:541:42)


Test Suites: 4 failed, 26 passed, 30 total
Tests:       14 failed, 913 passed, 927 total
Snapshots:   0 total
Time:        62.275 s
Ran all test suites matching /__tests__\/unit/i.
â€‰ELIFECYCLEâ€‰ Command failed with exit code 1.
