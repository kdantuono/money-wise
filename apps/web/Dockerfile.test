# Multi-stage Dockerfile optimized for testing in CI/CD
FROM node:18.17.0-alpine AS base

# Install dependencies needed for node-gyp and native modules
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    libc6-compat

WORKDIR /app

# Copy package files for dependency resolution
COPY package*.json ./
COPY apps/web/package*.json ./apps/web/
COPY apps/backend/package*.json ./apps/backend/
COPY packages/types/package*.json ./packages/types/

# ================================
# Dependencies stage
# ================================
FROM base AS deps

# Install dependencies with optimizations for CI
RUN npm ci --only=production --frozen-lockfile --prefer-offline

# Install dev dependencies in separate layer for testing
RUN npm ci --frozen-lockfile --prefer-offline

# ================================
# Test stage
# ================================
FROM base AS test

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/apps/web/node_modules ./apps/web/node_modules

# Copy source code
COPY . .

# Set up test environment
ENV NODE_ENV=test
ENV CI=true

# Create test output directories
RUN mkdir -p /app/apps/web/coverage \
             /app/apps/web/test-results \
             /app/apps/web/playwright-report

# Run type checking first
RUN cd apps/web && npm run type-check

# Run linting
RUN cd apps/web && npm run lint

# Run unit tests with coverage
RUN cd apps/web && npm run test:coverage

# Expose test results volume
VOLUME ["/app/apps/web/coverage", "/app/apps/web/test-results"]

# Default command for running tests
CMD ["npm", "run", "test", "--prefix", "apps/web"]

# ================================
# Build stage (for E2E testing)
# ================================
FROM test AS build

# Build the application
RUN cd apps/web && npm run build

# ================================
# E2E Test stage
# ================================
FROM mcr.microsoft.com/playwright:v1.40.0-focal AS e2e

WORKDIR /app

# Copy package files
COPY package*.json ./
COPY apps/web/package*.json ./apps/web/

# Install only necessary dependencies for E2E
RUN npm ci --only=production --frozen-lockfile

# Copy built application and test files
COPY --from=build /app/apps/web/.next ./apps/web/.next
COPY --from=build /app/apps/web/public ./apps/web/public
COPY --from=build /app/apps/web/tests ./apps/web/tests
COPY --from=build /app/apps/web/playwright.config* ./apps/web/

# Install Playwright browsers
RUN cd apps/web && npx playwright install --with-deps

# Set environment for E2E tests
ENV NODE_ENV=test
ENV CI=true

# Create output directories
RUN mkdir -p /app/test-results /app/playwright-report

# Default command for E2E tests
CMD ["npx", "playwright", "test", "--config", "apps/web/playwright.config.ts"]