# CI/CD Optimized Docker Compose Configuration
# Lightweight setup for testing and CI environments
version: '3.8'

services:
  postgres-test:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: test_moneywise
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    ports:
      - "5433:5432"
    volumes:
      # Use tmpfs for faster test database
      - type: tmpfs
        target: /var/lib/postgresql/data
        tmpfs:
          size: 512M
    networks:
      - test_network
    # Resource limits for CI
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  redis-test:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    networks:
      - test_network
    # Resource limits for CI
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    # Use tmpfs for faster test cache
    volumes:
      - type: tmpfs
        target: /data
        tmpfs:
          size: 256M

  backend-test:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile.test
      target: test
    environment:
      - NODE_ENV=test
      - DB_HOST=postgres-test
      - DB_PORT=5432
      - DB_USERNAME=test_user
      - DB_PASSWORD=test_password
      - DB_NAME=test_moneywise
      - REDIS_HOST=redis-test
      - REDIS_PORT=6379
      - JWT_SECRET=test-jwt-secret
    depends_on:
      - postgres-test
      - redis-test
    networks:
      - test_network
    # Resource limits for CI
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  web-test:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.test
      target: test
    environment:
      - NODE_ENV=test
      - NEXT_PUBLIC_API_URL=http://backend-test:3002
    depends_on:
      - backend-test
    networks:
      - test_network
    # Resource limits for CI
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # Utility service for E2E tests
  e2e-runner:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.e2e
    environment:
      - PLAYWRIGHT_BASE_URL=http://web-test:3000
      - NODE_ENV=test
    depends_on:
      - web-test
      - backend-test
    networks:
      - test_network
    volumes:
      - ./apps/web/test-results:/app/test-results
      - ./apps/web/playwright-report:/app/playwright-report
    # Resource limits for CI
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # SonarQube for code quality (optional, can be external)
  sonarqube-scanner:
    image: sonarsource/sonar-scanner-cli:latest
    environment:
      - SONAR_HOST_URL=${SONAR_HOST_URL:-http://sonarqube:9000}
      - SONAR_LOGIN=${SONAR_TOKEN}
    volumes:
      - .:/usr/src
      - ./apps/web/coverage:/usr/src/coverage/web
      - ./apps/backend/coverage:/usr/src/coverage/backend
    networks:
      - test_network
    profiles:
      - quality

networks:
  test_network:
    driver: bridge

# Named volumes for persistent data (if needed)
volumes:
  test_cache:
    driver: local